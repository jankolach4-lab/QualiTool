<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard Pro</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root { 
      --bg:#f5f7fa; --surface:#fff; --text:#111827; --muted:#6b7280; --border:#e5e7eb; 
      --accent:#2563eb; --accent-600:#1d4ed8; --teal:#14b8a6; --success:#10b981; --warning:#f59e0b; 
      --danger:#ef4444; --radius:12px; --shadow:0 10px 30px rgba(0,0,0,.06);
      --gradient:linear-gradient(135deg, var(--accent) 0%, var(--teal) 100%);
    } 
    *{box-sizing:border-box; margin:0; padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Ubuntu,sans-serif; background:var(--bg); color:var(--text); overflow-x:hidden}
    /* ... styles unchanged ... */
  </style>
</head>
<body>
  <!-- content unchanged up to script -->
  <!-- ... -->
  <script>
    const SUPABASE_URL = 'https://whigasnqcvjkilkmbfld.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndoaWdhc25xY3Zqa2lsa21iZmxkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyNDE1OTIsImV4cCI6MjA2OTgxNzU5Mn0.tfUnIP_oWy3N9UM6Ws9mPiKqsGtj8_kIOMW42E298rc';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: false } });

    // Helper selectors
    const q = (sel) => document.querySelector(sel);

    // ... variables and functions remain the same until selectUser and refresh calls ...

    async function selectUser(userId, name){
      currentUserId = userId;
      const range = Number(q('#range').value||30);

      ['cardUserCompl', 'cardUserChanges', 'cardUserStatus', 'cardWeeklyHeatmap', 'cardMonthlyTrend'].forEach(id => {
        q('#'+id).style.display='block';
      });

      const selU = q('#selUser');
      selU.style.display='inline-block';
      selU.textContent = name || 'â€“';

      ['cardUserCompl', 'cardUserChanges', 'cardUserStatus', 'cardUserHourly', 'cardUserSummary'].forEach(id => {
        q('#'+id).classList.add('loading');
      });

      try {
        const dateStr = q('#userHourlyDate').value || new Date().toISOString().slice(0,10);

        const [userCompl, userChanges, userStatus, userHourly, userSummary] = await Promise.all([
          supabase.rpc('fn_dashboard_guarded_user_daily_completions_project', { p_user_id: userId, p_project: currentProject, p_days: range }),
          supabase.rpc('fn_dashboard_guarded_user_daily_changes_project', { p_user_id: userId, p_project: currentProject, p_days: range }),
          supabase.rpc('fn_dashboard_guarded_user_status_table', { p_user_id: userId, p_project: currentProject }),
          supabase.rpc('fn_dashboard_guarded_user_hourly_changes_project', { p_user_id: userId, p_project: currentProject, p_date: dateStr }),
          supabase.rpc('fn_dashboard_guarded_user_summary_metrics', { p_user_id: userId, p_project: currentProject })
        ]);

        // ... rendering logic unchanged ...
      } finally {
        ['cardUserCompl', 'cardUserChanges', 'cardUserStatus', 'cardUserHourly', 'cardUserSummary'].forEach(id => {
          q('#'+id).classList.remove('loading');
        });
      }
    }

    async function loadProjects(){
      errBox.style.display='none';
      currentUserId=null;

      // Hide user cards
      ['cardUserCompl', 'cardUserChanges', 'cardUserStatus'].forEach(id => {
        q('#'+id).style.display='none';
      });

      // Show project cards
      ['cardProjCompl', 'cardProjChanges', 'cardProjStatus'].forEach(id => {
        q('#'+id).style.display='block';
      });

      const { data, error } = await supabase.rpc('fn_dashboard_guarded_projects');
      if (error){ 
        showError(error.message); 
        return []; 
      }

      // Filter out projects with zero users just in case
      allProjects = (data || []).filter(p => (p.user_count || 0) > 0);

      // ... rest rendering unchanged ...
    }

  </script>
</body>
</html>