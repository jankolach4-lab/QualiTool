<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    :root { --bg:#f5f7fa; --surface:#fff; --text:#111827; --muted:#6b7280; --border:#e5e7eb; --accent:#2563eb; --accent-600:#1d4ed8; --teal:#14b8a6; --radius:12px; --shadow:0 10px 30px rgba(0,0,0,.06);} *{box-sizing:border-box}
    body{margin:0; font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Ubuntu,sans-serif; background:var(--bg); color:var(--text)}
    header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:var(--surface);box-shadow:var(--shadow);position:sticky;top:0;z-index:10}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}
    .brand img{height:28px;width:28px;border-radius:6px}
    .controls{display:flex;gap:10px;align-items:center}
    select,button{padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:#fff}
    button{background:var(--accent);color:#fff;border:none;box-shadow:0 2px 8px rgba(37,99,235,.2);cursor:pointer}
    button:hover{background:var(--accent-600)}
    main{padding:16px;display:grid;grid-template-columns:320px 1fr;gap:16px}
    .panel{background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px}
    .panel h3{margin:6px 0 10px 0}
    .list{max-height:60vh;overflow:auto;border:1px solid var(--border);border-radius:8px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{font-size:13px;padding:10px 12px;border-bottom:1px solid var(--border)}
    th{position:sticky;top:0;background:#fafafa;text-align:left}
    tr:hover td{background:#fcfdff}
    .grid{display:grid;grid-template-columns: repeat(auto-fill,minmax(360px,1fr));gap:16px}
    .card{background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    canvas{max-height:300px}
    .error{color:#b91c1c;background:#fee2e2;border:1px solid #fecaca;padding:8px 10px;border-radius:10px;margin:10px 0;display:none}
    .muted{color:var(--muted);font-size:12px}
    .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:8px}
    .kpi{display:flex;gap:8px;align-items:baseline}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:600}
    .pill-accent{background:rgba(37,99,235,.12); color:#1d4ed8}
    .pill-teal{background:rgba(20,184,166,.12); color:#0d9488}
    .status-split{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:center}
    @media (max-width: 900px){ .status-split{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header>
    <div class="brand"><img src="../qualitool/qt-logo.png" alt="logo"/> <span>Admin Dashboard</span></div>
    <div class="controls">
      <select id="range"><option value="7">7 Tage</option><option value="30" selected>30 Tage</option><option value="90">90 Tage</option></select>
      <button id="btnRefresh">Aktualisieren</button>
      <button id="btnLogout" style="background:#111827">Logout</button>
    </div>
  </header>
  <main>
    <section class="panel">
      <h3>Projekte</h3>
      <div class="list">
        <table id="tblProjects"><thead><tr><th>Projekt (Stadt)</th><th>WE gesamt</th><th>Mitarbeiter</th></tr></thead><tbody></tbody></table>
      </div>
      <h3 style="margin-top:12px">Mitarbeiter im Projekt: <span id="selProject" class="pill pill-accent">–</span></h3>
      <div class="list">
        <table id="tblUsers"><thead><tr><th>Mitarbeiter</th><th>WE</th></tr></thead><tbody></tbody></table>
      </div>
      <div id="err" class="error"></div>
    </section>
    <section class="panel">
      <div class="grid" id="chartsGrid">
        <div class="card" id="cardProjCompl"><h4>Abschlüsse pro Tag (Projekt)</h4><canvas id="chartProjCompl"></canvas></div>
        <div class="card" id="cardProjChanges"><h4>Statusänderungen pro Tag (Projekt)</h4><canvas id="chartProjChanges"></canvas></div>
        <div class="card" id="cardProjStatus"><h4>Status‑Breakdown (Projekt)</h4><canvas id="chartProjStatus"></canvas></div>
        <div class="card" id="cardProjStatusTable"><h4>Status‑Breakdown (Projekt) – Tabelle</h4><div class="table-wrap"><table id="tblProjStatus"><thead><tr><th>Status</th><th>Absolut</th><th>% von WE Projekt</th></tr></thead><tbody></tbody></table></div></div>
        <div class="card" id="cardUserCompl" style="display:none"><h4>Abschlüsse pro Tag (Mitarbeiter)</h4><canvas id="chartUserCompl"></canvas></div>
        <div class="card" id="cardUserChanges" style="display:none"><h4>Statusänderungen pro Tag (Mitarbeiter)</h4><canvas id="chartUserChanges"></canvas></div>
        <div class="card" id="cardUserStatus"><h4>Status‑Breakdown (Mitarbeiter) <span id="selUser" class="pill pill-teal" style="display:none"></span></h4><canvas id="chartUserStatus"></canvas></div>
        <div class="card" id="cardUserStatusTable"><h4>Status‑Breakdown (Mitarbeiter) – Tabelle</h4><div class="table-wrap"><table id="tblUserStatus"><thead><tr><th>Status</th><th>Absolut</th><th>% von WE Projekt</th></tr></thead><tbody></tbody></table></div></div>
        <div class="card" id="cardUserHourly"><h4>Statusänderungen pro Stunde (Mitarbeiter) <input type="date" id="userHourlyDate" style="margin-left:8px"></h4><canvas id="chartUserHourly"></canvas></div>
        <div class="card" id="cardUserSummary"><h4>Zusammenfassung (Mitarbeiter)</h4><div class="table-wrap"><table id="tblUserSummary"><thead><tr><th>Kennzahl</th><th>Wert</th></tr></thead><tbody><tr><td class="muted" colspan="2">Bitte Mitarbeiter wählen …</td></tr></tbody></table></div></div>
      </div>
    </section>
  </main>

  <script>
    const SUPABASE_URL = 'https://whigasnqcvjkilkmbfld.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndoaWdhc25xY3Zqa2lsa21iZmxkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyNDE1OTIsImV4cCI6MjA2OTgxNzU5Mn0.tfUnIP_oWy3N9UM6Ws9mPiKqsGtj8_kIOMW42E298rc';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: false } });

    const q = sel => document.querySelector(sel);
    const errBox = q('#err');
    let chProjCompl, chProjChanges, chProjStatus; let chUserCompl, chUserChanges, chUserStatus;
    let currentUserId = null; let currentProject = null; let projectTotalWE = 0;

    async function requireAuth(){ const { data:{ session } } = await supabase.auth.getSession(); if (!session) { window.location.href='./login.html'; throw new Error('no_session'); } return session.user; }

    function daysAgoISO(n){ const d=new Date(); d.setDate(d.getDate()-n); d.setHours(0,0,0,0); return d.toISOString(); }

    function showError(msg){ errBox.textContent = 'Fehler: ' + msg; errBox.style.display='block'; }

    function renderBar(ctxId, labels, vals, label, color){
      const ctx = document.getElementById(ctxId);
      const instName = 'ch' + ctxId.charAt(0).toUpperCase() + ctxId.slice(1);
      try{ if (window[instName]) window[instName].destroy(); }catch{}
      const inst = new Chart(ctx, { type:'bar', data:{ labels, datasets:[{ label, data: vals, backgroundColor: color }] }, options:{ scales:{ y:{ beginAtZero:true } }, plugins:{ legend:{ display:false } } }});
      window[instName] = inst; return inst;
    }

    function renderDoughnut(ctxId, labels, vals){
      const ctx = document.getElementById(ctxId);
      const instName = 'ch' + ctxId.charAt(0).toUpperCase() + ctxId.slice(1);
      try{ if (window[instName]) window[instName].destroy(); }catch{}
      const inst = new Chart(ctx, { type:'doughnut', data:{ labels, datasets:[{ data: vals, backgroundColor: labels.map((_,i)=> `hsl(${(i*37)%360} 80% 60%)`) }] }, options:{ plugins:{ legend:{ position:'bottom' } } } });
      window[instName] = inst; return inst;
    }

    function renderStatusTable(tblId, rows){
      const tbody = document.querySelector('#'+tblId+' tbody');
      tbody.innerHTML='';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.status||'–'}</td><td>${r.absolute||0}</td><td>${(r.percent||0).toFixed(1)}%</td>`;
        tbody.appendChild(tr);
      });
    }

    async function loadProjects(){
      errBox.style.display='none'; currentUserId=null; // reset user selection
      q('#cardUserCompl').style.display='none'; q('#cardUserChanges').style.display='none'; q('#cardUserStatus').style.display='none';
      q('#cardProjCompl').style.display='block'; q('#cardProjChanges').style.display='block'; q('#cardProjStatus').style.display='block';
      const { data, error } = await supabase.rpc('fn_dashboard_guarded_projects');
      if (error){ showError(error.message); return []; }
      const tbody = q('#tblProjects tbody'); tbody.innerHTML='';
      (data||[]).forEach(row=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${row.project||'–'}</td><td>${row.total_we||0}</td><td>${row.user_count||0}</td>`;
        tr.addEventListener('click', ()=> selectProject(row.project, Number(row.total_we||0)));
        tbody.appendChild(tr);
      });
      return data||[];
    }

    async function selectProject(project, totalWE){
      currentProject = project; projectTotalWE = totalWE||0; q('#selProject').textContent = project || '–';
      // load users table
      const { data, error } = await supabase.rpc('fn_dashboard_guarded_project_users', { p_project: project });
      if (error){ showError(error.message); return; }
      const tbody = q('#tblUsers tbody'); tbody.innerHTML='';
      (data||[]).forEach(u=>{
        const tr=document.createElement('tr'); const name = u.display_name || u.email || u.user_id;
        tr.innerHTML = `<td>${name}</td><td>${u.we_count||0}</td>`;
        tr.addEventListener('click', ()=> selectUser(u.user_id, name));
        tbody.appendChild(tr);
      });
      // visuelle Hervorhebung des Projekts
      q('#selProject').textContent = project || '–';
      q('#selProject').classList.add('pill-accent');
      // load project charts
      await refreshProjectCharts();
    }

    async function refreshProjectCharts(){
      const range = Number(q('#range').value||30);
      // RPCs to be created in SQL: project daily completions/changes + project status table
      const [c1, c2, st] = await Promise.all([
        supabase.rpc('fn_dashboard_guarded_project_daily_completions', { p_project: currentProject, p_days: range }),
        supabase.rpc('fn_dashboard_guarded_project_daily_changes', { p_project: currentProject, p_days: range }),
        supabase.rpc('fn_dashboard_guarded_project_status_table', { p_project: currentProject })
      ]);
      if (c1.error) showError(c1.error.message); else {
        const labels = (c1.data||[]).map(r=> new Date(r.day).toLocaleDateString('de-DE'));
        const vals = (c1.data||[]).map(r=> Number(r.completions||0));
        chProjCompl = renderBar('chartProjCompl', labels, vals, 'Abschlüsse', '#2563eb');
      }
      if (c2.error) showError(c2.error.message); else {
        const labels = (c2.data||[]).map(r=> new Date(r.day).toLocaleDateString('de-DE'));
        const vals = (c2.data||[]).map(r=> Number(r.changes||0));
        chProjChanges = renderBar('chartProjChanges', labels, vals, 'Änderungen', '#14b8a6');
      }
      if (st.error) showError(st.error.message); else {
        const entries = Object.entries(st.data?.breakdown||{}).sort((a,b)=> b[1]-a[1]);
        const labels = entries.map(([k])=>k); const vals = entries.map(([,v])=>v);
        chProjStatus = renderDoughnut('chartProjStatus', labels, vals);
        renderStatusTable('tblProjStatus', (st.data?.table||[]).map(r=> ({ status:r.status, absolute:Number(r.absolute||0), percent: Number(r.percent||0) })) );
        // ensure both cards are visible
        q('#cardProjStatus').style.display='block';
        q('#cardProjStatusTable').style.display='block';
      }
    }

    async function selectUser(userId, name){
      currentUserId = userId; const range = Number(q('#range').value||30);
      // toggle user cards
      q('#cardUserCompl').style.display='block'; q('#cardUserChanges').style.display='block'; q('#cardUserStatus').style.display='block';
      // user badge
      const selU = q('#selUser'); selU.style.display='inline-block'; selU.textContent = name || '–';
      // fetch user charts
      const dateStr = (q('#userHourlyDate').value || new Date().toISOString().slice(0,10));
      const [uc, ud, ust, uh, us] = await Promise.all([
        supabase.rpc('fn_dashboard_guarded_user_daily_completions', { p_user_id: userId, p_days: range }),
        supabase.rpc('fn_dashboard_guarded_user_daily_changes', { p_user_id: userId, p_days: range }),
        supabase.rpc('fn_dashboard_guarded_user_status_table', { p_user_id: userId, p_project: currentProject }),
        supabase.rpc('fn_dashboard_guarded_user_hourly_changes', { p_user_id: userId, p_date: dateStr }),
        supabase.rpc('fn_dashboard_guarded_user_summary_metrics', { p_user_id: userId, p_project: currentProject })
      ]);
      if (uc.error) showError(uc.error.message); else {
        const labels = (uc.data||[]).map(r=> new Date(r.day).toLocaleDateString('de-DE'));
        const vals = (uc.data||[]).map(r=> Number(r.completions||0));
        chUserCompl = renderBar('chartUserCompl', labels, vals, 'Abschlüsse', '#2563eb');
      }
      if (ud.error) showError(ud.error.message); else {
        const labels = (ud.data||[]).map(r=> new Date(r.day).toLocaleDateString('de-DE'));
        const vals = (ud.data||[]).map(r=> Number(r.changes||0));
        chUserChanges = renderBar('chartUserChanges', labels, vals, 'Änderungen', '#14b8a6');
      }
      if (ust.error) showError(ust.error.message); else {
        const entries = Object.entries(ust.data?.breakdown||{}).sort((a,b)=> b[1]-a[1]);
        const labels = entries.map(([k])=>k); const vals = entries.map(([,v])=>v);
        chUserStatus = renderDoughnut('chartUserStatus', labels, vals);
        renderStatusTable('tblUserStatus', (ust.data?.table||[]).map(r=> ({ status:r.status, absolute:Number(r.absolute||0), percent: Number(r.percent||0) })) );
        q('#cardUserStatus').style.display='block';
        q('#cardUserStatusTable').style.display='block';
      }
      if (uh.error) showError(uh.error.message); else {
        const hours = Array.from({length:24}, (_,i)=>i);
        const map = new Map((uh.data||[]).map(r=> [Number(r.hour), Number(r.changes)]));
        const vals = hours.map(h=> map.get(h)||0);
        renderBar('chartUserHourly', hours.map(h=> String(h).padStart(2,'0')+':00'), vals, 'Änderungen', '#f59e0b');
      }
      if (us.error) showError(us.error.message); else {
        const t = q('#tblUserSummary tbody');
        const d = us.data || {};
        t.innerHTML = ''+
          `<tr><td>Gesamt Statusänderungen</td><td>${d.total_changes??0}</td></tr>`+
          `<tr><td>Abschlüsse (nicht Online)</td><td>${d.completions??0}</td></tr>`+
          `<tr><td>Ø Änderungen bis Abschluss</td><td>${(d.avg_changes_per_completion??0)}</td></tr>`+
          `<tr><td>WE mit Status</td><td>${d.we_with_status??0} (${d.we_with_status_percent??0}%)</td></tr>`+
          `<tr><td>WE gesamt (Mitarbeiter, Projekt)</td><td>${d.we_total??0}</td></tr>`;
      }
    }

    document.getElementById('btnRefresh').addEventListener('click', async ()=>{
      if (currentProject) await refreshProjectCharts();
      if (currentUserId) await selectUser(currentUserId);
    });
    document.getElementById('btnLogout').addEventListener('click', async ()=>{ await supabase.auth.signOut(); window.location.href='./login.html'; });

    (async ()=>{ await requireAuth(); await loadProjects(); })();
  </script>
</body>
</html>