<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard Pro</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root { 
      --bg:#f5f7fa; --surface:#fff; --text:#111827; --muted:#6b7280; --border:#e5e7eb; 
      --accent:#2563eb; --accent-600:#1d4ed8; --teal:#14b8a6; --success:#10b981; --warning:#f59e0b; 
      --danger:#ef4444; --radius:12px; --shadow:0 10px 30px rgba(0,0,0,.06);
      --gradient:linear-gradient(135deg, var(--accent) 0%, var(--teal) 100%);
    } 
    *{box-sizing:border-box; margin:0; padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Ubuntu,sans-serif; background:var(--bg); color:var(--text); overflow-x:hidden}
    
    /* Header & Navigation */
    header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:var(--surface);box-shadow:var(--shadow);position:sticky;top:0;z-index:100}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;background:var(--gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .brand img{height:32px;width:32px;border-radius:8px}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    
    /* Enhanced Controls */
    .control-group{display:flex;gap:8px;align-items:center;background:var(--surface);padding:6px;border-radius:10px;border:1px solid var(--border)}
    select,input,button{padding:8px 12px;border:1px solid var(--border);border-radius:8px;background:#fff;font-size:13px;transition:all 0.2s}
    select:focus,input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
    button{background:var(--accent);color:#fff;border:none;box-shadow:0 4px 12px rgba(37,99,235,.25);cursor:pointer;font-weight:600}
    button:hover{background:var(--accent-600);transform:translateY(-1px)}
    button.secondary{background:var(--muted);color:white}
    button.danger{background:var(--danger)}
    
    /* Live Status */
    .live-status{display:flex;align-items:center;gap:6px;padding:4px 8px;background:rgba(16,185,129,.1);color:var(--success);border-radius:6px;font-size:12px;font-weight:600}
    .live-dot{width:8px;height:8px;background:var(--success);border-radius:50%;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1} 50%{opacity:0.5}}
    
    /* Responsive Layout */
    main{padding:16px;display:grid;grid-template-columns:minmax(300px,380px) 1fr;gap:16px;max-width:1600px;margin:0 auto}
    @media (max-width: 1200px){main{grid-template-columns:1fr;gap:12px}}
    @media (max-width: 768px){
      .controls{flex-direction:column;gap:8px}
      .control-group{flex-wrap:wrap}
      main{padding:12px}
    }
    
    /* Panels & Cards */
    .panel{background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;transition:transform 0.2s}
    .panel:hover{transform:translateY(-2px)}
    .panel h3{margin:0 0 12px 0;color:var(--text);font-size:16px}
    .list{max-height:70vh;overflow:auto;border:1px solid var(--border);border-radius:8px}
    
    /* Enhanced Tables */
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{font-size:13px;padding:12px 14px;border-bottom:1px solid var(--border)}
    th{position:sticky;top:0;background:linear-gradient(180deg,#fafafa 0%,#f3f4f6 100%);text-align:left;font-weight:700;color:var(--text)}
    tr:hover td{background:#f8fafc;cursor:pointer}
    tr.selected td{background:rgba(37,99,235,.05);border-left:3px solid var(--accent)}
    
    /* Grid & Cards */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(400px,1fr));gap:16px}
    @media (max-width: 768px){.grid{grid-template-columns:1fr}}
    .card{background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;position:relative;transition:all 0.2s}
    .card:hover{transform:translateY(-2px);box-shadow:0 20px 40px rgba(0,0,0,.1)}
    .card h4{margin:0 0 16px 0;color:var(--text);font-size:15px;display:flex;align-items:center;gap:8px}
    
    /* Chart Enhancements */
    canvas{max-height:320px;border-radius:8px}
    .chart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .chart-actions{display:flex;gap:6px}
    .chart-btn{padding:4px 8px;font-size:11px;border-radius:6px;background:var(--border);color:var(--muted);border:none;cursor:pointer}
    .chart-btn:hover{background:var(--accent);color:white}
    
    /* Export & Filter */
    .export-menu{position:absolute;top:12px;right:12px;z-index:10}
    .export-dropdown{position:relative;display:inline-block}
    .export-content{display:none;position:absolute;right:0;background:white;box-shadow:var(--shadow);border-radius:8px;min-width:160px;z-index:20;border:1px solid var(--border)}
    .export-content a{display:block;padding:10px 16px;text-decoration:none;color:var(--text);font-size:13px;border-bottom:1px solid var(--border)}
    .export-content a:hover{background:var(--bg)}
    .export-content a:last-child{border-bottom:none}
    
    /* Status Indicators */
    .error{color:#b91c1c;background:#fee2e2;border:1px solid #fecaca;padding:12px 16px;border-radius:10px;margin:12px 0;display:none}
    .success{color:#166534;background:#dcfce7;border:1px solid #bbf7d0;padding:12px 16px;border-radius:10px;margin:12px 0}
    .warning{color:#b45309;background:#fef3c7;border:1px solid #fde68a;padding:12px 16px;border-radius:10px;margin:12px 0}
    
    /* Enhanced Pills & KPIs */
    .pill{display:inline-flex;align-items:center;gap:4px;padding:6px 12px;border-radius:999px;font-size:12px;font-weight:600}
    .pill-accent{background:rgba(37,99,235,.12); color:#1d4ed8}
    .pill-teal{background:rgba(20,184,166,.12); color:#0d9488}
    .pill-success{background:rgba(16,185,129,.12); color:#047857}
    .pill-warning{background:rgba(245,158,11,.12); color:#b45309}
    
    /* KPI Cards */
    .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:16px}
    .kpi-card{background:white;padding:16px;border-radius:10px;border-left:4px solid var(--accent);box-shadow:0 2px 8px rgba(0,0,0,.04)}
    .kpi-value{font-size:24px;font-weight:800;color:var(--accent);margin:4px 0}
    .kpi-label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px}
    .kpi-change{font-size:11px;margin-top:4px}
    .kpi-change.positive{color:var(--success)} .kpi-change.negative{color:var(--danger)}
    
    /* Mobile Optimizations */
    @media (max-width: 480px){
      header{flex-direction:column;gap:12px;padding:12px}
      .brand{font-size:18px}
      .controls{width:100%;justify-content:center}
      .panel{padding:12px}
      .card{padding:12px}
      .kpi-grid{grid-template-columns:1fr 1fr}
    }
    
    /* Loading States */
    .loading{opacity:0.6;pointer-events:none;position:relative}
    .loading::after{content:'';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:24px;height:24px;border:2px solid var(--border);border-top:2px solid var(--accent);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:translate(-50%,-50%) rotate(0deg)} 100%{transform:translate(-50%,-50%) rotate(360deg)}}
    
    /* Tooltips */
    .tooltip{position:relative;cursor:help}
    .tooltip:hover::after{content:attr(data-tooltip);position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:#333;color:white;padding:6px 10px;border-radius:6px;font-size:12px;white-space:nowrap;z-index:1000}
    
    /* Dark mode support */
    @media (prefers-color-scheme: dark){
      :root{--bg:#0f172a;--surface:#1e293b;--text:#f1f5f9;--muted:#94a3b8;--border:#334155}
      .live-status{background:rgba(16,185,129,.2)}
    }

    /* PDF Export Modal */
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:1000;display:none;align-items:center;justify-content:center}
    .modal-content{background:var(--surface);border-radius:var(--radius);padding:24px;max-width:500px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .modal-title{font-size:20px;font-weight:700;color:var(--text)}
    .modal-close{background:none;border:none;font-size:24px;cursor:pointer;color:var(--muted);padding:0;width:24px;height:24px}
    .modal-close:hover{color:var(--text)}
    .form-group{margin-bottom:16px}
    .form-label{display:block;margin-bottom:6px;font-weight:600;color:var(--text)}
    .form-select{width:100%;padding:12px;border:1px solid var(--border);border-radius:8px;background:var(--surface);color:var(--text);font-size:14px}
    .form-select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
    .modal-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:24px}
    .btn-modal{padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.2s}
    .btn-cancel{background:var(--muted);color:white;border:none}
    .btn-cancel:hover{background:#6b7280}
    .btn-export{background:var(--accent);color:white;border:none}
    .btn-export:hover{background:var(--accent-600)}
    .btn-export:disabled{background:var(--muted);cursor:not-allowed}

    /* PDF Generation Overlay */
    .pdf-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:2000;display:none;align-items:center;justify-content:center;flex-direction:column}
    .pdf-progress{color:white;text-align:center}
    .pdf-progress h3{margin-bottom:16px;font-size:24px}
    .pdf-progress p{margin-bottom:8px;opacity:0.8}
    .progress-bar{width:300px;height:4px;background:rgba(255,255,255,0.2);border-radius:2px;overflow:hidden}
    .progress-fill{height:100%;background:var(--accent);width:0%;transition:width 0.3s;border-radius:2px}

    /* Hidden PDF Container */
    .pdf-container{position:absolute;top:-10000px;left:-10000px;width:794px;background:white;color:#000;font-family:Arial,sans-serif;z-index:-1000}
    .pdf-page{width:794px;min-height:1123px;padding:40px;box-sizing:border-box;background:white;page-break-after:always}
    .pdf-header{text-align:center;margin-bottom:30px;border-bottom:2px solid #2563eb;padding-bottom:20px}
    .pdf-title{font-size:28px;font-weight:bold;color:#2563eb;margin-bottom:8px}
    .pdf-subtitle{font-size:16px;color:#666;margin-bottom:4px}
    .pdf-date{font-size:14px;color:#888}
    .pdf-section{margin-bottom:30px}
    .pdf-section-title{font-size:18px;font-weight:bold;color:#2563eb;margin-bottom:15px;border-bottom:1px solid #e5e7eb;padding-bottom:5px}
    .pdf-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}
    .pdf-chart{width:100%;height:250px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:15px}
    .pdf-table{width:100%;border-collapse:collapse;margin-bottom:20px}
    .pdf-table th,.pdf-table td{padding:8px 12px;border:1px solid #e5e7eb;text-align:left;font-size:12px}
    .pdf-table th{background:#f8fafc;font-weight:bold}
    .pdf-kpi{display:flex;justify-content:space-between;margin-bottom:15px}
    .pdf-kpi-item{text-align:center;flex:1}
    .pdf-kpi-value{font-size:24px;font-weight:bold;color:#2563eb;margin-bottom:4px}
    .pdf-kpi-label{font-size:12px;color:#666}
    .pdf-footer{text-align:center;color:#888;font-size:12px;margin-top:30px;padding-top:20px;border-top:1px solid #e5e7eb}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img src="../qualitool/qt-logo.png" alt="logo"/> 
      <span>Admin Dashboard Pro</span>
    </div>
    <div class="controls">
      <div class="control-group">
        <i class="fas fa-filter"></i>
        <select id="projectFilter">
          <option value="">Alle Projekte</option>
        </select>
      </div>
      <div class="control-group">
        <i class="fas fa-calendar"></i>
        <input type="date" id="dateFrom" title="Von Datum">
        <input type="date" id="dateTo" title="Bis Datum">
      </div>
      <div class="control-group">
        <i class="fas fa-clock"></i>
        <select id="range">
          <option value="7">7 Tage</option>
          <option value="30" selected>30 Tage</option>
          <option value="90">90 Tage</option>
          <option value="365">1 Jahr</option>
        </select>
      </div>
      <div class="live-status">
        <div class="live-dot"></div>
        <span>Live</span>
      </div>
      <button id="btnRefresh" title="Aktualisieren">
        <i class="fas fa-sync-alt"></i>
      </button>
      <button id="btnExportAll" class="secondary" title="Alles exportieren">
        <i class="fas fa-download"></i>
      </button>
      <button id="btnExportPDF" class="secondary" title="PDF-Report erstellen">
        <i class="fas fa-file-pdf"></i> PDF
      </button>
      <button id="btnLogout" class="danger" title="Abmelden">
        <i class="fas fa-sign-out-alt"></i>
      </button>
    </div>
  </header>
  
  <main>
    <!-- Sidebar Panel -->
    <section class="panel">
      <h3><i class="fas fa-building"></i> Projekte</h3>
      <div class="kpi-grid">
        <div class="kpi-card">
          <div class="kpi-value" id="totalProjects">0</div>
          <div class="kpi-label">Projekte</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-value" id="totalUsers">0</div>
          <div class="kpi-label">Mitarbeiter</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-value" id="totalWE">0</div>
          <div class="kpi-label">WE Gesamt</div>
        </div>
      </div>
      
      <div class="list">
        <table id="tblProjects">
          <thead>
            <tr>
              <th><i class="fas fa-city"></i> Projekt (Stadt)</th>
              <th><i class="fas fa-home"></i> WE</th>
              <th><i class="fas fa-users"></i> MA</th>
              <th><i class="fas fa-chart-line"></i> Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      
      <h3 style="margin-top:16px">
        <i class="fas fa-user"></i> Mitarbeiter: 
        <span id="selProject" class="pill pill-accent">Projekt auswählen</span>
      </h3>
      <div class="list">
        <table id="tblUsers">
          <thead>
            <tr>
              <th><i class="fas fa-user"></i> Mitarbeiter</th>
              <th><i class="fas fa-home"></i> WE</th>
              <th><i class="fas fa-percentage"></i> Quote</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      
      <div id="err" class="error"></div>
      <div id="success" class="success" style="display:none"></div>
    </section>

    <!-- Main Charts Panel -->
    <section class="panel">
      <div class="grid" id="chartsGrid">
        <!-- Project Charts -->
        <div class="card" id="cardProjCompl">
          <div class="chart-header">
            <h4><i class="fas fa-check-circle"></i> Abschlüsse (Projekt)</h4>
            <div class="export-dropdown">
              <button class="chart-btn" onclick="toggleExport('projCompl')">
                <i class="fas fa-download"></i>
              </button>
              <div class="export-content" id="export-projCompl">
                <a href="#" onclick="exportChart('chartProjCompl', 'png')">PNG herunterladen</a>
                <a href="#" onclick="exportChart('chartProjCompl', 'csv')">CSV herunterladen</a>
              </div>
            </div>
          </div>
          <canvas id="chartProjCompl"></canvas>
        </div>
        
        <div class="card" id="cardProjChanges">
          <div class="chart-header">
            <h4><i class="fas fa-exchange-alt"></i> Änderungen (Projekt)</h4>
            <div class="export-dropdown">
              <button class="chart-btn" onclick="toggleExport('projChanges')">
                <i class="fas fa-download"></i>
              </button>
              <div class="export-content" id="export-projChanges">
                <a href="#" onclick="exportChart('chartProjChanges', 'png')">PNG herunterladen</a>
                <a href="#" onclick="exportChart('chartProjChanges', 'csv')">CSV herunterladen</a>
              </div>
            </div>
          </div>
          <canvas id="chartProjChanges"></canvas>
        </div>
        
        <div class="card" id="cardProjStatus">
          <div class="chart-header">
            <h4><i class="fas fa-chart-pie"></i> Status‑Breakdown (Projekt)</h4>
            <div class="export-dropdown">
              <button class="chart-btn" onclick="toggleExport('projStatus')">
                <i class="fas fa-download"></i>
              </button>
              <div class="export-content" id="export-projStatus">
                <a href="#" onclick="exportChart('chartProjStatus', 'png')">PNG herunterladen</a>
                <a href="#" onclick="exportChart('chartProjStatus', 'csv')">CSV herunterladen</a>
              </div>
            </div>
          </div>
          <canvas id="chartProjStatus"></canvas>
        </div>
        
        <div class="card" id="cardProjStatusTable">
          <div class="chart-header">
            <h4><i class="fas fa-table"></i> Status‑Tabelle (Projekt)</h4>
            <div class="export-dropdown">
              <button class="chart-btn" onclick="exportTable('tblProjStatus')">
                <i class="fas fa-download"></i> CSV
              </button>
            </div>
          </div>
          <div class="table-wrap">
            <table id="tblProjStatus">
              <thead>
                <tr>
                  <th>Status</th>
                  <th>Absolut</th>
                  <th>% von WE</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- User Charts -->
        <div class="card" id="cardUserCompl" style="display:none">
          <div class="chart-header">
            <h4><i class="fas fa-user-check"></i> Abschlüsse (Mitarbeiter)</h4>
            <div class="export-dropdown">
              <button class="chart-btn" onclick="toggleExport('userCompl')">
                <i class="fas fa-download"></i>
              </button>
              <div class="export-content" id="export-userCompl">
                <a href="#" onclick="exportChart('chartUserCompl', 'png')">PNG herunterladen</a>
                <a href="#" onclick="exportChart('chartUserCompl', 'csv')">CSV herunterladen</a>
              </div>
            </div>
          </div>
          <canvas id="chartUserCompl"></canvas>
        </div>
        
        <div class="card" id="cardUserChanges" style="display:none">
          <div class="chart-header">
            <h4><i class="fas fa-user-edit"></i> Änderungen (Mitarbeiter)</h4>
            <div class="export-dropdown">
              <button class="chart-btn" onclick="toggleExport('userChanges')">
                <i class="fas fa-download"></i>
              </button>
              <div class="export-content" id="export-userChanges">
                <a href="#" onclick="exportChart('chartUserChanges', 'png')">PNG herunterladen</a>
                <a href="#" onclick="exportChart('chartUserChanges', 'csv')">CSV herunterladen</a>
              </div>
            </div>
          </div>
          <canvas id="chartUserChanges"></canvas>
        </div>
        
        <div class="card" id="cardUserStatus">
          <div class="chart-header">
            <h4>
              <i class="fas fa-chart-donut"></i> Status‑Breakdown 
              <span id="selUser" class="pill pill-teal" style="display:none"></span>
            </h4>
            <div class="export-dropdown">
              <button class="chart-btn" onclick="toggleExport('userStatus')">
                <i class="fas fa-download"></i>
              </button>
              <div class="export-content" id="export-userStatus">
                <a href="#" onclick="exportChart('chartUserStatus', 'png')">PNG herunterladen</a>
                <a href="#" onclick="exportChart('chartUserStatus', 'csv')">CSV herunterladen</a>
              </div>
            </div>
          </div>
          <canvas id="chartUserStatus"></canvas>
        </div>
        
        <div class="card" id="cardUserStatusTable">
          <div class="chart-header">
            <h4><i class="fas fa-table"></i> Status‑Tabelle (Mitarbeiter)</h4>
            <div class="export-dropdown">
              <button class="chart-btn" onclick="exportTable('tblUserStatus')">
                <i class="fas fa-download"></i> CSV
              </button>
            </div>
          </div>
          <div class="table-wrap">
            <table id="tblUserStatus">
              <thead>
                <tr>
                  <th>Status</th>
                  <th>Absolut</th>
                  <th>% von WE</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        
        <div class="card" id="cardUserHourly">
          <div class="chart-header">
            <h4>
              <i class="fas fa-clock"></i> Stündliche Änderungen 
              <input type="date" id="userHourlyDate" style="margin-left:8px;font-size:12px">
            </h4>
            <div class="export-dropdown">
              <button class="chart-btn" onclick="toggleExport('userHourly')">
                <i class="fas fa-download"></i>
              </button>
              <div class="export-content" id="export-userHourly">
                <a href="#" onclick="exportChart('chartUserHourly', 'png')">PNG herunterladen</a>
                <a href="#" onclick="exportChart('chartUserHourly', 'csv')">CSV herunterladen</a>
              </div>
            </div>
          </div>
          <canvas id="chartUserHourly"></canvas>
        </div>
        
        <div class="card" id="cardUserSummary">
          <div class="chart-header">
            <h4><i class="fas fa-chart-bar"></i> Zusammenfassung (Mitarbeiter)</h4>
            <div class="export-dropdown">
              <button class="chart-btn" onclick="exportTable('tblUserSummary')">
                <i class="fas fa-download"></i> CSV
              </button>
            </div>
          </div>
          <div class="table-wrap">
            <table id="tblUserSummary">
              <thead>
                <tr>
                  <th>Kennzahl</th>
                  <th>Wert</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="muted" colspan="2">
                    <i class="fas fa-info-circle"></i> Bitte Mitarbeiter wählen …
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- New Advanced Charts -->
        <div class="card" id="cardWeeklyHeatmap" style="display:none">
          <div class="chart-header">
            <h4><i class="fas fa-calendar-week"></i> Wochentag-Aktivität</h4>
            <div class="export-dropdown">
              <button class="chart-btn" onclick="toggleExport('weeklyHeatmap')">
                <i class="fas fa-download"></i>
              </button>
              <div class="export-content" id="export-weeklyHeatmap">
                <a href="#" onclick="exportChart('chartWeeklyHeatmap', 'png')">PNG herunterladen</a>
                <a href="#" onclick="exportChart('chartWeeklyHeatmap', 'csv')">CSV herunterladen</a>
              </div>
            </div>
          </div>
          <canvas id="chartWeeklyHeatmap"></canvas>
        </div>

        <div class="card" id="cardMonthlyTrend" style="display:none">
          <div class="chart-header">
            <h4><i class="fas fa-chart-line"></i> Monatlicher Trend</h4>
            <div class="export-dropdown">
              <button class="chart-btn" onclick="toggleExport('monthlyTrend')">
                <i class="fas fa-download"></i>
              </button>
              <div class="export-content" id="export-monthlyTrend">
                <a href="#" onclick="exportChart('chartMonthlyTrend', 'png')">PNG herunterladen</a>
                <a href="#" onclick="exportChart('chartMonthlyTrend', 'csv')">CSV herunterladen</a>
              </div>
            </div>
          </div>
          <canvas id="chartMonthlyTrend"></canvas>
        </div>
      </div>
    </section>
  </main>

  <!-- PDF Export Modal -->
  <div class="modal" id="pdfModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">
          <i class="fas fa-file-pdf"></i> PDF-Report erstellen
        </h3>
        <button class="modal-close" onclick="closePDFModal()">&times;</button>
      </div>
      
      <div class="form-group">
        <label class="form-label">Projekt auswählen:</label>
        <select class="form-select" id="pdfProjectSelect">
          <option value="">Bitte Projekt wählen...</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">Zeitraum:</label>
        <select class="form-select" id="pdfTimeRange">
          <option value="7">Letzte 7 Tage</option>
          <option value="30" selected>Letzte 30 Tage</option>
          <option value="90">Letzte 90 Tage</option>
          <option value="365">Letztes Jahr</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">Report-Typ:</label>
        <select class="form-select" id="pdfReportType">
          <option value="full">Vollständiger Report (Projekt + alle Mitarbeiter)</option>
          <option value="project">Nur Projekt-Übersicht</option>
          <option value="summary">Executive Summary</option>
        </select>
      </div>
      
      <div class="modal-actions">
        <button class="btn-modal btn-cancel" onclick="closePDFModal()">
          <i class="fas fa-times"></i> Abbrechen
        </button>
        <button class="btn-modal btn-export" id="btnGeneratePDF" onclick="generatePDFReport()">
          <i class="fas fa-file-pdf"></i> PDF generieren
        </button>
      </div>
    </div>
  </div>

  <!-- PDF Generation Overlay -->
  <div class="pdf-overlay" id="pdfOverlay">
    <div class="pdf-progress">
      <h3><i class="fas fa-file-pdf"></i> PDF wird erstellt...</h3>
      <p id="pdfStatus">Daten werden geladen...</p>
      <div class="progress-bar">
        <div class="progress-fill" id="pdfProgressFill"></div>
      </div>
      <p style="margin-top:16px;opacity:0.6">Bitte warten Sie einen Moment</p>
    </div>
  </div>

  <!-- Hidden PDF Container for Generation -->
  <div class="pdf-container" id="pdfContainer">
    <!-- PDF content will be generated here -->
  </div>

  <script>
    const SUPABASE_URL = 'https://whigasnqcvjkilkmbfld.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndoaWdhc25xY3Zqa2lsa21iZmxkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyNDE1OTIsImV4cCI6MjA2OTgxNzU5Mn0.tfUnIP_oWy3N9UM6Ws9mPiKqsGtj8_kIOMW42E298rc';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { 
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: false } 
    });

    // Global Variables
    const q = sel => document.querySelector(sel);
    const errBox = q('#err');
    const successBox = q('#success');
    let charts = {}; // Store all chart instances
    let currentUserId = null;
    let currentProject = null; 
    let projectTotalWE = 0;
    let autoRefreshInterval = null;
    let allProjects = [];
    let allUsers = [];

    // Utility Functions
    async function requireAuth(){ 
      const { data:{ session } } = await supabase.auth.getSession(); 
      if (!session) { 
        window.location.href='./login.html'; 
        throw new Error('no_session'); 
      } 
      return session.user; 
    }

    function showError(msg){ 
      errBox.textContent = 'Fehler: ' + msg; 
      errBox.style.display='block'; 
      setTimeout(() => errBox.style.display='none', 5000);
    }

    function showSuccess(msg){
      successBox.textContent = msg;
      successBox.style.display='block';
      setTimeout(() => successBox.style.display='none', 3000);
    }

    function formatDate(dateStr){
      return new Date(dateStr).toLocaleDateString('de-DE', {
        day: '2-digit', month: '2-digit', year: '2-digit'
      });
    }

    // Enhanced Chart Rendering
    function destroyChart(name){
      if(charts[name]){
        charts[name].destroy();
        delete charts[name];
      }
    }

    function renderBarChart(ctxId, labels, datasets, options = {}){
      const ctx = document.getElementById(ctxId);
      destroyChart(ctxId);
      
      const defaultOptions = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
          x: { grid: { display: false } }
        },
        plugins: { 
          legend: { display: datasets.length > 1, position: 'top' },
          tooltip: { 
            backgroundColor: 'rgba(0,0,0,0.8)',
            titleColor: '#fff',
            bodyColor: '#fff',
            cornerRadius: 8
          }
        },
        animation: { duration: 800, easing: 'easeInOutQuart' }
      };
      
      charts[ctxId] = new Chart(ctx, { 
        type: 'bar', 
        data: { labels, datasets }, 
        options: { ...defaultOptions, ...options }
      });
      return charts[ctxId];
    }

    function renderLineChart(ctxId, labels, datasets, options = {}){
      const ctx = document.getElementById(ctxId);
      destroyChart(ctxId);
      
      const defaultOptions = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
          x: { grid: { display: false } }
        },
        plugins: { 
          legend: { display: datasets.length > 1, position: 'top' },
          tooltip: { 
            backgroundColor: 'rgba(0,0,0,0.8)',
            titleColor: '#fff',
            bodyColor: '#fff',
            cornerRadius: 8
          }
        },
        elements: { line: { tension: 0.4 }, point: { radius: 4, hoverRadius: 6 } },
        animation: { duration: 800, easing: 'easeInOutQuart' }
      };
      
      charts[ctxId] = new Chart(ctx, { 
        type: 'line', 
        data: { labels, datasets }, 
        options: { ...defaultOptions, ...options }
      });
      return charts[ctxId];
    }

    function renderDoughnutChart(ctxId, labels, values, options = {}){
      const ctx = document.getElementById(ctxId);
      destroyChart(ctxId);
      
      const colors = [
        '#2563eb', '#14b8a6', '#f59e0b', '#ef4444', '#8b5cf6', 
        '#06d6a0', '#f72585', '#4361ee', '#f77f00', '#fcbf49'
      ];
      
      const defaultOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { 
          legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true } },
          tooltip: { 
            backgroundColor: 'rgba(0,0,0,0.8)',
            titleColor: '#fff',
            bodyColor: '#fff',
            cornerRadius: 8,
            callbacks: {
              label: function(context) {
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((context.parsed / total) * 100).toFixed(1);
                return `${context.label}: ${context.parsed} (${percentage}%)`;
              }
            }
          }
        },
        animation: { duration: 800, easing: 'easeInOutQuart' }
      };
      
      charts[ctxId] = new Chart(ctx, { 
        type: 'doughnut', 
        data: { 
          labels, 
          datasets: [{ 
            data: values, 
            backgroundColor: colors.slice(0, labels.length),
            borderWidth: 2,
            borderColor: '#fff'
          }] 
        }, 
        options: { ...defaultOptions, ...options }
      });
      return charts[ctxId];
    }

    // Enhanced Table Rendering
    function renderTable(tableId, rows, columns = null){
      const tbody = document.querySelector(`#${tableId} tbody`);
      tbody.innerHTML = '';
      
      rows.forEach((row, index) => {
        const tr = document.createElement('tr');
        tr.className = index % 2 === 0 ? 'even' : 'odd';
        
        if(columns){
          columns.forEach(col => {
            const td = document.createElement('td');
            td.innerHTML = row[col] || '–';
            tr.appendChild(td);
          });
        } else {
          Object.values(row).forEach(value => {
            const td = document.createElement('td');
            td.innerHTML = value || '–';
            tr.appendChild(td);
          });
        }
        
        tbody.appendChild(tr);
      });
    }

    function renderStatusTable(tblId, rows){
      const tbody = document.querySelector('#'+tblId+' tbody');
      tbody.innerHTML='';
      
      rows.forEach((r, index) => {
        const tr = document.createElement('tr');
        tr.className = index % 2 === 0 ? 'even' : 'odd';
        tr.innerHTML = `
          <td><span class="pill pill-accent">${r.status||'–'}</span></td>
          <td><strong>${r.absolute||0}</strong></td>
          <td>${(r.percent||0).toFixed(1)}%</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Export Functions
    function toggleExport(chartId){
      const dropdown = document.getElementById(`export-${chartId}`);
      dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
      
      // Close other dropdowns
      document.querySelectorAll('.export-content').forEach(el => {
        if(el.id !== `export-${chartId}`) el.style.display = 'none';
      });
    }

    function exportChart(canvasId, format){
      const canvas = document.getElementById(canvasId);
      if(!canvas) return;
      
      if(format === 'png'){
        const link = document.createElement('a');
        link.download = `${canvasId}_${new Date().toISOString().slice(0,10)}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
        showSuccess('Chart als PNG exportiert!');
      } else if(format === 'csv'){
        const chart = charts[canvasId];
        if(!chart) return;
        
        let csv = 'Label,Wert\n';
        chart.data.labels.forEach((label, i) => {
          const value = chart.data.datasets[0].data[i];
          csv += `"${label}","${value}"\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const link = document.createElement('a');
        link.download = `${canvasId}_${new Date().toISOString().slice(0,10)}.csv`;
        link.href = URL.createObjectURL(blob);
        link.click();
        showSuccess('Chart-Daten als CSV exportiert!');
      }
      
      // Close dropdown
      document.querySelectorAll('.export-content').forEach(el => el.style.display = 'none');
    }

    function exportTable(tableId){
      const table = document.getElementById(tableId);
      if(!table) return;
      
      let csv = '';
      const rows = table.querySelectorAll('tr');
      
      rows.forEach(row => {
        const cols = row.querySelectorAll('th, td');
        const rowData = Array.from(cols).map(col => `"${col.textContent.trim()}"`);
        csv += rowData.join(',') + '\n';
      });
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const link = document.createElement('a');
      link.download = `${tableId}_${new Date().toISOString().slice(0,10)}.csv`;
      link.href = URL.createObjectURL(blob);
      link.click();
      showSuccess('Tabelle als CSV exportiert!');
    }

    // Data Loading Functions
    async function loadProjects(){
      errBox.style.display='none';
      currentUserId=null;
      
      // Hide user cards
      ['cardUserCompl', 'cardUserChanges', 'cardUserStatus'].forEach(id => {
        q('#'+id).style.display='none';
      });
      
      // Show project cards
      ['cardProjCompl', 'cardProjChanges', 'cardProjStatus'].forEach(id => {
        q('#'+id).style.display='block';
      });
      
      const { data, error } = await supabase.rpc('fn_dashboard_guarded_projects');
      if (error){ 
        showError(error.message); 
        return []; 
      }
      
      allProjects = data || [];
      
      // Update KPIs
      q('#totalProjects').textContent = allProjects.length;
      q('#totalUsers').textContent = allProjects.reduce((sum, p) => sum + (p.user_count || 0), 0);
      q('#totalWE').textContent = allProjects.reduce((sum, p) => sum + (p.total_we || 0), 0);
      
      // Update project filter
      const projectFilter = q('#projectFilter');
      projectFilter.innerHTML = '<option value="">Alle Projekte</option>';
      allProjects.forEach(p => {
        const option = document.createElement('option');
        option.value = p.project;
        option.textContent = p.project;
        projectFilter.appendChild(option);
      });
      
      // Render projects table
      const tbody = q('#tblProjects tbody');
      tbody.innerHTML='';
      
      allProjects.forEach((row, index) => {
        const tr = document.createElement('tr');
        tr.className = index % 2 === 0 ? 'even' : 'odd';
        
        const completionRate = row.total_we > 0 ? Math.round((row.user_count / row.total_we) * 100) : 0;
        const statusColor = completionRate > 80 ? 'success' : completionRate > 50 ? 'warning' : 'danger';
        
        tr.innerHTML = `
          <td><i class="fas fa-city"></i> ${row.project||'–'}</td>
          <td><strong>${row.total_we||0}</strong></td>
          <td>${row.user_count||0}</td>
          <td><span class="pill pill-${statusColor}">${completionRate}%</span></td>
        `;
        
        tr.addEventListener('click', () => {
          // Remove previous selection
          tbody.querySelectorAll('tr').forEach(r => r.classList.remove('selected'));
          tr.classList.add('selected');
          selectProject(row.project, Number(row.total_we||0));
        });
        
        tbody.appendChild(tr);
      });
      
      return allProjects;
    }

    async function selectProject(project, totalWE){
      currentProject = project; 
      projectTotalWE = totalWE||0; 
      q('#selProject').textContent = project || '–';
      
      // Load users for this project
      const { data, error } = await supabase.rpc('fn_dashboard_guarded_project_users', { p_project: project });
      if (error){ 
        showError(error.message); 
        return; 
      }
      
      allUsers = data || [];
      
      // Render users table
      const tbody = q('#tblUsers tbody');
      tbody.innerHTML='';
      
      allUsers.forEach((u, index) => {
        const tr = document.createElement('tr');
        tr.className = index % 2 === 0 ? 'even' : 'odd';
        
        const name = u.display_name || u.email || u.user_id;
        const completionRate = totalWE > 0 ? Math.round((u.we_count / totalWE) * 100) : 0;
        
        tr.innerHTML = `
          <td><i class="fas fa-user"></i> ${name}</td>
          <td><strong>${u.we_count||0}</strong></td>
          <td><span class="pill pill-teal">${completionRate}%</span></td>
        `;
        
        tr.addEventListener('click', () => {
          tbody.querySelectorAll('tr').forEach(r => r.classList.remove('selected'));
          tr.classList.add('selected');
          selectUser(u.user_id, name);
        });
        
        tbody.appendChild(tr);
      });
      
      // Visual project highlight
      q('#selProject').classList.add('pill-accent');
      
      // Load project charts
      await refreshProjectCharts();
    }

    async function refreshProjectCharts(){
      if(!currentProject) return;
      
      const range = Number(q('#range').value||30);
      
      // Show loading states
      ['cardProjCompl', 'cardProjChanges', 'cardProjStatus'].forEach(id => {
        q('#'+id).classList.add('loading');
      });
      
      try {
        const [completions, changes, statusTable] = await Promise.all([
          supabase.rpc('fn_dashboard_guarded_project_daily_completions', { p_project: currentProject, p_days: range }),
          supabase.rpc('fn_dashboard_guarded_project_daily_changes', { p_project: currentProject, p_days: range }),
          supabase.rpc('fn_dashboard_guarded_project_status_table', { p_project: currentProject })
        ]);
        
        // Render completions chart
        if (completions.error) {
          showError(completions.error.message);
        } else {
          const labels = (completions.data||[]).map(r => formatDate(r.day));
          const values = (completions.data||[]).map(r => Number(r.completions||0));
          
          renderBarChart('chartProjCompl', labels, [{
            label: 'Abschlüsse',
            data: values,
            backgroundColor: 'rgba(37, 99, 235, 0.6)',
            borderColor: '#2563eb',
            borderWidth: 2
          }]);
        }
        
        // Render changes chart
        if (changes.error) {
          showError(changes.error.message);
        } else {
          const labels = (changes.data||[]).map(r => formatDate(r.day));
          const values = (changes.data||[]).map(r => Number(r.changes||0));
          
          renderBarChart('chartProjChanges', labels, [{
            label: 'Änderungen',
            data: values,
            backgroundColor: 'rgba(20, 184, 166, 0.6)',
            borderColor: '#14b8a6',
            borderWidth: 2
          }]);
        }
        
        // Render status breakdown
        if (statusTable.error) {
          showError(statusTable.error.message);
        } else {
          const breakdown = statusTable.data?.breakdown || {};
          const entries = Object.entries(breakdown).sort((a,b) => b[1]-a[1]);
          const labels = entries.map(([k]) => k);
          const values = entries.map(([,v]) => v);
          
          if(labels.length > 0){
            renderDoughnutChart('chartProjStatus', labels, values);
          }
          
          const tableData = (statusTable.data?.table||[]).map(r => ({
            status: r.status,
            absolute: Number(r.absolute||0),
            percent: Number(r.percent||0)
          }));
          
          renderStatusTable('tblProjStatus', tableData);
          
          // Show status cards
          q('#cardProjStatus').style.display='block';
          q('#cardProjStatusTable').style.display='block';
        }
        
      } finally {
        // Remove loading states
        ['cardProjCompl', 'cardProjChanges', 'cardProjStatus'].forEach(id => {
          q('#'+id).classList.remove('loading');
        });
      }
    }

    async function selectUser(userId, name){
      currentUserId = userId;
      const range = Number(q('#range').value||30);
      
      // Show user cards
      ['cardUserCompl', 'cardUserChanges', 'cardUserStatus', 'cardWeeklyHeatmap', 'cardMonthlyTrend'].forEach(id => {
        q('#'+id).style.display='block';
      });
      
      // Update user badge
      const selU = q('#selUser');
      selU.style.display='inline-block';
      selU.textContent = name || '–';
      
      // Show loading states
      ['cardUserCompl', 'cardUserChanges', 'cardUserStatus', 'cardUserHourly', 'cardUserSummary'].forEach(id => {
        q('#'+id).classList.add('loading');
      });
      
      try {
        const dateStr = q('#userHourlyDate').value || new Date().toISOString().slice(0,10);
        
        const [userCompl, userChanges, userStatus, userHourly, userSummary] = await Promise.all([
          supabase.rpc('fn_dashboard_guarded_user_daily_completions', { p_user_id: userId, p_days: range }),
          supabase.rpc('fn_dashboard_guarded_user_daily_changes', { p_user_id: userId, p_days: range }),
          supabase.rpc('fn_dashboard_guarded_user_status_table', { p_user_id: userId, p_project: currentProject }),
          supabase.rpc('fn_dashboard_guarded_user_hourly_changes', { p_user_id: userId, p_date: dateStr }),
          supabase.rpc('fn_dashboard_guarded_user_summary_metrics', { p_user_id: userId, p_project: currentProject })
        ]);
        
        // Render user completions
        if (userCompl.error) {
          showError(userCompl.error.message);
        } else {
          const labels = (userCompl.data||[]).map(r => formatDate(r.day));
          const values = (userCompl.data||[]).map(r => Number(r.completions||0));
          
          renderBarChart('chartUserCompl', labels, [{
            label: 'Abschlüsse',
            data: values,
            backgroundColor: 'rgba(37, 99, 235, 0.6)',
            borderColor: '#2563eb',
            borderWidth: 2
          }]);
        }
        
        // Render user changes
        if (userChanges.error) {
          showError(userChanges.error.message);
        } else {
          const labels = (userChanges.data||[]).map(r => formatDate(r.day));
          const values = (userChanges.data||[]).map(r => Number(r.changes||0));
          
          renderLineChart('chartUserChanges', labels, [{
            label: 'Änderungen',
            data: values,
            backgroundColor: 'rgba(20, 184, 166, 0.1)',
            borderColor: '#14b8a6',
            borderWidth: 3,
            fill: true
          }]);
        }
        
        // Render user status breakdown
        if (userStatus.error) {
          showError(userStatus.error.message);
        } else {
          const breakdown = userStatus.data?.breakdown || {};
          const entries = Object.entries(breakdown).sort((a,b) => b[1]-a[1]);
          const labels = entries.map(([k]) => k);
          const values = entries.map(([,v]) => v);
          
          if(labels.length > 0){
            renderDoughnutChart('chartUserStatus', labels, values);
          }
          
          const tableData = (userStatus.data?.table||[]).map(r => ({
            status: r.status,
            absolute: Number(r.absolute||0),
            percent: Number(r.percent||0)
          }));
          
          renderStatusTable('tblUserStatus', tableData);
          
          q('#cardUserStatus').style.display='block';
          q('#cardUserStatusTable').style.display='block';
        }
        
        // Render hourly changes
        if (userHourly.error) {
          showError(userHourly.error.message);
        } else {
          const hours = Array.from({length:24}, (_,i) => i);
          const dataMap = new Map((userHourly.data||[]).map(r => [Number(r.hour), Number(r.changes)]));
          const values = hours.map(h => dataMap.get(h)||0);
          const labels = hours.map(h => String(h).padStart(2,'0')+':00');
          
          renderBarChart('chartUserHourly', labels, [{
            label: 'Änderungen',
            data: values,
            backgroundColor: 'rgba(245, 158, 11, 0.6)',
            borderColor: '#f59e0b',
            borderWidth: 2
          }]);
        }
        
        // Render user summary
        if (userSummary.error) {
          showError(userSummary.error.message);
        } else {
          const t = q('#tblUserSummary tbody');
          const d = userSummary.data || {};
          
          t.innerHTML = `
            <tr>
              <td><i class="fas fa-exchange-alt"></i> Gesamt Statusänderungen</td>
              <td><strong>${d.total_changes??0}</strong></td>
            </tr>
            <tr>
              <td><i class="fas fa-check-circle"></i> Abschlüsse (nicht Online)</td>
              <td><strong>${d.completions??0}</strong></td>
            </tr>
            <tr>
              <td><i class="fas fa-calculator"></i> Ø Änderungen bis Abschluss</td>
              <td><strong>${(d.avg_changes_per_completion??0)}</strong></td>
            </tr>
            <tr>
              <td><i class="fas fa-home"></i> WE mit Status</td>
              <td>
                <strong>${d.we_with_status??0}</strong> 
                <span class="pill pill-success">${(d.we_with_status_percent??0).toFixed(1)}%</span>
              </td>
            </tr>
            <tr>
              <td><i class="fas fa-building"></i> WE gesamt (Projekt)</td>
              <td><strong>${d.we_total??0}</strong></td>
            </tr>
          `;
        }
        
      } finally {
        // Remove loading states
        ['cardUserCompl', 'cardUserChanges', 'cardUserStatus', 'cardUserHourly', 'cardUserSummary'].forEach(id => {
          q('#'+id).classList.remove('loading');
        });
      }
    }

    // Auto-refresh functionality
    function startAutoRefresh(){
      if(autoRefreshInterval) clearInterval(autoRefreshInterval);
      
      autoRefreshInterval = setInterval(async () => {
        try {
          if(currentProject) await refreshProjectCharts();
          if(currentUserId && currentProject) await selectUser(currentUserId, q('#selUser').textContent);
          
          // Update live indicator
          const liveDot = q('.live-dot');
          liveDot.style.background = '#10b981';
          setTimeout(() => liveDot.style.background = 'var(--success)', 200);
          
        } catch(error) {
          console.error('Auto-refresh error:', error);
        }
      }, 300000); // 5 minutes
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
      // Initialize date inputs
      const today = new Date().toISOString().slice(0,10);
      const weekAgo = new Date(Date.now() - 7*24*60*60*1000).toISOString().slice(0,10);
      
      q('#dateTo').value = today;
      q('#dateFrom').value = weekAgo;
      q('#userHourlyDate').value = today;
      
      // Auto-refresh toggle
      startAutoRefresh();
    });

    q('#btnRefresh').addEventListener('click', async () => {
      q('#btnRefresh').classList.add('loading');
      try {
        await loadProjects();
        if (currentProject) await refreshProjectCharts();
        if (currentUserId && currentProject) await selectUser(currentUserId, q('#selUser').textContent);
        showSuccess('Dashboard aktualisiert!');
      } finally {
        q('#btnRefresh').classList.remove('loading');
      }
    });

    q('#btnExportAll').addEventListener('click', () => {
      // Export all visible charts and tables
      Object.keys(charts).forEach(chartId => {
        if(q('#' + chartId).closest('.card').style.display !== 'none'){
          setTimeout(() => exportChart(chartId, 'png'), 100);
        }
      });
      showSuccess('Alle Charts werden exportiert...');
    });

    q('#btnLogout').addEventListener('click', async () => { 
      if(autoRefreshInterval) clearInterval(autoRefreshInterval);
      await supabase.auth.signOut(); 
      window.location.href='./login.html'; 
    });

    // PDF Export functionality
    q('#btnExportPDF').addEventListener('click', openPDFModal);

    function openPDFModal(){
      // Populate project selector
      const select = q('#pdfProjectSelect');
      select.innerHTML = '<option value="">Bitte Projekt wählen...</option>';
      
      allProjects.forEach(project => {
        const option = document.createElement('option');
        option.value = project.project;
        option.textContent = `${project.project} (${project.total_we} WE, ${project.user_count} MA)`;
        select.appendChild(option);
      });
      
      q('#pdfModal').style.display = 'flex';
    }

    function closePDFModal(){
      q('#pdfModal').style.display = 'none';
    }

    async function generatePDFReport(){
      const selectedProject = q('#pdfProjectSelect').value;
      const timeRange = parseInt(q('#pdfTimeRange').value);
      const reportType = q('#pdfReportType').value;
      
      if(!selectedProject){
        alert('Bitte wählen Sie ein Projekt aus!');
        return;
      }
      
      // Close modal and show overlay
      closePDFModal();
      q('#pdfOverlay').style.display = 'flex';
      
      try {
        await createPDFReport(selectedProject, timeRange, reportType);
      } catch(error) {
        console.error('PDF generation error:', error);
        alert('Fehler beim Erstellen des PDF-Reports: ' + error.message);
      } finally {
        q('#pdfOverlay').style.display = 'none';
      }
    }

    async function createPDFReport(projectName, timeRange, reportType){
      updatePDFProgress('Projektdaten werden geladen...', 10);
      
      // Load project data
      const projectData = allProjects.find(p => p.project === projectName);
      if(!projectData){
        throw new Error('Projekt nicht gefunden');
      }
      
      updatePDFProgress('Mitarbeiterdaten werden geladen...', 20);
      
      // Load project users
      const { data: users, error: usersError } = await supabase.rpc('fn_dashboard_guarded_project_users', { 
        p_project: projectName 
      });
      if(usersError) throw usersError;
      
      updatePDFProgress('Analytics-Daten werden geladen...', 40);
      
      // Load analytics data
      const [completionsData, changesData, statusData] = await Promise.all([
        supabase.rpc('fn_dashboard_guarded_project_daily_completions', { 
          p_project: projectName, 
          p_days: timeRange 
        }),
        supabase.rpc('fn_dashboard_guarded_project_daily_changes', { 
          p_project: projectName, 
          p_days: timeRange 
        }),
        supabase.rpc('fn_dashboard_guarded_project_status_table', { 
          p_project: projectName 
        })
      ]);
      
      if(completionsData.error) throw completionsData.error;
      if(changesData.error) throw changesData.error;
      if(statusData.error) throw statusData.error;
      
      updatePDFProgress('Mitarbeiter-Details werden geladen...', 60);
      
      // Load individual user data if full report
      let userDetails = [];
      if(reportType === 'full'){
        for(let user of users || []){
          const [userCompl, userChanges, userSummary] = await Promise.all([
            supabase.rpc('fn_dashboard_guarded_user_daily_completions', { 
              p_user_id: user.user_id, 
              p_days: timeRange 
            }),
            supabase.rpc('fn_dashboard_guarded_user_daily_changes', { 
              p_user_id: user.user_id, 
              p_days: timeRange 
            }),
            supabase.rpc('fn_dashboard_guarded_user_summary_metrics', { 
              p_user_id: user.user_id, 
              p_project: projectName 
            })
          ]);
          
          userDetails.push({
            user,
            completions: userCompl.data || [],
            changes: userChanges.data || [],
            summary: userSummary.data || {}
          });
        }
      }
      
      updatePDFProgress('PDF wird generiert...', 80);
      
      // Generate PDF content
      const pdfHTML = generatePDFHTML({
        project: projectData,
        projectName,
        users: users || [],
        userDetails,
        completions: completionsData.data || [],
        changes: changesData.data || [],
        status: statusData.data || {},
        timeRange,
        reportType,
        generatedAt: new Date()
      });
      
      // Insert into hidden container
      q('#pdfContainer').innerHTML = pdfHTML;
      
      updatePDFProgress('PDF wird erstellt...', 90);
      
      // Generate PDF using html2canvas + jsPDF
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');
      
      const pages = q('#pdfContainer').querySelectorAll('.pdf-page');
      
      for(let i = 0; i < pages.length; i++){
        if(i > 0) pdf.addPage();
        
        const canvas = await html2canvas(pages[i], {
          scale: 2,
          backgroundColor: '#ffffff',
          useCORS: true,
          allowTaint: true,
          width: 794,
          height: 1123
        });
        
        const imgData = canvas.toDataURL('image/png');
        pdf.addImage(imgData, 'PNG', 0, 0, 210, 297);
      }
      
      updatePDFProgress('PDF wird gespeichert...', 100);
      
      // Download PDF
      const fileName = `${projectName}_Report_${new Date().toISOString().slice(0,10)}.pdf`;
      pdf.save(fileName);
      
      // Clean up
      q('#pdfContainer').innerHTML = '';
      
      showSuccess(`PDF-Report "${fileName}" wurde erfolgreich erstellt!`);
    }

    function updatePDFProgress(status, percent){
      q('#pdfStatus').textContent = status;
      q('#pdfProgressFill').style.width = percent + '%';
    }

    function generatePDFHTML(data){
      const { project, projectName, users, userDetails, completions, changes, status, timeRange, reportType, generatedAt } = data;
      
      // Calculate summary stats
      const totalCompletions = completions.reduce((sum, d) => sum + (d.completions || 0), 0);
      const totalChanges = changes.reduce((sum, d) => sum + (d.changes || 0), 0);
      const avgChangesPerDay = Math.round(totalChanges / timeRange);
      
      let html = `
        <div class="pdf-page">
          <div class="pdf-header">
            <div class="pdf-title">Projekt-Report: ${projectName}</div>
            <div class="pdf-subtitle">Zeitraum: ${timeRange} Tage • Erstellt am ${generatedAt.toLocaleDateString('de-DE')}</div>
            <div class="pdf-date">Admin Dashboard Pro</div>
          </div>
          
          <div class="pdf-section">
            <div class="pdf-section-title">Projekt-Übersicht</div>
            <div class="pdf-kpi">
              <div class="pdf-kpi-item">
                <div class="pdf-kpi-value">${project.total_we || 0}</div>
                <div class="pdf-kpi-label">WE Gesamt</div>
              </div>
              <div class="pdf-kpi-item">
                <div class="pdf-kpi-value">${project.user_count || 0}</div>
                <div class="pdf-kpi-label">Mitarbeiter</div>
              </div>
              <div class="pdf-kpi-item">
                <div class="pdf-kpi-value">${totalCompletions}</div>
                <div class="pdf-kpi-label">Abschlüsse</div>
              </div>
              <div class="pdf-kpi-item">
                <div class="pdf-kpi-value">${totalChanges}</div>
                <div class="pdf-kpi-label">Änderungen</div>
              </div>
              <div class="pdf-kpi-item">
                <div class="pdf-kpi-value">${avgChangesPerDay}</div>
                <div class="pdf-kpi-label">Ø Änderungen/Tag</div>
              </div>
            </div>
          </div>
          
          <div class="pdf-section">
            <div class="pdf-section-title">Status-Verteilung</div>
            <table class="pdf-table">
              <thead>
                <tr><th>Status</th><th>Anzahl</th><th>Anteil</th></tr>
              </thead>
              <tbody>`;
      
      (status.table || []).forEach(row => {
        html += `<tr><td>${row.status}</td><td>${row.absolute}</td><td>${row.percent}%</td></tr>`;
      });
      
      html += `</tbody></table></div>
          
          <div class="pdf-section">
            <div class="pdf-section-title">Mitarbeiter-Übersicht</div>
            <table class="pdf-table">
              <thead>
                <tr><th>Mitarbeiter</th><th>WE</th><th>Anteil am Projekt</th></tr>
              </thead>
              <tbody>`;
      
      users.forEach(user => {
        const percentage = project.total_we > 0 ? ((user.we_count / project.total_we) * 100).toFixed(1) : 0;
        const name = user.display_name || user.email || user.user_id;
        html += `<tr><td>${name}</td><td>${user.we_count || 0}</td><td>${percentage}%</td></tr>`;
      });
      
      html += `</tbody></table></div>
          <div class="pdf-footer">
            Erstellt mit Admin Dashboard Pro • ${new Date().toLocaleString('de-DE')}
          </div>
        </div>`;
      
      // Add detailed user pages for full report
      if(reportType === 'full' && userDetails.length > 0){
        userDetails.forEach(userDetail => {
          const user = userDetail.user;
          const summary = userDetail.summary;
          const name = user.display_name || user.email || user.user_id;
          
          html += `
            <div class="pdf-page">
              <div class="pdf-header">
                <div class="pdf-title">Mitarbeiter-Details: ${name}</div>
                <div class="pdf-subtitle">Projekt: ${projectName} • Zeitraum: ${timeRange} Tage</div>
                <div class="pdf-date">Erstellt am ${generatedAt.toLocaleDateString('de-DE')}</div>
              </div>
              
              <div class="pdf-section">
                <div class="pdf-section-title">Leistungsübersicht</div>
                <div class="pdf-kpi">
                  <div class="pdf-kpi-item">
                    <div class="pdf-kpi-value">${summary.total_changes || 0}</div>
                    <div class="pdf-kpi-label">Gesamt Änderungen</div>
                  </div>
                  <div class="pdf-kpi-item">
                    <div class="pdf-kpi-value">${summary.completions || 0}</div>
                    <div class="pdf-kpi-label">Abschlüsse</div>
                  </div>
                  <div class="pdf-kpi-item">
                    <div class="pdf-kpi-value">${summary.avg_changes_per_completion || 0}</div>
                    <div class="pdf-kpi-label">Ø Änderungen/Abschluss</div>
                  </div>
                  <div class="pdf-kpi-item">
                    <div class="pdf-kpi-value">${summary.we_with_status || 0}</div>
                    <div class="pdf-kpi-label">WE mit Status</div>
                  </div>
                  <div class="pdf-kpi-item">
                    <div class="pdf-kpi-value">${(summary.we_with_status_percent || 0).toFixed(1)}%</div>
                    <div class="pdf-kpi-label">Quote</div>
                  </div>
                </div>
              </div>
              
              <div class="pdf-section">
                <div class="pdf-section-title">Tägliche Aktivität</div>
                <table class="pdf-table">
                  <thead>
                    <tr><th>Datum</th><th>Abschlüsse</th><th>Änderungen</th></tr>
                  </thead>
                  <tbody>`;
          
          // Combine completions and changes by date
          const dailyActivity = new Map();
          userDetail.completions.forEach(c => {
            const date = new Date(c.day).toLocaleDateString('de-DE');
            if(!dailyActivity.has(date)) dailyActivity.set(date, {completions: 0, changes: 0});
            dailyActivity.get(date).completions = c.completions;
          });
          userDetail.changes.forEach(c => {
            const date = new Date(c.day).toLocaleDateString('de-DE');
            if(!dailyActivity.has(date)) dailyActivity.set(date, {completions: 0, changes: 0});
            dailyActivity.get(date).changes = c.changes;
          });
          
          Array.from(dailyActivity.entries())
            .sort((a, b) => new Date(a[0].split('.').reverse().join('-')) - new Date(b[0].split('.').reverse().join('-')))
            .slice(-7) // Last 7 days for space
            .forEach(([date, activity]) => {
              html += `<tr><td>${date}</td><td>${activity.completions}</td><td>${activity.changes}</td></tr>`;
            });
          
          html += `</tbody></table></div>
              <div class="pdf-footer">
                Mitarbeiter-Report für ${name} • ${new Date().toLocaleString('de-DE')}
              </div>
            </div>`;
        });
      }
      
      return html;
    }

    // Close modal when clicking outside
    q('#pdfModal').addEventListener('click', (e) => {
      if(e.target === q('#pdfModal')){
        closePDFModal();
      }
    });

    q('#range').addEventListener('change', async () => {
      if (currentProject) await refreshProjectCharts();
      if (currentUserId && currentProject) await selectUser(currentUserId, q('#selUser').textContent);
    });

    q('#userHourlyDate').addEventListener('change', async () => {
      if (currentUserId) {
        const dateStr = q('#userHourlyDate').value;
        const hourly = await supabase.rpc('fn_dashboard_guarded_user_hourly_changes', { 
          p_user_id: currentUserId, 
          p_date: dateStr 
        });
        
        if (!hourly.error) {
          const hours = Array.from({length:24}, (_,i) => i);
          const dataMap = new Map((hourly.data||[]).map(r => [Number(r.hour), Number(r.changes)]));
          const values = hours.map(h => dataMap.get(h)||0);
          const labels = hours.map(h => String(h).padStart(2,'0')+':00');
          
          renderBarChart('chartUserHourly', labels, [{
            label: 'Änderungen',
            data: values,
            backgroundColor: 'rgba(245, 158, 11, 0.6)',
            borderColor: '#f59e0b',
            borderWidth: 2
          }]);
        }
      }
    });

    q('#projectFilter').addEventListener('change', (e) => {
      const selectedProject = e.target.value;
      if(selectedProject && selectedProject !== currentProject){
        const project = allProjects.find(p => p.project === selectedProject);
        if(project){
          selectProject(project.project, project.total_we);
        }
      }
    });

    // Close export dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      if(!e.target.closest('.export-dropdown')){
        document.querySelectorAll('.export-content').forEach(el => {
          el.style.display = 'none';
        });
      }
    });

    // Initialize Dashboard
    (async () => { 
      try {
        await requireAuth(); 
        await loadProjects();
        showSuccess('Dashboard geladen!');
      } catch(error) {
        showError('Fehler beim Laden des Dashboards: ' + error.message);
      }
    })();

  </script>
</body>
</html>