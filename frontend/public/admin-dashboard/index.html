<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    :root { --bg:#f5f7fa; --surface:#fff; --text:#111827; --muted:#6b7280; --border:#e5e7eb; --accent:#2563eb; --accent-600:#1d4ed8; --teal:#14b8a6; --radius:12px; --shadow:0 10px 30px rgba(0,0,0,.06);} *{box-sizing:border-box}
    body{margin:0; font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Ubuntu,sans-serif; background:var(--bg); color:var(--text)}
    header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:var(--surface);box-shadow:var(--shadow);position:sticky;top:0;z-index:10}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}
    .brand img{height:28px;width:28px;border-radius:6px}
    .controls{display:flex;gap:10px;align-items:center}
    select,button{padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:#fff}
    button{background:var(--accent);color:#fff;border:none;box-shadow:0 2px 8px rgba(37,99,235,.2);cursor:pointer}
    button:hover{background:var(--accent-600)}
    main{padding:16px;display:grid;grid-template-columns:320px 1fr;gap:16px}
    .panel{background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow);padding:12px}
    .panel h3{margin:6px 0 10px 0}
    .list{max-height:60vh;overflow:auto;border:1px solid var(--border);border-radius:8px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{font-size:13px;padding:10px 12px;border-bottom:1px solid var(--border)}
    th{position:sticky;top:0;background:#fafafa;text-align:left}
    tr:hover td{background:#fcfdff}
    .grid{display:grid;grid-template-columns: repeat(auto-fill,minmax(360px,1fr));gap:16px}
    .card{background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    canvas{max-height:300px}
    .error{color:#b91c1c;background:#fee2e2;border:1px solid #fecaca;padding:8px 10px;border-radius:10px;margin:10px 0;display:none}
  </style>
</head>
<body>
  <header>
    <div class="brand"><img src="../qualitool/qt-logo.png" alt="logo"/> <span>Admin Dashboard</span></div>
    <div class="controls">
      <select id="range"><option value="7">7 Tage</option><option value="30" selected>30 Tage</option><option value="90">90 Tage</option></select>
      <button id="btnRefresh">Aktualisieren</button>
      <button id="btnLogout" style="background:#111827">Logout</button>
    </div>
  </header>
  <main>
    <section class="panel">
      <h3>Projekte</h3>
      <div class="list">
        <table id="tblProjects"><thead><tr><th>Projekt (Stadt)</th><th>WE gesamt</th><th>Mitarbeiter</th></tr></thead><tbody></tbody></table>
      </div>
      <h3 style="margin-top:12px">Mitarbeiter im Projekt: <span id="selProject">–</span></h3>
      <div class="list">
        <table id="tblUsers"><thead><tr><th>Mitarbeiter</th><th>WE</th></tr></thead><tbody></tbody></table>
      </div>
      <div id="err" class="error"></div>
    </section>
    <section class="panel">
      <div class="grid">
        <div class="card"><h4>Abschlüsse/Änderungen pro Tag</h4><canvas id="chartDaily"></canvas></div>
        <div class="card"><h4>Status‑Breakdown</h4><canvas id="chartStatus"></canvas></div>
      </div>
    </section>
  </main>

  <script>
    const SUPABASE_URL = 'https://whigasnqcvjkilkmbfld.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndoaWdhc25xY3Zqa2lsa21iZmxkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyNDE1OTIsImV4cCI6MjA2OTgxNzU5Mn0.tfUnIP_oWy3N9UM6Ws9mPiKqsGtj8_kIOMW42E298rc';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: false } });

    const q = sel => document.querySelector(sel);
    const errBox = q('#err');
    let chDaily, chStatus; let currentUserId = null; let currentProject = null;

    async function requireAuth(){ const { data:{ session } } = await supabase.auth.getSession(); if (!session) { window.location.href='./login.html'; throw new Error('no_session'); } return session.user; }

    function daysAgoISO(n){ const d=new Date(); d.setDate(d.getDate()-n); d.setHours(0,0,0,0); return d.toISOString(); }

    async function loadProjects(){
      errBox.style.display='none';
      const { data, error } = await supabase.rpc('fn_dashboard_guarded_projects');
      if (error){ showError(error.message); return []; }
      const tbody = q('#tblProjects tbody'); tbody.innerHTML='';
      (data||[]).forEach(row=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${row.project||'–'}</td><td>${row.total_we||0}</td><td>${row.user_count||0}</td>`;
        tr.addEventListener('click', ()=> selectProject(row.project));
        tbody.appendChild(tr);
      });
      return data||[];
    }

    async function selectProject(project){
      currentProject = project; q('#selProject').textContent = project || '–';
      const { data, error } = await supabase.rpc('fn_dashboard_guarded_project_users', { p_project: project });
      if (error){ showError(error.message); return; }
      const tbody = q('#tblUsers tbody'); tbody.innerHTML='';
      (data||[]).forEach(u=>{
        const tr=document.createElement('tr');
        const name = u.display_name || u.email || u.user_id;
        tr.innerHTML = `<td>${name}</td><td>${u.we_count||0}</td>`;
        tr.addEventListener('click', ()=> selectUser(u.user_id, name));
        tbody.appendChild(tr);
      });
    }

    async function selectUser(userId, name){
      currentUserId = userId; const range = Number(q('#range').value||30);
      // Daily changes
      const { data:daily, error:e1 } = await supabase.rpc('fn_dashboard_guarded_user_daily_changes', { p_user_id: userId, p_days: range });
      if (e1){ showError(e1.message); return; }
      // Status breakdown
      const { data:statusJson, error:e2 } = await supabase.rpc('fn_dashboard_guarded_user_status_breakdown', { p_user_id: userId });
      if (e2){ showError(e2.message); return; }
      renderDaily(daily||[]);
      renderStatus(statusJson||{});
    }

    function showError(msg){ errBox.textContent = 'Fehler: ' + msg; errBox.style.display='block'; }

    function renderDaily(rows){
      const labels = rows.map(r=> new Date(r.day).toLocaleDateString('de-DE'));
      const vals = rows.map(r=> r.changes||0);
      if (chDaily) chDaily.destroy();
      chDaily = new Chart(document.getElementById('chartDaily'), {
        type:'line', data:{ labels, datasets:[{ label:'Änderungen', data:vals, borderColor:'#2563eb', backgroundColor:'rgba(37,99,235,.15)', tension:.35, fill:true }] },
        options:{ scales:{ y:{ beginAtZero:true } }, plugins:{ legend:{ display:false } } }
      });
    }
    function renderStatus(obj){
      const entries = Object.entries(obj).sort((a,b)=> b[1]-a[1]).slice(0,12);
      const labels = entries.map(([k])=>k); const vals = entries.map(([,v])=>v);
      if (chStatus) chStatus.destroy();
      chStatus = new Chart(document.getElementById('chartStatus'), {
        type:'doughnut', data:{ labels, datasets:[{ data:vals, backgroundColor: labels.map((_,i)=> `hsl(${(i*37)%360} 80% 60%)`) }] },
        options:{ plugins:{ legend:{ position:'bottom' } } }
      });
    }

    document.getElementById('btnRefresh').addEventListener('click', async ()=>{
      await loadProjects(); if (currentProject) await selectProject(currentProject); if (currentUserId) await selectUser(currentUserId);
    });
    document.getElementById('btnLogout').addEventListener('click', async ()=>{ await supabase.auth.signOut(); window.location.href='./login.html'; });

    (async ()=>{ await requireAuth(); await loadProjects(); })();
  </script>
</body>
</html>