<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Qualifizierungs-Tool | Login</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
  // Verhindere mehrere GoTrue-Instanzen: globaler Client
  (function(){
    try{
      if (!window.supa && window.supabase && window.supabase.createClient){
        const SUPABASE_URL = 'https://whigasnqcvjkilkmbfld.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndoaWdhc25xY3Zqa2lsa21iZmxkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyNDE1OTIsImV4cCI6MjA2OTgxNzU5Mn0.tfUnIP_oWy3N9UM6Ws9mPiKqsGtj8_kIOMW42E298rc';

        function getCapacitorStorage(){
          try{
            const P = (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.Preferences) || null;
            if (!P) return null;
            return {
              getItem: async (key) => { const r = await P.get({ key }); return (r && typeof r.value==='string') ? r.value : null; },
              setItem: async (key, value) => { await P.set({ key, value: String(value ?? '') }); },
              removeItem: async (key) => { await P.remove({ key }); }
            };
          }catch(e){ return null; }
        }

        const capStore = getCapacitorStorage();
        // Fallback auf Default-Storage, wenn Preferences nicht verfügbar sind
        window.supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
          auth: {
            persistSession: true,
            storage: capStore || undefined,
            autoRefreshToken: true,
            detectSessionInUrl: false
          }
        });
      }
    }catch(e){ /* ignore */ }
  })();
</script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif; background:#f5f7fa; margin:0; }
    .wrap { max-width: 380px; margin: 8vh auto; background:#fff; padding: 24px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,.08); }
    h1 { font-size: 20px; margin: 0 0 16px 0; text-align:center; color:#111827; }
    .form { display:flex; flex-direction:column; gap:12px; }
    input { padding: 10px 12px; border:1px solid #e5e7eb; border-radius:8px; font-size:14px; }
    input:focus { outline:none; border-color:#2563eb; box-shadow:0 0 0 3px rgba(37,99,235,0.12); }
    .row { display:flex; gap:10px; }
    button { background:#2563eb; color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:600; }
    button.secondary { background:#111827; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .muted { color:#6b7280; font-size:12px; text-align:center; margin-top:8px; }
    .error { color:#b91c1c; background:#fee2e2; border:1px solid #fecaca; padding:8px 10px; border-radius:8px; display:none; font-size:13px; }
    .loading { display:none; color:#2563eb; text-align:center; font-size:13px; }
    .offline { display:none; color:#92400e; background:#fef3c7; border:1px solid #fcd34d; padding:8px 10px; border-radius:8px; font-size:13px; margin-bottom:10px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Login zum Qualifizierungs‑Tool</h1>
    <div class="offline" id="offlineMsg">Sie sind offline. Ein Login ist erst nach Internetverbindung möglich. Falls Sie bereits eingeloggt waren, starten Sie die App neu.</div>
    <div class="error" id="errorBox"></div>
    <div class="loading" id="loadingBox">Bitte warten…</div>
    <div class="form">
      <input type="email" id="email" placeholder="E-Mail" autocomplete="username" />
      <input type="password" id="password" placeholder="Passwort" autocomplete="current-password" />
      <div class="row">
        <button id="loginBtn">Einloggen</button>
        <button id="signupBtn" class="secondary">Registrieren</button>
      </div>
      <p class="muted">Nach erfolgreichem Login werden Ihre Adressen nutzerspezifisch gespeichert und synchronisiert.</p>
    </div>
  </div>

  <script>
  const SUPABASE_URL = 'https://whigasnqcvjkilkmbfld.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndoaWdhc25xY3Zqa2lsa21iZmxkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyNDE1OTIsImV4cCI6MjA2OTgxNzU5Mn0.tfUnIP_oWy3N9UM6Ws9mPiKqsGtj8_kIOMW42E298rc';

  function getCapacitorStorage(){
    try{
      const P = (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.Preferences) || null;
      if (!P) return null;
      return {
        getItem: async (key) => { const r = await P.get({ key }); return (r && typeof r.value==='string') ? r.value : null; },
        setItem: async (key, value) => { await P.set({ key, value: String(value ?? '') }); },
        removeItem: async (key) => { await P.remove({ key }); }
      };
    }catch(e){ return null; }
  }
  const capStore2 = getCapacitorStorage();

  // Fallback auf Default-Storage, wenn Preferences nicht verfügbar sind
  const supabase = window.supa || window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: {
      persistSession: true,
      storage: capStore2 || undefined,
      autoRefreshToken: true,
      detectSessionInUrl: false
    }
  });

    const $ = (id) => document.getElementById(id);
    const isOnline = () => navigator.onLine;

    function storageKey(userId){ return userId ? `contacts:${userId}` : 'contacts'; }
    function getLocalContacts(userId){ try { return JSON.parse(localStorage.getItem(storageKey(userId))||'[]'); } catch { return []; } }
    function setLocalContacts(userId, c){ localStorage.setItem(storageKey(userId), JSON.stringify(c||[])); }

    function showError(msg){ const box = $('errorBox'); box.textContent = msg; box.style.display = 'block'; }
    function clearError(){ const box = $('errorBox'); box.textContent = ''; box.style.display = 'none'; }
    function setLoading(on){ $('loadingBox').style.display = on ? 'block' : 'none'; $('loginBtn').disabled = on; $('signupBtn').disabled = on; }

    async function getCloudContacts(){
      const { data, error } = await supabase.from('user_contacts').select('contacts').maybeSingle();
      if (error && error.code !== 'PGRST116') throw error;
      return (data && data.contacts) ? data.contacts : [];
    }

    async function uploadLocalToCloud(userId){
      const contacts = getLocalContacts(userId);
      const { error } = await supabase.from('user_contacts').upsert({ user_id: userId, contacts }, { onConflict: 'user_id' });
      if (error) throw error;
    }

    async function signIn(){
      clearError(); setLoading(true);
      try {
        if (!isOnline()) { $('offlineMsg').style.display='block'; setLoading(false); return; }
        const email = $('email').value.trim(); const password = $('password').value;
        if (!email || !password) { showError('Bitte E‑Mail und Passwort eingeben.'); return; }
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;
        await afterAuth();
      } catch(e){ showError(e.message || 'Login fehlgeschlagen'); }
      finally { setLoading(false); }
    }

    async function signUp(){
      clearError(); setLoading(true);
      try {
        if (!isOnline()) { $('offlineMsg').style.display='block'; setLoading(false); return; }
        const email = $('email').value.trim(); const password = $('password').value;
        if (!email || !password) { showError('Bitte E‑Mail und Passwort eingeben.'); return; }
        const { data, error } = await supabase.auth.signUp({ email, password });
        if (error) throw error;
        if (data.user && !data.session) {
          alert('Registrierung erfolgreich. Bitte E‑Mail bestätigen und anschließend einloggen.');
        } else {
          await afterAuth();
        }
      } catch(e){ showError(e.message || 'Registrierung fehlgeschlagen'); }
      finally { setLoading(false); }
    }

    async function afterAuth(){
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) { showError('Kein Nutzer gefunden.'); return; }

      // Offline-Nutzung ab jetzt erlaubt (nach erstem Login)
      localStorage.setItem('last_user_id', user.id);
      localStorage.setItem('offline_allowed', 'true');

      // Cloud <-> Lokal Sync beim ersten Login
      const cloud = await getCloudContacts();
      const local = getLocalContacts(user.id);
      if (local.length > 0 && cloud.length === 0) {
        const doUpload = confirm('Lokale Adressen gefunden. Jetzt in die Cloud hochladen?');
        if (doUpload) { await uploadLocalToCloud(user.id); }
      } else if (cloud.length > 0) {
        setLocalContacts(user.id, cloud);
      }

      window.location.href = './index.html';
    }

    $('loginBtn').addEventListener('click', signIn);
    $('signupBtn').addEventListener('click', signUp);
    $('email').addEventListener('keydown', e => { if (e.key === 'Enter') signIn(); });
    $('password').addEventListener('keydown', e => { if (e.key === 'Enter') signIn(); });

    // Bereits eingeloggt? Weiterleiten (nur online möglich)
    (async () => { 
      if (!isOnline()) { $('offlineMsg').style.display='block'; return; }
      const { data: { session } } = await supabase.auth.getSession(); 
      if (session) { window.location.href = './index.html'; } 
    })();
  </script>
</body>
</html>
