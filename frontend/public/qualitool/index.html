<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Qualifizierungs‚ÄëTool</title>

  <!-- Bibliotheken: defer => geladen, bevor DOMContentLoaded-Handler laufen -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>

  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#2563eb" />
  <link rel="icon" type="image/png" href="qt-logo.png" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <link rel="apple-touch-icon" href="qt-logo.png" />

  <style>
    :root {
      --bg:#f7f8fa; --surface:#fff; --text:#111827; --muted:#6b7280; --border:#e5e7eb;
      --accent:#2563eb; --accent-600:#1d4ed8; --accent-700:#1e40af;
      --shadow:0 2px 12px rgba(0,0,0,.06); --shadow-sm:0 1px 6px rgba(0,0,0,.06);
      --radius:10px;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',system-ui,-apple-system,sans-serif}
    body{background:var(--bg);color:var(--text);line-height:1.4}
    .page-layout{display:flex;min-height:100vh}
    .sidebar{width:58px;background:linear-gradient(180deg,var(--accent) 0%,var(--accent-700) 100%);color:#fff;position:fixed;top:0;bottom:0;left:0;z-index:10;padding:8px;border-right:1px solid rgba(255,255,255,.12)}
    .sidebar-nav{list-style:none;margin:8px 0;padding:0}
    .sidebar-nav li{margin:10px 0}
    .sidebar-nav a{display:flex;align-items:center;justify-content:center;color:#fff;text-decoration:none;padding:10px;border-radius:8px;transition:.2s}
    .sidebar-nav a:hover{background:rgba(255,255,255,.12);transform:translateY(-1px)}
    .sidebar-nav a.active{background:rgba(255,255,255,.22)}
    .sidebar-nav a svg{width:24px;height:24px}
    .main-content{flex:1;margin-left:58px;padding:16px}
    .container{max-width:1120px;margin:0 auto;background:var(--surface);border-radius:12px;box-shadow:var(--shadow);padding:16px;min-height:calc(100vh - 56px);display:flex;flex-direction:column}
    h1{margin:0 0 16px 0;font-size:1.7rem}
    h2,h3{color:#2563eb;margin:10px 0;font-weight:600}
    input,select,textarea{padding:8px 12px;border:1px solid var(--border);border-radius:6px;font-size:14px;background:#fafafa}
    input:focus,select:focus,textarea:focus{outline:none;border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.12);background:#fff}
    button{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:8px 14px;cursor:pointer;transition:.2s;box-shadow:var(--shadow-sm);font-weight:600}
    button:hover{background:var(--accent-600);transform:translateY(-1px)}
    .delete-all-btn{background:#ef4444}
    .import-section,.entry-section,.calendar-section,.statistics-section,.visit-recommendation-box{margin:10px 0;padding:15px;border-radius:10px;background:#fff;box-shadow:var(--shadow)}
    .import-content,.entry-content{display:none}
    .import-section.expanded .import-content,.entry-section.expanded .entry-content{display:block}
    .import-export-buttons{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-top:8px}
    .search-box{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    .status-filters{display:flex;gap:8px;flex-wrap:wrap;background:#fff;border-radius:8px;padding:8px;margin:10px 0}
    .street-filter-container{text-align:center;margin:10px 0;display:none}
    .street-filter{width:300px}
    .contact-list{flex:1;overflow:auto}
    .contact-card{background:#fff;border-radius:10px;box-shadow:var(--shadow-sm);padding:14px;margin:8px 0}
    .contact-info{display:grid;grid-template-columns:auto auto auto auto auto minmax(160px,1fr) minmax(140px,1fr);gap:8px 12px;align-items:center}
    .unit-info p{margin:2px 0}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000}
    .modal-content{background:#fff;margin:6% auto;max-width:860px;width:92%;border-radius:12px;padding:20px}
    #debugContent{background:#0b1020;color:#e5e7eb;border-radius:8px;padding:12px;font-size:12px;white-space:pre-wrap}
  </style>
</head>
<body>

<!-- Fr√ºh-Redirect zur Login-Seite falls kein Offline-Flag/kein letzter Nutzer -->
<script>
  (function(){
    try{
      var offlineAllowed = localStorage.getItem('offline_allowed') === 'true';
      var lastUser = localStorage.getItem('last_user_id');
      if (!offlineAllowed || !lastUser) window.location.replace('./login.html');
    }catch(_e){}
  })();

  // Shim: stellt sicher, dass window.manualDirectSyncNow existiert (wartet bis echte Implementierung registriert ist)
  (function(){
    if (typeof window.manualDirectSyncNow !== 'function') {
      window.__mdsn_impl = null;
      window.manualDirectSyncNow = async function(){
        for (let i=0;i<80;i++){
          if (typeof window.__mdsn_impl === 'function') return await window.__mdsn_impl();
          await new Promise(r=>setTimeout(r,100));
        }
        throw new Error('manualDirectSyncNow impl missing');
      };
    }
  })();
</script>

<div class="page-layout">
  <nav class="sidebar">
    <ul class="sidebar-nav">
      <li><a href="#contacts" data-section="contacts" class="active" title="Kontaktliste" onclick="return navTo('contacts')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
      </a></li>
      <li><a href="#import" data-section="import" title="Daten importieren" onclick="return navTo('import')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
      </a></li>
      <li><a href="#add" data-section="add" title="Neue Adresse hinzuf√ºgen" onclick="return navTo('add')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="9"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
      </a></li>
      <li><a href="#stats" data-section="stats" title="Statistik" onclick="return navTo('stats')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="4" height="10" rx="1"></rect><rect x="10" y="7" width="4" height="14" rx="1"></rect><rect x="17" y="3" width="4" height="18" rx="1"></rect></svg>
      </a></li>
      <li><a href="#calendar" data-section="calendar" title="Kalender" onclick="return navTo('calendar')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line><rect x="7" y="14" width="3" height="3" rx="0.5"></rect><rect x="12" y="14" width="3" height="3" rx="0.5"></rect></svg>
      </a></li>
      <li><a href="#recommendations" data-section="recommendations" title="Empfehlungen" onclick="return navTo('recommendations')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 6-9 12-9 12S3 16 3 10a9 9 0 1 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
      </a></li>
      <li><a href="#pdf-corrections" data-section="pdf-corrections" title="WE‚ÄëKorrekturen" onclick="return navTo('pdf-corrections')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><polyline points="8 14 12 18 16 14"></polyline></svg>
      </a></li>
      <li><a id="dbgNavItem" href="#" title="Sync/Debug">üîß</a></li>
    </ul>
  </nav>

  <div class="main-content">
    <div class="container">
      <h1>Qualifizierungs‚ÄëTool</h1>

      <!-- Import -->
      <div class="import-section collapsed">
        <h3 onclick="toggleImportSection()">Adressen importieren</h3>
        <div class="import-content">
          <p>Excel (XLSX/XLS) mit Spalten: PLZ, Ort, Stra√üe, Nr., Zusatz, WE</p>
          <div class="import-export-buttons">
            <input type="file" id="excelImport" accept=".xlsx,.xls" style="display:none" onchange="importFromExcel(this.files[0])" />
            <button onclick="document.getElementById('excelImport').click()">Excel importieren</button>
            <button onclick="exportToExcel()">Excel exportieren</button>
            <button onclick="exportToCSV()">CSV exportieren</button>
          </div>
        </div>
      </div>

      <!-- Neue Adresse -->
      <div class="entry-section collapsed">
        <h3 onclick="toggleEntrySection()">Adresse hinzuf√ºgen</h3>
        <div class="entry-content">
          <div class="tab-buttons" style="text-align:center;margin-bottom:10px;">
            <button id="singleBtn" class="active" onclick="showForm('single')">Einzelne Adresse</button>
            <button id="streetBtn" onclick="showForm('street')">Komplette Stra√üe</button>
          </div>
          <div id="singleEntry">
            <form id="contactForm" onsubmit="addContact(event)" style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center">
              <input type="text" id="plz" placeholder="PLZ" maxlength="5" required />
              <input type="text" id="ort" placeholder="Ort" required />
              <input type="text" id="strasse" placeholder="Stra√üe" required />
              <input type="text" id="nummer" placeholder="Nr." required />
              <input type="text" id="zusatz" placeholder="Zusatz" />
              <input type="text" id="we" placeholder="WE" />
              <button type="submit">Kontakt hinzuf√ºgen</button>
            </form>
          </div>
          <div id="streetEntry" style="display:none;">
            <form id="streetForm" onsubmit="addStreet(event)" style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center">
              <input type="text" id="street_plz" placeholder="PLZ" maxlength="5" required />
              <input type="text" id="street_ort" placeholder="Ort" required />
              <input type="text" id="street_strasse" placeholder="Stra√üe" required />
              <input type="number" id="street_start" placeholder="Hausnr. von" required />
              <input type="number" id="street_end" placeholder="Hausnr. bis" required />
              <button type="submit">Stra√üe hinzuf√ºgen</button>
            </form>
          </div>
        </div>
      </div>

      <!-- Suche/Filter -->
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="Kontakte durchsuchen..." onkeyup="applyFilters()" />
        <button class="delete-all-btn" onclick="deleteAllContacts()">Alle Adressen l√∂schen</button>
        <button class="delete-all-btn" onclick="showDeleteByPLZDialog()">Nach PLZ l√∂schen</button>
        <button class="delete-all-btn" onclick="showDeleteStreetDialog()">Nach Stra√üe l√∂schen</button>
      </div>

      <div class="status-filters">
        <button onclick="filterByStatus('all')" class="filter-btn active">Alle</button>
        <button onclick="filterByStatus('nicht-angetroffen')" class="filter-btn">Nicht angetroffen</button>
        <button onclick="filterByStatus('kein-eintritt')" class="filter-btn">Kein Eintritt pers√∂nlich</button>
        <button onclick="filterByStatus('wiedervorlage')" class="filter-btn">Wiedervorlage</button>
        <button onclick="filterByStatus('termin')" class="filter-btn">Termin</button>
        <button onclick="filterByStatus('beraten')" class="filter-btn">Bereits beraten</button>
        <button onclick="filterByStatus('kein-interesse')" class="filter-btn">Kein Interesse</button>
        <button onclick="filterByStatus('abschluss')" class="filter-btn">Abschluss</button>
        <button onclick="filterByStatus('onlineabschluss')" class="filter-btn">Online/TS</button>
        <button onclick="filterByStatus('abschl-anderer-vp')" class="filter-btn">Abschl. anderer VP</button>
      </div>

      <div class="street-filter-container">
        <select id="streetFilter" class="street-filter" onchange="applyFilters()">
          <option value="all">Alle Stra√üen</option>
        </select>
      </div>

      <!-- Liste -->
      <div id="contactList" class="contact-list"></div>

      <!-- Platzhalter f√ºr weitere Sektionen (optional) -->
      <div class="calendar-section" style="display:none"><h3>Aktivit√§ten‚ÄëKalender</h3><div id="calendar"></div></div>
      <div class="statistics-section" style="display:none"><h3>Statusauswertung</h3><div id="statsGrid"></div></div>
      <div class="visit-recommendation-box" style="display:none"><h3>Besuchsempfehlung</h3><div id="visitRecommendationContent"></div></div>
    </div>
  </div>
</div>

<!-- Delete Dialogs -->
<div id="deletePLZDialog" class="modal" aria-hidden="true">
  <div class="modal-content">
    <h3>Adressen nach PLZ l√∂schen</h3>
    <input type="text" id="plzToDelete" placeholder="PLZ" maxlength="5">
    <div style="text-align:right;margin-top:10px;">
      <button onclick="closeDeletePLZDialog()">Abbrechen</button>
      <button class="delete-all-btn" onclick="deleteByPLZ()">L√∂schen</button>
    </div>
  </div>
</div>

<div id="deleteStreetDialog" class="modal" aria-hidden="true">
  <div class="modal-content">
    <h3>Adressen nach Stra√üe l√∂schen</h3>
    <select id="streetToDelete" multiple style="width:100%;height:220px;margin:10px 0"></select>
    <div style="text-align:right;">
      <button onclick="closeDeleteStreetDialog()">Abbrechen</button>
      <button class="delete-all-btn" onclick="deleteByStreet()">L√∂schen</button>
    </div>
  </div>
</div>

<!-- Debug / Sync Panel -->
<div id="debugModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <h3>Sync / Debug</h3>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-bottom:8px;">
      <button id="dbgSessBtn">Session pr√ºfen</button>
      <button id="dbgSyncBtn">Jetzt synchronisieren</button>
      <button id="dbgRefreshBtn">Aktualisieren</button>
      <button id="dbgCopyBtn">In Zwischenablage</button>
      <button id="dbgClearBtn" class="delete-all-btn" style="background:#ef4444">Lokale Kontakte leeren</button>
      <button id="dbgClearSyncBtn" class="delete-all-btn" style="background:#b91c1c">Leeren + Sync</button>
      <button id="dbgCloseBtn" style="background:#111827">Schlie√üen</button>
    </div>
    <pre id="debugContent"></pre>
  </div>
</div>

<script>
  // DOM Helpers
  const $ = (sel)=>document.querySelector(sel);

  // Navigation / Sichtbarkeit
  function navTo(sectionId){
    try{
      document.querySelectorAll('.sidebar-nav a').forEach(a=>a.classList.remove('active'));
      const link = document.querySelector(`.sidebar-nav a[data-section="${sectionId}"]`);
      if (link) link.classList.add('active');

      const all = ['.import-section','.entry-section','.calendar-section','.statistics-section',
                   '.visit-recommendation-box','.search-box','.status-filters','#contactList','.street-filter-container'];
      all.forEach(sel=>{ const n=$(sel); if(n) n.style.display='none'; });

      if (sectionId==='contacts'){
        $('.search-box').style.display='flex';
        $('.status-filters').style.display='flex';
        $('#contactList').style.display='block';
        $('.street-filter-container').style.display='block';
      } else if (sectionId==='import'){
        const s=$('.import-section'); if(s){ s.style.display='block'; s.classList.add('expanded'); }
      } else if (sectionId==='add'){
        const s=$('.entry-section'); if(s){ s.style.display='block'; s.classList.add('expanded'); }
      } else if (sectionId==='stats'){
        const s=$('.statistics-section'); if(s){ s.style.display='block'; }
      } else if (sectionId==='calendar'){
        const s=$('.calendar-section'); if(s){ s.style.display='block'; }
      } else if (sectionId==='recommendations'){
        const s=$('.visit-recommendation-box'); if(s){ s.style.display='block'; }
      } else {
        $('#contactList').style.display='block';
        $('.street-filter-container').style.display='block';
      }
    }catch(_e){}
    return false;
  }

  function toggleImportSection(){ const s=document.querySelector('.import-section'); if(!s) return; s.classList.toggle('expanded'); s.style.display='block'; }
  function toggleEntrySection(){ const s=document.querySelector('.entry-section'); if(!s) return; s.classList.toggle('expanded'); s.style.display='block'; }
  function showForm(type){
    document.getElementById('singleEntry').style.display = type==='single' ? 'block' : 'none';
    document.getElementById('streetEntry').style.display = type==='street' ? 'block' : 'none';
    document.getElementById('singleBtn').classList.toggle('active', type==='single');
    document.getElementById('streetBtn').classList.toggle('active', type==='street');
  }

  // Kontakte lokal
  window.contacts = JSON.parse(localStorage.getItem('contacts')||'[]'); let contacts = window.contacts;

  function renderContacts(list=contacts){
    list = Array.isArray(list)? list : (contacts||[]);
    const el = $('#contactList'); el.innerHTML='';
    list.forEach(c=>{
      const div=document.createElement('div'); div.className='contact-card';
      const unitNames = (c.residents||[]).map((r,i)=>`<p>WE${(i+1)}: <strong>${(r?.name||'-')}</strong>${r?.mieter?' (M)':''}${r?.phone? ' üìû':''}</p>`).join('') || '<p>-</p>';
      const unitStatus = (c.residents||[]).map(r=>`<p>${(r?.status||'Kein Status')}</p>`).join('') || '<p>Kein Status</p>';
      div.innerHTML = `
        <div class="contact-info">
          <p>${c.plz||''}</p>
          <p>${c.ort||''}</p>
          <p>${c.strasse||''} ${c.nummer||''}</p>
          <p>${c.zusatz||''}</p>
          <p>${c.we? (c.we+' WE'):''}</p>
          <div class="unit-info">${unitNames}</div>
          <div class="unit-info">${unitStatus}</div>
        </div>`;
      el.appendChild(div);
    });
  }

  function updateStreetFilter(){
    const s = document.getElementById('streetFilter'); if (!s) return;
    while (s.options.length>1) s.remove(1);
    const set = new Set((contacts||[]).map(c=>c.strasse).filter(Boolean));
    [...set].sort().forEach(st=>{ const o=document.createElement('option'); o.value=st; o.textContent=st; s.appendChild(o); });
  }

  function saveContacts(){
    localStorage.setItem('contacts', JSON.stringify(contacts||[]));
    try{ enqueueContactsSnapshot(); flushSoon(); }catch(_e){}
    renderContacts(); updateStreetFilter();
  }

  function addContact(ev){
    ev.preventDefault();
    contacts.push({
      id: Date.now(),
      plz: document.getElementById('plz').value,
      ort: document.getElementById('ort').value,
      strasse: document.getElementById('strasse').value,
      nummer: document.getElementById('nummer').value,
      zusatz: document.getElementById('zusatz').value,
      we: document.getElementById('we').value,
      residents: []
    });
    saveContacts(); ev.target.reset();
  }

  function addStreet(ev){
    ev.preventDefault();
    const plz = document.getElementById('street_plz').value;
    const ort = document.getElementById('street_ort').value;
    const strasse = document.getElementById('street_strasse').value;
    const start = parseInt(document.getElementById('street_start').value);
    const end   = parseInt(document.getElementById('street_end').value);
    for(let n=start; n<=end; n++){
      contacts.push({ id: Date.now()+n, plz, ort, strasse, nummer:String(n), zusatz:'', we:'', residents:[] });
    }
    saveContacts(); ev.target.reset();
  }

  function deleteAllContacts(){
    if (!confirm('M√∂chten Sie wirklich alle Adressen l√∂schen?')) return;
    contacts = []; saveContacts();
  }

  function applyFilters(){
    const q = (document.getElementById('searchInput').value||'').toLowerCase();
    const stSel = document.getElementById('streetFilter').value;
    const list = (contacts||[]).filter(c=>{
      const inStreet = stSel==='all' || (c.strasse||'')===stSel;
      const txt = [c.plz,c.ort,c.strasse,c.nummer,c.zusatz,c.we].map(x=>(x||'').toString().toLowerCase()).join(' ');
      return inStreet && (q? txt.includes(q): true);
    });
    renderContacts(list);
  }

  // Delete Dialogs
  function showDeleteByPLZDialog(){ document.getElementById('deletePLZDialog').style.display='block';}
  function closeDeletePLZDialog(){ document.getElementById('deletePLZDialog').style.display='none';}
  function deleteByPLZ(){ const v=(document.getElementById('plzToDelete').value||'').trim(); if(!v) return; contacts=(contacts||[]).filter(c=>(c.plz||'')!==v); saveContacts(); closeDeletePLZDialog(); }
  function showDeleteStreetDialog(){
    const dlg = document.getElementById('deleteStreetDialog'); const sel = document.getElementById('streetToDelete'); sel.innerHTML='';
    const set = new Set((contacts||[]).map(c=>c.strasse).filter(Boolean)); [...set].sort().forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o); });
    dlg.style.display='block';
  }
  function closeDeleteStreetDialog(){ document.getElementById('deleteStreetDialog').style.display='none';}
  function deleteByStreet(){
    const sel = document.getElementById('streetToDelete'); const del = Array.from(sel.selectedOptions||[]).map(o=>o.value);
    if (!del.length) return; contacts = (contacts||[]).filter(c=>!del.includes(c.strasse||'')); saveContacts(); closeDeleteStreetDialog();
  }

  // Debug Panel
  function openDebug(){ document.getElementById('debugModal').style.display='block'; renderDebug(); }
  function closeDebug(){ document.getElementById('debugModal').style.display='none'; }
  function copyDebug(){ const t=document.getElementById('debugContent').textContent||''; if (navigator.clipboard) navigator.clipboard.writeText(t); }
  function setPanelStatus(m){ try{ const pre=document.getElementById('debugContent'); const d=JSON.parse(pre.textContent||'{}'); d.status=m; pre.textContent=JSON.stringify(d,null,2);}catch(_e){} }
  function safeParse(s){ try{return JSON.parse(s||'null');}catch(_e){return null;} }
  async function renderDebug(){
    const info={}; info.now=new Date().toISOString(); info.online=navigator.onLine;
    try{ const sb=await getClient(); const {data:{user}}=await sb.auth.getUser(); info.userId=user?.id||null; }catch(_e){ info.userId=null; }
    try{ const cs=JSON.parse(localStorage.getItem('contacts')||'[]'); info.contacts_count=Array.isArray(cs)?cs.length:0; }catch(_e){ info.contacts_count='err'; }
    info.last_sync_try=safeParse(localStorage.getItem('qt_last_sync_try'));
    info.last_event_err=safeParse(localStorage.getItem('qt_last_event_err'));
    const q = safeParse(localStorage.getItem('qt_sync_queue_v1'))||[]; info.queue_total=Array.isArray(q)?q.length:0;
    document.getElementById('debugContent').textContent=JSON.stringify(info,null,2);
  }
  document.getElementById('dbgNavItem').addEventListener('click',e=>{e.preventDefault();openDebug();});
  document.getElementById('dbgCloseBtn').addEventListener('click',e=>{e.preventDefault();closeDebug();});
  document.getElementById('dbgCopyBtn').addEventListener('click',e=>{e.preventDefault();copyDebug();});
  document.getElementById('dbgRefreshBtn').addEventListener('click',e=>{e.preventDefault();renderDebug();});
  document.getElementById('dbgSessBtn').addEventListener('click',async e=>{
    e.preventDefault();
    try{ const sb=await getClient(); const {data:{user}}=await sb.auth.getUser(); setPanelStatus(user?('session ok '+user.id):'keine Session'); }catch(err){ setPanelStatus('session fehler: '+(err?.message||err)); }
    renderDebug();
  });
  document.getElementById('dbgSyncBtn').addEventListener('click',async e=>{
    e.preventDefault();
    try{
      setPanelStatus('start');
      const fn = (window && typeof window.manualDirectSyncNow==='function')? window.manualDirectSyncNow : null;
      if (!fn) throw new Error('manualDirectSyncNow not available on window');
      const ok = await fn();
      setPanelStatus(ok?'events_ok':'failed');
    }catch(err){ setPanelStatus('error: '+(err?.message||err)); }
    renderDebug();
  });
  document.getElementById('dbgClearBtn').addEventListener('click',e=>{
    e.preventDefault();
    try{ localStorage.removeItem('contacts'); const uid=localStorage.getItem('last_user_id'); if(uid) localStorage.removeItem('contacts:'+uid); localStorage.removeItem('qt_last_contacts_hash'); }catch(_e){}
    renderDebug(); alert('Lokale Kontakte geleert.');
  });
  document.getElementById('dbgClearSyncBtn').addEventListener('click',async e=>{
    e.preventDefault();
    try{ localStorage.removeItem('contacts'); const uid=localStorage.getItem('last_user_id'); if(uid) localStorage.removeItem('contacts:'+uid); localStorage.removeItem('qt_last_contacts_hash'); }catch(_e){}
    try{ await window.manualDirectSyncNow(); }catch(_e){}
    renderDebug(); alert('Leeren + Sync ausgef√ºhrt.');
  });

  // Supabase‚ÄëClient mit Capacitor Preferences (persistente Session) ‚Äì Fallback erlaubt
  const SUPABASE_URL = 'https://whigasnqcvjkilkmbfld.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndoaWdhc25xY3Zqa2lsa21iZmxkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyNDE1OTIsImV4cCI6MjA2OTgxNzU5Mn0.tfUnIP_oWy3N9UM6Ws9mPiKqsGtj8_kIOMW42E298rc';

  function getCapacitorStorage(){
    try{
      const P=(window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.Preferences) || null;
      if (!P) return null;
      return {
        getItem: async (key)=>{ const r=await P.get({key}); return (r && typeof r.value==='string')? r.value:null; },
        setItem: async (key,val)=>{ await P.set({key, value:String(val??'')}); },
        removeItem: async (key)=>{ await P.remove({key}); }
      };
    }catch(_e){ return null; }
  }
  function sleep(ms){return new Promise(r=>setTimeout(r,ms));}
  async function awaitSupabase(maxMs=15000){
    const t0=Date.now();
    while(!(window.supabase && typeof window.supabase.createClient==='function')){
      if (Date.now()-t0>maxMs) throw new Error('Supabase SDK nicht geladen');
      await sleep(100);
    }
    return window.supabase;
  }
  let supa=null;
  async function getClient(){
    if (supa) return supa;
    const lib=await awaitSupabase();
    const capStore=getCapacitorStorage();
    supa = lib.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{ persistSession:true, storage:capStore||undefined, autoRefreshToken:true, detectSessionInUrl:false } });
    window.supa = supa;
    return supa;
  }

  // Direkter Sync (RPC ‚Üí Fallback Upsert) ‚Äì echte Implementierung
  async function manualDirectSyncNow(){
    try{ window.__mdsn_impl = manualDirectSyncNow; window.manualDirectSyncNow = manualDirectSyncNow; }catch(_e){}

    const setTry=(s,extra)=>{ try{ localStorage.setItem('qt_last_sync_try', JSON.stringify(Object.assign({t:Date.now(),stage:s},extra||{}))); }catch(_e){} };
    const setErr=(s,msg)=>{ try{ localStorage.setItem('qt_last_event_err', JSON.stringify({t:Date.now(),stage:s,msg:String(msg||'')})); }catch(_e){} };

    try{
      setTry('start');
      const sb = await getClient();
      setTry('client_ready');

      const {data:{user}} = await sb.auth.getUser();
      if (!user) throw new Error('Keine Session vorhanden');
      setTry('got_user', { user:{id:user.id} });

      let snapshot=[]; try{ snapshot=JSON.parse(localStorage.getItem('contacts')||'[]'); }catch(_e){ snapshot=[]; }
      if (!Array.isArray(snapshot)) snapshot=[];
      setTry('snapshot_ready',{count:snapshot.length});

      try{
        const { error } = await sb.rpc('fn_public_upsert_user_contacts', { p_contacts:snapshot });
        if (error) throw error;
      }catch(e1){
        setTry('rpc_upsert_failed',{err:String(e1?.message||e1)});
        const { error:e2 } = await sb.from('user_contacts').upsert({ user_id:user.id, contacts:snapshot }, { onConflict:'user_id' });
        if (e2) throw e2;
      }
      setTry('upsert_ok');

      const { error:e3 } = await sb.rpc('fn_log_events_from_contacts_snapshot', { p_user_id:user.id, p_contacts:snapshot });
      if (e3) throw e3;
      setTry('events_ok');
      try{ localStorage.removeItem('qt_last_event_err'); }catch(_e){}
      return true;
    }catch(err){
      setErr('manual_direct_sync', err?.message||err);
      return false;
    }
  }
  // globale Registrierung sicherstellen
  try{ window.__mdsn_impl = manualDirectSyncNow; window.manualDirectSyncNow = manualDirectSyncNow; }catch(_e){}

  // Minimal-Queue (Platzhalter, damit bestehende Hooks keine Fehler werfen)
  function enqueueContactsSnapshot(){ /* optional */ }
  function flushSoon(){ /* optional */ }

  // Initial UI
  window.addEventListener('DOMContentLoaded', ()=>{
    navTo('contacts'); renderContacts(); updateStreetFilter();
  });
</script>

</body>
</html>
