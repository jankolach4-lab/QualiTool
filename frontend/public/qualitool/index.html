<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Qualifizierungs-Tool</title>

  <!-- Supabase SDK und XLSX (defer, damit DOM + Reihenfolge sauber bleiben) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2563eb">
  <link rel="icon" type="image/png" href="qt-logo.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="qt-logo.png">

  <style>
    :root {
      --bg:#f7f8fa; --surface:#fff; --text:#111827; --muted:#6b7280; --border:#e5e7eb;
      --accent:#2563eb; --accent-600:#1d4ed8; --accent-700:#1e40af;
      --shadow:0 2px 12px rgba(0,0,0,.06); --shadow-sm:0 1px 6px rgba(0,0,0,.06);
      --radius:10px;
    }
    *{box-sizing:border-box;font-family:'Segoe UI',system-ui,-apple-system,sans-serif}
    body{margin:0;background:var(--bg);color:var(--text);line-height:1.4}
    .page-layout{display:flex;min-height:100vh}
    .sidebar{width:58px;background:linear-gradient(180deg,var(--accent) 0%,var(--accent-700) 100%);
      color:#fff;position:fixed;top:0;bottom:0;left:0;z-index:10;padding:8px}
    .sidebar-nav{list-style:none;margin:8px 0;padding:0}
    .sidebar-nav li{margin:8px 0}
    .sidebar-nav a{display:flex;align-items:center;justify-content:center;color:#fff;text-decoration:none;
      padding:10px;border-radius:8px;transition:.2s}
    .sidebar-nav a:hover{background:rgba(255,255,255,.12);transform:translateY(-1px)}
    .sidebar-nav a.active{background:rgba(255,255,255,.22)}
    .main-content{flex:1;margin-left:58px;padding:16px}
    .container{max-width:1120px;margin:0 auto;background:var(--surface);border-radius:12px;box-shadow:var(--shadow);
      padding:16px;min-height:calc(100vh - 56px);display:flex;flex-direction:column}
    h1{margin:0 0 12px 0;font-size:1.6rem}
    h2,h3{color:#2563eb;margin:10px 0;font-weight:600}
    .import-section,.entry-section,.calendar-section,.statistics-section,.visit-recommendation-box{margin:10px 0;padding:14px;border-radius:10px;background:#fff;box-shadow:var(--shadow)}
    .import-content,.entry-content{display:none}
    .expanded .import-content,.expanded .entry-content{display:block}
    .import-export-buttons{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;margin-top:10px}
    .search-box{display:flex;flex-wrap:wrap;gap:10px;margin:10px 0}
    .status-filters{display:flex;flex-wrap:wrap;gap:8px;background:#fff;border-radius:8px;padding:8px;margin:10px 0}
    .contact-list{flex:1;overflow:auto}
    .contact-card{background:#fff;margin:8px 0;padding:12px;border-radius:10px;box-shadow:var(--shadow-sm)}
    .unit-info p{margin:2px 0}
    button{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:8px 14px;cursor:pointer;transition:.2s;box-shadow:var(--shadow-sm)}
    button:hover{background:var(--accent-600);transform:translateY(-1px)}
    .delete-all-btn{background:#ef4444}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000}
    .modal-content{background:#fff;margin:6% auto;max-width:860px;width:92%;border-radius:12px;padding:20px}
    #debugContent{background:#0b1020;color:#e5e7eb;border-radius:8px;padding:12px;font-size:12px;white-space:pre-wrap}
    .street-filter-container{display:none;text-align:center;margin:10px 0}
    .street-filter{width:300px;padding:8px;border:1px solid var(--border);border-radius:6px}
  </style>
</head>
<body>

<script>
  // Fr√ºh-Redirect zur Login-Seite, wenn kein Offline-Flag/kein letzter Nutzer
  (function(){
    try{
      var offlineAllowed = localStorage.getItem('offline_allowed') === 'true';
      var lastUser = localStorage.getItem('last_user_id');
      if (!offlineAllowed || !lastUser) {
        window.location.replace('./login.html');
      }
    }catch(_e){}
  })();

  // Robuster globaler Shim: stellt sicher, dass window.manualDirectSyncNow existiert.
  // Falls die echte Implementierung sp√§ter l√§dt, wartet der Shim bis zu 8s darauf.
  (function(){
    if (typeof window.manualDirectSyncNow !== 'function') {
      window.__mdsn_impl = null;
      window.manualDirectSyncNow = async function(){
        for (let i=0;i<80;i++){
          if (typeof window.__mdsn_impl === 'function') {
            return await window.__mdsn_impl();
          }
          await new Promise(r=>setTimeout(r,100));
        }
        throw new Error('manualDirectSyncNow impl missing');
      };
    }
  })();
</script>

<div class="page-layout">
  <nav class="sidebar">
    <ul class="sidebar-nav">
      <li><a href="#contacts" data-section="contacts" class="active" onclick="return navTo('contacts')" title="Kontaktliste">üìã</a></li>
      <li><a href="#import" data-section="import" onclick="return navTo('import')" title="Import">‚¨ÜÔ∏è</a></li>
      <li><a href="#add" data-section="add" onclick="return navTo('add')" title="Adresse hinzuf√ºgen">‚ûï</a></li>
      <li><a href="#stats" data-section="stats" onclick="return navTo('stats')" title="Statistik">üìä</a></li>
      <li><a href="#calendar" data-section="calendar" onclick="return navTo('calendar')" title="Kalender">üìÖ</a></li>
      <li><a href="#recommendations" data-section="recommendations" onclick="return navTo('recommendations')" title="Empfehlungen">‚≠ê</a></li>
      <li><a href="#pdf-corrections" data-section="pdf-corrections" onclick="return navTo('pdf-corrections')" title="WE‚ÄëKorrekturen">üìù</a></li>
      <li><a id="dbgNavItem" href="#" title="Sync/Debug">üîß</a></li>
    </ul>
  </nav>

  <div class="main-content">
    <div class="container">
      <h1>Qualifizierungs‚ÄëTool</h1>

      <div class="import-section">
        <h3 onclick="toggleImportSection()">Adressen importieren</h3>
        <div class="import-content">
          <p>Unterst√ºtztes Format: Excel (XLSX/XLS) mit Spalten: PLZ, Ort, Stra√üe, Nr., Zusatz, WE</p>
          <div class="import-export-buttons">
            <input type="file" id="excelImport" accept=".xlsx,.xls" style="display:none" onchange="importFromExcel(this.files[0])" />
            <button onclick="document.getElementById('excelImport').click()">Excel importieren</button>
            <button onclick="exportToExcel()">Excel exportieren</button>
            <button onclick="exportToCSV()">CSV exportieren</button>
          </div>
        </div>
      </div>

      <div class="entry-section">
        <h3 onclick="toggleEntrySection()">Adresse hinzuf√ºgen</h3>
        <div class="entry-content">
          <form id="contactForm" onsubmit="addContact(event)">
            <input type="text" id="plz" placeholder="PLZ" maxlength="5" required />
            <input type="text" id="ort" placeholder="Ort" required />
            <input type="text" id="strasse" placeholder="Stra√üe" required />
            <input type="text" id="nummer" placeholder="Nr." required />
            <input type="text" id="zusatz" placeholder="Zusatz" />
            <input type="text" id="we" placeholder="WE" />
            <button type="submit">Kontakt hinzuf√ºgen</button>
          </form>
        </div>
      </div>

      <div class="search-box">
        <input type="text" id="searchInput" placeholder="Kontakte durchsuchen..." onkeyup="applyFilters()" />
        <button class="delete-all-btn" onclick="deleteAllContacts()">Alle Adressen l√∂schen</button>
        <button class="delete-all-btn" onclick="showDeleteByPLZDialog()">Nach PLZ l√∂schen</button>
        <button class="delete-all-btn" onclick="showDeleteStreetDialog()">Nach Stra√üe l√∂schen</button>
      </div>

      <div class="status-filters">
        <button onclick="filterByStatus('all')" class="filter-btn active">Alle</button>
        <button onclick="filterByStatus('nicht-angetroffen')" class="filter-btn">Nicht angetroffen</button>
        <button onclick="filterByStatus('kein-eintritt')" class="filter-btn">Kein Eintritt pers√∂nlich</button>
        <button onclick="filterByStatus('wiedervorlage')" class="filter-btn">Wiedervorlage</button>
        <button onclick="filterByStatus('termin')" class="filter-btn">Termin</button>
        <button onclick="filterByStatus('beraten')" class="filter-btn">Bereits beraten</button>
        <button onclick="filterByStatus('kein-interesse')" class="filter-btn">Kein Interesse</button>
        <button onclick="filterByStatus('abschluss')" class="filter-btn">Abschluss</button>
        <button onclick="filterByStatus('onlineabschluss')" class="filter-btn">Online/TS</button>
        <button onclick="filterByStatus('abschl-anderer-vp')" class="filter-btn">Abschl. anderer VP</button>
      </div>

      <div class="street-filter-container">
        <select id="streetFilter" class="street-filter" onchange="applyFilters()">
          <option value="all">Alle Stra√üen</option>
        </select>
      </div>

      <div id="contactList" class="contact-list"></div>

      <!-- Platzhalter weitere Sektionen (optional ein/ausklappbar) -->
      <div class="calendar-section" style="display:none"><h3>Aktivit√§ten‚ÄëKalender</h3><div id="calendar"></div></div>
      <div class="statistics-section" style="display:none"><h3>Statusauswertung</h3><div id="statsGrid"></div></div>
      <div class="visit-recommendation-box" style="display:none"><h3>Besuchsempfehlung</h3><div id="visitRecommendationContent"></div></div>
    </div>
  </div>
</div>

<!-- Modals -->
<div id="deletePLZDialog" class="modal">
  <div class="modal-content">
    <h3>Adressen nach PLZ l√∂schen</h3>
    <input type="text" id="plzToDelete" placeholder="PLZ" maxlength="5">
    <div style="text-align:right;margin-top:10px;">
      <button onclick="closeDeletePLZDialog()">Abbrechen</button>
      <button class="delete-all-btn" onclick="deleteByPLZ()">L√∂schen</button>
    </div>
  </div>
</div>

<div id="deleteStreetDialog" class="modal">
  <div class="modal-content">
    <h3>Adressen nach Stra√üe l√∂schen</h3>
    <select id="streetToDelete" multiple style="width:100%;height:220px;margin:10px 0"></select>
    <div style="text-align:right;">
      <button onclick="closeDeleteStreetDialog()">Abbrechen</button>
      <button class="delete-all-btn" onclick="deleteByStreet()">L√∂schen</button>
    </div>
  </div>
</div>

<!-- Sichtbares Sync/Debug Panel -->
<div id="debugModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <h3>Sync / Debug</h3>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-bottom:8px;">
      <button id="dbgSessBtn">Session pr√ºfen</button>
      <button id="dbgSyncBtn">Jetzt synchronisieren</button>
      <button id="dbgRefreshBtn">Aktualisieren</button>
      <button id="dbgCopyBtn">In Zwischenablage</button>
      <button id="dbgClearBtn" class="delete-all-btn" style="background:#ef4444">Lokale Kontakte leeren</button>
      <button id="dbgClearSyncBtn" class="delete-all-btn" style="background:#b91c1c">Leeren + Sync</button>
      <button id="dbgCloseBtn" style="background:#111827">Schlie√üen</button>
    </div>
    <pre id="debugContent"></pre>
  </div>
</div>

<script>
  // Navigation/Ansichten
  function navTo(sectionId){
    try{
      document.querySelectorAll('.sidebar-nav a').forEach(a=>a.classList.remove('active'));
      const link = document.querySelector(`.sidebar-nav a[data-section="${sectionId}"]`);
      if (link) link.classList.add('active');

      const showMap = {
        contacts: ['.search-box','.status-filters','#contactList','.street-filter-container'],
        import:   ['.import-section'],
        add:      ['.entry-section'],
        stats:    ['.statistics-section'],
        calendar: ['.calendar-section'],
        recommendations: ['.visit-recommendation-box'],
        'pdf-corrections': []
      };
      const all = ['.import-section','.entry-section','.statistics-section','.calendar-section',
                   '.visit-recommendation-box','.search-box','.status-filters','#contactList','.street-filter-container'];
      all.forEach(sel => { const n=document.querySelector(sel); if(n) n.style.display='none';});
      (showMap[sectionId]||['#contactList','.street-filter-container']).forEach(sel=>{
        const n=document.querySelector(sel); if(n) n.style.display = (sel==='#contactList')?'block':'flex';
      });
    }catch(_e){}
    return false;
  }
  document.getElementById('dbgNavItem').addEventListener('click',e=>{e.preventDefault();openDebug();});

  // Kontakte (lokal)
  window.contacts = JSON.parse(localStorage.getItem('contacts')||'[]');
  let contacts = window.contacts;
  let currentFilter = 'all';

  function updateStreetFilter(){
    const streetFilter = document.getElementById('streetFilter');
    if (!streetFilter) return;
    const set = new Set((contacts||[]).map(c=>c.strasse).filter(Boolean));
    while(streetFilter.options.length>1) streetFilter.remove(1);
    [...set].sort().forEach(st=>{
      const opt=document.createElement('option'); opt.value=st; opt.textContent=st;
      streetFilter.appendChild(opt);
    });
  }

  function saveContacts(){
    localStorage.setItem('contacts', JSON.stringify(contacts||[]));
    try{ enqueueContactsSnapshot(); flushSoon(); }catch(_e){}
    renderContacts();
    updateStreetFilter();
  }

  function addContact(ev){
    ev.preventDefault();
    const c = {
      id: Date.now(),
      plz: document.getElementById('plz').value,
      ort: document.getElementById('ort').value,
      strasse: document.getElementById('strasse').value,
      nummer: document.getElementById('nummer').value,
      zusatz: document.getElementById('zusatz').value,
      we: document.getElementById('we').value,
      residents: []
    };
    contacts.push(c);
    saveContacts();
    ev.target.reset();
  }

  function deleteAllContacts(){
    if (!confirm('Alle Adressen l√∂schen?')) return;
    contacts = [];
    saveContacts();
  }

  function applyFilters(){
    const q = (document.getElementById('searchInput').value||'').toLowerCase();
    const selectedStreet = document.getElementById('streetFilter').value;
    const list = (contacts||[]).filter(c=>{
      const inStreet = selectedStreet==='all' || (c.strasse||'')===selectedStreet;
      const txt = [c.plz,c.ort,c.strasse,c.nummer,c.zusatz,c.we].map(x=>(x||'').toString().toLowerCase()).join(' ');
      return inStreet && (q? txt.includes(q): true);
    });
    renderContacts(list);
  }

  function renderContacts(list){
    list = Array.isArray(list)? list : (contacts||[]);
    const el = document.getElementById('contactList');
    el.innerHTML = '';
    list.forEach(c=>{
      const div = document.createElement('div');
      div.className = 'contact-card';
      div.innerHTML = `
        <div class="contact-info">
          <p>${c.plz||''}</p>
          <p>${c.ort||''}</p>
          <p>${c.strasse||''} ${c.nummer||''}</p>
          <p>${c.zusatz||''}</p>
          <p>${c.we? (c.we+' WE'): ''}</p>
        </div>
      `;
      el.appendChild(div);
    });
  }

  // Excel Import/Export
  function importFromExcel(file){
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e){
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, {type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, {header:1});
      for(let i=1;i<rows.length;i++){
        const r = rows[i]; if (!r || !r.length) continue;
        contacts.push({
          id: Date.now()+i,
          plz: (r[0]||'').toString(),
          ort: (r[1]||'').toString(),
          strasse: (r[2]||'').toString(),
          nummer: (r[3]||'').toString(),
          zusatz: (r[4]||'').toString(),
          we: (r[5]||'').toString(),
          residents: []
        });
      }
      saveContacts();
      alert('Import abgeschlossen: '+Math.max(0, rows.length-1)+' Adressen');
    };
    reader.readAsArrayBuffer(file);
  }

  function exportToCSV(){
    const rows = [['PLZ','Ort','Stra√üe','Nr.','Zusatz','WE']].concat(
      (contacts||[]).map(c=>[c.plz||'',c.ort||'',c.strasse||'',c.nummer||'',c.zusatz||'',c.we||''])
    );
    const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(';')).join('\n');
    const uri = 'data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
    const a = document.createElement('a'); a.href=uri; a.download='kontakte.csv'; a.click();
  }

  function exportToExcel(){
    const ws = XLSX.utils.aoa_to_sheet([['PLZ','Ort','Stra√üe','Nr.','Zusatz','WE']]);
    (contacts||[]).forEach(c=>XLSX.utils.sheet_add_aoa(ws, [[c.plz||'',c.ort||'',c.strasse||'',c.nummer||'',c.zusatz||'',c.we||'']], {origin:-1}));
    const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Kontakte'); XLSX.writeFile(wb, 'kontakte.xlsx');
  }

  // Delete Dialogs
  function showDeleteByPLZDialog(){ document.getElementById('deletePLZDialog').style.display='block';}
  function closeDeletePLZDialog(){ document.getElementById('deletePLZDialog').style.display='none';}
  function deleteByPLZ(){
    const plz = (document.getElementById('plzToDelete').value||'').trim();
    if (!plz) return;
    contacts = (contacts||[]).filter(c=>(c.plz||'')!==plz);
    saveContacts(); closeDeletePLZDialog();
  }
  function showDeleteStreetDialog(){
    const dlg = document.getElementById('deleteStreetDialog'); const sel = document.getElementById('streetToDelete');
    sel.innerHTML=''; const set = new Set((contacts||[]).map(c=>c.strasse).filter(Boolean)); [...set].sort().forEach(s=>{
      const o=document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o);
    });
    dlg.style.display='block';
  }
  function closeDeleteStreetDialog(){ document.getElementById('deleteStreetDialog').style.display='none';}
  function deleteByStreet(){
    const sel = document.getElementById('streetToDelete');
    const toDel = Array.from(sel.selectedOptions||[]).map(o=>o.value);
    if (!toDel.length) return;
    contacts = (contacts||[]).filter(c=>!toDel.includes(c.strasse||''));
    saveContacts(); closeDeleteStreetDialog();
  }

  // Debug Panel
  function openDebug(){ document.getElementById('debugModal').style.display='block'; renderDebug(); }
  function closeDebug(){ document.getElementById('debugModal').style.display='none'; }
  function copyDebug(){
    const txt = document.getElementById('debugContent').textContent||'';
    if (navigator.clipboard) navigator.clipboard.writeText(txt);
  }
  function setPanelStatus(msg){
    try{ const pre=document.getElementById('debugContent'); const data=JSON.parse(pre.textContent||'{}'); data.status=msg; pre.textContent=JSON.stringify(data,null,2); }catch(_e){}
  }
  function safeParse(s){ try{return JSON.parse(s||'null');}catch(_e){return null;} }
  async function renderDebug(){
    const info={};
    info.now=new Date().toISOString();
    info.online=navigator.onLine;
    try{
      const sb = await getClient();
      const {data:{user}} = await sb.auth.getUser();
      info.userId = user?.id || null;
    }catch(_e){ info.userId = null; }
    try{ const cs=JSON.parse(localStorage.getItem('contacts')||'[]'); info.contacts_count=Array.isArray(cs)?cs.length:0; }catch(_e){ info.contacts_count='err'; }
    info.last_sync_try=safeParse(localStorage.getItem('qt_last_sync_try'));
    info.last_event_err=safeParse(localStorage.getItem('qt_last_event_err'));
    const q = safeParse(localStorage.getItem('qt_sync_queue_v1'))||[];
    info.queue_total=Array.isArray(q)?q.length:0;
    document.getElementById('debugContent').textContent=JSON.stringify(info,null,2);
  }
  document.getElementById('dbgCloseBtn').addEventListener('click', e=>{e.preventDefault();closeDebug();});
  document.getElementById('dbgCopyBtn').addEventListener('click', e=>{e.preventDefault();copyDebug();});
  document.getElementById('dbgRefreshBtn').addEventListener('click', e=>{e.preventDefault();renderDebug();});
  document.getElementById('dbgSessBtn').addEventListener('click', async e=>{
    e.preventDefault();
    try{ const sb=await getClient(); const {data:{user}}=await sb.auth.getUser(); setPanelStatus(user?('session ok '+user.id):'keine Session'); }catch(err){ setPanelStatus('session fehler: '+(err?.message||err)); }
    renderDebug();
  });
  document.getElementById('dbgSyncBtn').addEventListener('click', async e=>{
    e.preventDefault();
    try{
      setPanelStatus('start');
      const fn = (window && typeof window.manualDirectSyncNow==='function')? window.manualDirectSyncNow : null;
      if (!fn) throw new Error('manualDirectSyncNow not available on window');
      const ok = await fn();
      setPanelStatus(ok?'events_ok':'failed');
    }catch(err){ setPanelStatus('error: '+(err?.message||err)); }
    renderDebug();
  });
  function clearLocalContacts(){
    try{
      localStorage.removeItem('contacts');
      const uid = localStorage.getItem('last_user_id'); if (uid) localStorage.removeItem('contacts:'+uid);
      localStorage.removeItem('qt_last_contacts_hash');
    }catch(_e){}
  }
  document.getElementById('dbgClearBtn').addEventListener('click', e=>{e.preventDefault(); clearLocalContacts(); renderDebug(); alert('Lokale Kontakte geleert.'); });
  document.getElementById('dbgClearSyncBtn').addEventListener('click', async e=>{
    e.preventDefault(); clearLocalContacts(); try{ await window.manualDirectSyncNow(); }catch(_e){}; renderDebug(); alert('Leeren + Sync ausgef√ºhrt.'); 
  });

  // Supabase-Client (persistente Session mit Capacitor Preferences, Fallback m√∂glich)
  const SUPABASE_URL = 'https://whigasnqcvjkilkmbfld.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndoaWdhc25xY3Zqa2lsa21iZmxkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyNDE1OTIsImV4cCI6MjA2OTgxNzU5Mn0.tfUnIP_oWy3N9UM6Ws9mPiKqsGtj8_kIOMW42E298rc';

  function getCapacitorStorage(){
    try{
      const P = (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins.Preferences) || null;
      if (!P) return null;
      return {
        getItem: async (key)=>{ const r = await P.get({key}); return (r && typeof r.value==='string')? r.value : null; },
        setItem: async (key,val)=>{ await P.set({key, value:String(val??'')}); },
        removeItem: async (key)=>{ await P.remove({key}); }
      };
    }catch(_e){ return null; }
  }
  function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
  async function awaitSupabase(maxMs=15000){
    const t0=Date.now();
    while(!(window.supabase && typeof window.supabase.createClient==='function')){
      if (Date.now()-t0>maxMs) throw new Error('Supabase SDK nicht geladen');
      await sleep(100);
    }
    return window.supabase;
  }
  let supa = null;
  async function getClient(){
    if (supa) return supa;
    const lib = await awaitSupabase();
    const capStore = getCapacitorStorage();
    supa = lib.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession:true, storage:capStore||undefined, autoRefreshToken:true, detectSessionInUrl:false }
    });
    window.supa = supa;
    return supa;
  }

  // Direkter Sync (RPC ‚Üí Fallback Upsert) ‚Äì echte Implementierung
  async function manualDirectSyncNow(){
    // Registrierung der echten Implementierung (√ºberschreibt den Shim)
    try{ window.__mdsn_impl = manualDirectSyncNow; window.manualDirectSyncNow = manualDirectSyncNow; }catch(_e){}

    const setTry=(s,extra)=>{ try{ localStorage.setItem('qt_last_sync_try', JSON.stringify(Object.assign({t:Date.now(),stage:s},extra||{}))); }catch(_e){} };
    const setErr=(s,msg)=>{ try{ localStorage.setItem('qt_last_event_err', JSON.stringify({t:Date.now(),stage:s,msg:String(msg||'')})); }catch(_e){} };

    try{
      setTry('start');

      const sb = await getClient();
      setTry('client_ready');

      const {data:{user}} = await sb.auth.getUser();
      if (!user) throw new Error('Keine Session vorhanden');
      setTry('got_user',{user:{id:user.id}});

      let snapshot = [];
      try{ snapshot = JSON.parse(localStorage.getItem('contacts')||'[]'); }catch(_e){ snapshot=[]; }
      if (!Array.isArray(snapshot)) snapshot=[];
      setTry('snapshot_ready',{count:snapshot.length});

      // 1) RPC (empfohlen)
      try{
        const { error } = await sb.rpc('fn_public_upsert_user_contacts', { p_contacts: snapshot });
        if (error) throw error;
      }catch(e1){
        setTry('rpc_upsert_failed',{err:String(e1?.message||e1)});
        // 2) Fallback Tabellen-Upsert
        const { error:e2 } = await sb.from('user_contacts').upsert({ user_id:user.id, contacts:snapshot }, { onConflict:'user_id' });
        if (e2) throw e2;
      }
      setTry('upsert_ok');

      // Events aus Snapshot erzeugen
      const { error:e3 } = await sb.rpc('fn_log_events_from_contacts_snapshot', { p_user_id:user.id, p_contacts:snapshot });
      if (e3) throw e3;
      setTry('events_ok');
      try{ localStorage.removeItem('qt_last_event_err'); }catch(_e){}

      return true;
    }catch(err){
      setErr('manual_direct_sync', err?.message||err);
      return false;
    }
  }
  // Sicherstellen, dass die Implementierung direkt global verf√ºgbar ist
  try{ window.__mdsn_impl = manualDirectSyncNow; window.manualDirectSyncNow = manualDirectSyncNow; }catch(_e){}

  // Minimale Queue-API (Platzhalter, damit saveContacts() keine Fehler wirft)
  function enqueueContactsSnapshot(){ try{ /* optional: queue */ }catch(_e){} }
  function flushSoon(){ try{ /* optional */ }catch(_e){} }

  // UI-Events initialisieren
  window.addEventListener('DOMContentLoaded', ()=>{
    // Start in die Kontaktansicht
    navTo('contacts');
    updateStreetFilter();
    renderContacts();
  });
</script>

<!-- Robuste, eigenst√§ndige Fallback-Implementierung ganz am Ende (falls oben etwas blockiert):
     Sie √ºberschreibt ggf. den Shim und stellt sicher, dass Sync immer funktioniert. -->
<script>
(function(){
  if (typeof window.manualDirectSyncNow !== 'function' || typeof window.__mdsn_impl !== 'function') {
    async function __manualDirectSyncFallback(){
      const setTry=(s,extra)=>{ try{ localStorage.setItem('qt_last_sync_try', JSON.stringify(Object.assign({t:Date.now(),stage:s},extra||{}))); }catch(_e){} };
      const setErr=(s,msg)=>{ try{ localStorage.setItem('qt_last_event_err', JSON.stringify({t:Date.now(),stage:s,msg:String(msg||'')})); }catch(_e){} };

      try{
        setTry('start');
        // supabase-js abwarten
        const t0=Date.now(); while(!(window.supabase && window.supabase.createClient)){ if (Date.now()-t0>15000) throw new Error('Supabase SDK nicht geladen'); await new Promise(r=>setTimeout(r,100)); }
        // Client re‚Äënutzen/erstellen
        let sb = window.supa;
        if (!sb){
          const P=(window.Capacitor&&window.Capacitor.Plugins&&window.Capacitor.Plugins.Preferences)||null;
          const storage = P? {
            getItem: async (k)=>{ const r=await P.get({key:k}); return (r && typeof r.value==='string')? r.value:null; },
            setItem: async (k,v)=>{ await P.set({key:k, value:String(v??'')}); },
            removeItem: async (k)=>{ await P.remove({key:k}); }
          } : undefined;
          sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth:{ persistSession:true, storage, autoRefreshToken:true, detectSessionInUrl:false } });
          window.supa = sb;
        }
        setTry('client_ready');
        const {data:{user}} = await sb.auth.getUser();
        if (!user) throw new Error('Keine Session vorhanden');
        setTry('got_user',{user:{id:user.id}});
        let snapshot=[]; try{ snapshot=JSON.parse(localStorage.getItem('contacts')||'[]'); }catch(_e){ snapshot=[]; }
        if (!Array.isArray(snapshot)) snapshot=[];
        setTry('snapshot_ready',{count:snapshot.length});
        try{
          const { error } = await sb.rpc('fn_public_upsert_user_contacts', { p_contacts:snapshot });
          if (error) throw error;
        }catch(e1){
          setTry('rpc_upsert_failed',{err:String(e1?.message||e1)});
          const { error:e2 } = await sb.from('user_contacts').upsert({ user_id:user.id, contacts:snapshot }, { onConflict:'user_id' });
          if (e2) throw e2;
        }
        setTry('upsert_ok');
        const { error:e3 } = await sb.rpc('fn_log_events_from_contacts_snapshot', { p_user_id:user.id, p_contacts:snapshot });
        if (e3) throw e3;
        setTry('events_ok'); try{ localStorage.removeItem('qt_last_event_err'); }catch(_e){}
        return true;
      }catch(err){
        setErr('manual_direct_sync_fallback', err?.message||err);
        return false;
      }
    }
    try{ window.__mdsn_impl = __manualDirectSyncFallback; window.manualDirectSyncNow = __manualDirectSyncFallback; }catch(_e){}
  }
})();
</script>

</body>
</html>
