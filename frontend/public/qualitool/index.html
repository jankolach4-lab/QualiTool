<!DOCTYPE html>
<html lang="de">
<head>
<!-- Meta tags and title -->
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Qualifizierungs-Tool</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">
<link rel="icon" type="image/svg+xml" href="icon-192x192.svg">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon" href="qt-logo.png">
<link rel="icon" type="image/png" href="qt-logo.png">
</head>

<body>
<script>
  // Früher Redirect zur Login-Seite, falls kein Offline-Flag und kein letzter Nutzer vorhanden.
  (function(){
    try {
      var offlineAllowed = localStorage.getItem('offline_allowed') === 'true';
      var lastUser = localStorage.getItem('last_user_id');
      if (!offlineAllowed || !lastUser) {
        // Falls eine aktive Supabase-Session existiert, leitet login.html ohnehin direkt zurück.
        window.location.replace('./login.html');
      }
    } catch (e) { /* ignore */ }
  })();
</script>
<!-- HTML structure -->
<style>
  /* Global styles */
  * { 
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  }

  body {
    margin: 0;
    padding: 0;
    line-height: 1.4;
  }

  .page-layout {
    display: flex;
    min-height: 100vh;
  }

  .sidebar {
    width: 60px; 
    background: #2563eb;
    padding: 10px; 
    color: white;
    flex-shrink: 0;
    position: fixed; 
    top: 0; 
    bottom: 0; 
    left: 0; 
    overflow-y: auto; 
    z-index: 100; 
  }

  .sidebar-nav {
    list-style: none;
    padding: 0;
    margin: 10px 0;
  }

  .sidebar-nav li { margin: 10px 0; }

  .sidebar-nav a {
    color: white;
    text-decoration: none;
    padding: 10px; 
    display: flex;
    justify-content: center; 
    align-items: center; 
    border-radius: 6px;
    transition: background 0.2s;
  }

  .sidebar-nav a:hover { background: rgba(255,255,255,0.1); }
  .sidebar-nav a.active { background: rgba(255,255,255,0.2); }
  .sidebar-nav a svg { width: 24px; height: 24px; }

  .main-content {
    flex: 1;
    padding: 15px;
    background: #f5f7fa;
    overflow-y: auto;
    margin-left: 60px; 
    height: 100vh; 
  }

  .container {
    max-width: 1000px;
    margin: 0 auto;
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    text-align: left;
    display: flex;
    flex-direction: column;
    height: calc(100vh - 50px); 
    overflow-y: auto; 
  }

  .import-section {
    margin-bottom: 15px;
  }

  .import-section h3 {
    color: #2563eb;
    margin-bottom: 20px;
    text-align: center;
    font-weight: 600;
    font-size: 1.3em;
    margin: 0;
    padding: 15px 0;
    cursor: pointer;
    position: relative;
    padding-right: 15px;
  }

  .import-content {
    display: none;
  }

  .import-section.expanded {
    border-left: 4px solid #2563eb;
  }

  .import-section.expanded .import-content {
    display: block;
    max-width: 600px;
    margin: 0 auto;
    padding: 20px;
  }

  .import-content p {
    margin-bottom: 15px;
  }

  .import-content .import-btn {
    display: inline-block;
    min-width: 200px;
    margin: 10px auto;
  }

  .entry-section h2 {
    color: #2563eb;
    margin-bottom: 20px;
    text-align: center;
    font-weight: 600;
    font-size: 1.3em;
    cursor: pointer;
    position: relative;
    padding-right: 15px;
  }

  .entry-section .entry-content {
    display: none;
  }

  .entry-section.expanded .entry-content {
    display: block;
  }

  h1 {
    color: #000000; 
    margin-bottom: 20px;
    text-align: center;
    font-weight: 600;
    font-size: 1.7em; 
  }

  h2, h3 {
    color: #2563eb;
    margin-bottom: 20px;
    text-align: center;
    font-weight: 600;
    font-size: 1.3em;
  }

  .form-group {
    margin-bottom: 15px;
    display: inline-block;
    margin-right: 0;
    width: calc(16.66% - 10px);
  }

  input, .status-select {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    margin-top: 6px;
    transition: all 0.2s;
    font-size: 14px;
    background: #fafafa;
  }

  input:focus, .status-select:focus {
    background: #ffffff;
    border-color: #2563eb;
    outline: none;
    transform: translateY(-1px);
    box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
  }

  button {
    background: #2563eb;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    margin: 5px;
    font-size: 13px;
    font-weight: 500;
    letter-spacing: 0.3px;
  }

  button:hover {
    background: #1d4ed8;
    transform: translateY(-1px);
  }

  .contact-list {
    margin-top: 30px;
    overflow-y: auto; 
    flex: 1;
    max-height: calc(100vh - 400px); 
    min-height: 40px; /* ensure visible area even when empty */
    display: block;
  }

  .contact-card {
    background: #ffffff;
    border: none;
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    border-left: 4px solid transparent;
  }

  .contact-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.12);
  }

  .contact-info {
    display: grid;
    grid-template-columns: auto auto auto auto auto minmax(150px, 1fr) minmax(150px, 1fr);
    gap: 10px;
    align-items: center;
    font-size: 14px;
    margin-bottom: 5px;
    text-align: left;
    justify-content: start;
  }

  .contact-info p {
    text-align: left;
    justify-self: start;
    margin-right: 0;
    white-space: nowrap;
  }

  .unit-info {
    display: flex;
    flex-direction: column;
    gap: 5px;
    min-width: 150px;
  }

  .unit-info p {
    margin: 0;
    padding: 0;
    white-space: nowrap;
    line-height: inherit;
  }

  .unit-info p:first-child {
    margin-top: 0;
  }

  .delete-btn {
    background: #ef4444;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 13px;
    display: none; 
    margin: 5px;
  }

  .contact-card.expanded .delete-btn {
    display: block; 
  }

  .delete-btn:hover {
    background: #dc2626;
  }

  .search-box {
    margin-bottom: 20px;
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }

  .street-filter-container {
    margin: 15px 0;
    text-align: center;
    display: none; 
  }

  .street-filter {
    width: 300px;
    margin: 0;
    padding: 8px 12px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    font-size: 14px;
    background: white;
  }

  .street-filter:focus {
    border-color: #2563eb;
    outline: none;
    box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
  }

  .import-section,
  .entry-section {
    margin-bottom: 15px;
  }

  .residents-section {
    margin-top: 12px;
    padding: 15px;
    border-radius: 8px;
  }

  .resident-entry {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin: 15px 0;
    padding: 12px;
    background: white;
    border-radius: 8px;
    border-bottom: 2px solid #2563eb; 
    margin-bottom: 20px; 
  }

  .resident-entry:last-child {
    border-bottom: none;
  }

  .unit-management {
    margin-bottom: 15px;
    padding: 10px 0;
    border-bottom: 1px solid #eee;
  }

  .unit-btn {
    font-size: 13px;
    padding: 8px 16px;
    margin: 5px;
  }

  .expanded {
    border-left: 4px solid #2563eb;
  }

  .history-entry {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 8px;
    margin: 2px 0;
    border-radius: 4px;
    font-size: 0.85em;
    line-height: 1.1;
    background: #f9fafb;
    border-left: 1px solid #e5e7eb;
  }

  .history-status {
    font-weight: 500;
    font-size: 0.85em;
  }

  .history-date {
    color: #6b7280;
    font-size: 0.8em;
    white-space: nowrap;
  }

  .delete-history {
    padding: 1px 4px;
    font-size: 11px;
    color: #6b7280;
    background: none;
    border: none;
    cursor: pointer;
    opacity: 0.6;
  }

  .delete-history:hover {
    opacity: 1;
    color: #ef4444;
  }

  .status-history {
    margin-top: 6px;
    max-height: 150px;
    overflow-y: auto;
    border: 1px solid #e5e7eb;
    border-radius: 4px;
    padding: 3px;
    background: #ffffff;
  }

  .delete-all-btn {
    background: #ef4444;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 13px;
    font-weight: 500;
    white-space: nowrap;
  }

  .delete-all-btn:hover {
    background: #dc2626;
    transform: translateY(-1px);
  }

  .status-filters {
    margin: 15px 0;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 30px;
    margin-bottom: 30px;
    background: white;
  }

  .filter-btn,
  .status-filters button {
    background: #f1f5f9;
    color: #64748b;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
    margin: 3px;
    font-size: 13px;
    font-weight: 500;
  }

  .filter-btn.active,
  .status-filters button.active {
    background: #2563eb;
    color: white;
  }

  .filter-btn:hover,
  .status-filters button:hover {
    background: #e2e8f0;
    transform: translateY(-1px);
  }

  .filter-btn.active:hover,
  .status-filters button.active:hover {
    background: #1d4ed8;
  }

  input[id="plz"],
  input[id="street_plz"] {
    width: 80px;
    max-width: 100%;
  }

  .contact-info.empty-status {
    color: #9ca3af;
  }

  .entry-content {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
  }

  .tab-buttons {
    text-align: center;
    margin-bottom: 20px;
  }

  #singleEntry, #streetEntry {
    max-width: 600px;
    margin: 0 auto;
  }

  #contactForm, #streetForm {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
  }

  .entry-section button[type="submit"] {
    display: block;
    margin: 20px auto;
    min-width: 200px;
  }

  .file-input {
    display: none;
  }

  #fileName {
    display: block;
    margin-top: 10px;
    color: #6b7280;
    font-size: 0.9em;
  }

  .statistics-section {
    margin: 10px 0;
    padding: 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
  }

  .calendar-section {
    margin: 10px 0;
    padding: 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
  }

  .calendar-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding: 0 10px;
  }

  .calendar-controls button {
    background: #f1f5f9;
    color: #64748b;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .calendar-controls button:hover {
    background: #e2e8f0;
    transform: translateY(-1px);
  }

  .calendar-controls h4 {
    font-size: 1.2em;
    color: #2563eb;
    margin: 0;
  }

  .calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
    margin-bottom: 4px;
  }

  .calendar-weekdays div {
    background: #f8fafc;
    padding: 10px;
    text-align: center;
    font-weight: 600;
    color: #64748b;
    border-radius: 6px;
  }

  #calendarDays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
  }

  .calendar-day {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 6px;
    padding: 10px;
    min-height: 100px;
    position: relative;
  }

  .calendar-day .day-number {
    position: absolute;
    top: 5px;
    right: 5px;
    color: #64748b;
    font-size: 0.9em;
  }

  .calendar-day.has-entries {
    background: #f0f9ff;
    border-color: #bae6fd;
  }

  .calendar-day.has-completions {
    background: #dcfce7;
    border-color: #86efac;
  }

  .calendar-day .day-stats {
    margin-top: 25px;
    font-size: 0.85em;
  }

  .calendar-day .qualis {
    color: #0369a1;
    margin-bottom: 4px;
  }

  .calendar-day .completions {
    color: #15803d;
  }

  #calendar {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
  }

  .calendar-header {
    cursor: pointer;
    margin-bottom: 15px;
  }

  .statistics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 15px;
    padding: 15px;
  }

  .stat-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: transform 0.2s ease;
  }

  .stat-card:hover {
    transform: translateY(-2px);
  }

  .stat-number {
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 8px;
    color: #1f2937;
  }

  .stat-label {
    font-size: 14px;
    color: #4b5563;
    margin-bottom: 5px;
  }

  .stat-percentage {
    font-size: 12px;
    color: #6b7280;
  }

  /* Status-specific background colors for stat cards */
  .stat-card.status-offen {
    background-color: #e5e7eb;
    border-left: 4px solid #9ca3af;
  }

  .stat-card.status-nicht-angetroffen {
    background-color: #fee2e2;
    border-left: 4px solid #ef4444;
  }

  .stat-card.status-kein-eintritt {
    background-color: #fef3c7;
    border-left: 4px solid #f59e0b;
  }

  .stat-card.status-wiedervorlage {
    background-color: #dbeafe;
    border-left: 4px solid #3b82f6;
  }

  .stat-card.status-termin {
    background-color: #dcfce7;
    border-left: 4px solid #22c55e;
  }

  .stat-card.status-beraten {
    background-color: #fef3c7;
    border-left: 4px solid #f59e0b;
  }

  .stat-card.status-kein-interesse {
    background-color: #fce7f3;
    border-left: 4px solid #ec4899;
  }

  .stat-card.status-abschluss {
    background-color: #ccfbf1;
    border-left: 4px solid #14b8a6;
  }

  .stat-card.status-nicht-vermarktbar {
    background-color: #fef2f2;
    border-left: 4px solid #dc2626;
  }

  .stat-card.status-blacklist {
    background-color: #292524;
    border-left: 4px solid #1c1917;
    color: white;
  }

  .stat-card.status-blacklist .stat-number,
  .stat-card.status-blacklist .stat-label,
  .stat-card.status-blacklist .stat-percentage {
    color: white;
  }

  .status-history {
    margin-top: 10px;
    max-height: 200px;
    overflow-y: auto;
  }

  .history-entry {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 15px;
    margin: 6px 0;
    border-radius: 6px;
  }

  .history-status {
    font-weight: 500;
  }

  .history-date {
    color: #6b7280;
    font-size: 0.9em;
  }

  /* New CSS rules */
  .notes-section {
    margin-top: 10px;
  }

  .notes-textarea {
    width: 100%;
    height: 4em; /* Makes textarea approximately 2 lines tall */
    min-height: 4em;
    padding: 12px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    resize: vertical;
    font-family: inherit;
    font-size: 14px;
    line-height: 1.5;
    background: #fafafa;
    transition: all 0.2s ease;
  }

  .notes-textarea:focus {
    background: #ffffff;
    border-color: #2563eb;
    outline: none;
    box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
  }

  .visit-recommendation-box {
    background: white;
    padding: 15px;
    border-radius: 12px;
    margin: 15px 0;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
  }

  .visit-recommendation-box h3 {
    color: #2563eb;
    margin: 0;
    padding: 10px;
    text-align: center;
  }

  #recommendationResults {
    max-height: 400px;
    overflow-y: auto;
  }

  .recommended-contact {
    background: #f0f9ff;
    padding: 15px;
    margin: 10px 0;
    border-radius: 8px;
    border-left: 4px solid #3b82f6;
  }

  .last-visit-time {
    color: #6b7280;
    font-size: 0.9em;
    margin-top: 5px;
  }
  
  /* Add this CSS rule to define the highlight color for addresses with Abschluss status */
  .contact-info.has-abschluss {
    background-color: #dcfce7 !important; 
    border-left: 4px solid #22c55e !important; 
  }

  .visit-recommendation-controls {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-bottom: 20px;
  }

  .recommendation-type-btn {
    padding: 8px 16px;
    border-radius: 6px;
    background: #f1f5f9;
    color: #64748b;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
  }

  .recommendation-type-btn.active {
    background: #2563eb;
    color: white;
  }

  /* Add new style for inactive residents */
  .inactive-resident {
    color: red;
    font-weight: bold;
  }

  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
  }

  .modal-content {
    background-color: #fefefe;
    margin: 10% auto;
    padding: 30px;
    border-radius: 8px;
    width: 500px;
    text-align: left;
  }

  .modal-content h3 {
    margin-bottom: 25px;
    color: #2563eb;
    font-size: 1.3em;
  }

  .modal-content > div {
    margin-bottom: 20px;
  }

  .modal-content label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
  }

  .modal-content input[type="number"] {
    width: 100%;
    padding: 8px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    margin-bottom: 5px;
  }

  .modal-content textarea {
    width: 100%;
    min-height: 100px;
    padding: 8px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    resize: vertical;
  }

  .modal-content .button-group {
    margin-top: 25px;
    display: flex;
    justify-content: flex-end;
    gap: 15px;
  }

  .modal-content input[type="checkbox"] {
    margin-right: 8px;
  }

  .modal-content .checkbox-wrapper {
    margin-bottom: 25px;
    padding: 15px;
    background: #f9fafb;
    border-radius: 6px;
   border: 1px solid #e5e7eb;
  }

  .status-onlineabschluss {
    background-color: #d1fae5 !important; 
    border-left: 4px solid #059669 !important; 
  }
  .contact-info.status-onlineabschluss {
    background-color: #dbeafe !important; 
    border-left: 4px solid #2563eb !important; 
  }

  /* Add to calendar controls area */
  .calendar-summary {
    text-align: center;
    margin: 15px 0;
    padding: 15px;
    background: #f3f4f6;
    border-radius: 8px;
  }

  .calendar-summary strong {
    color: #2563eb;
    font-size: 1.1em;
  }

  .forecast {
    color: #059669;
    margin-top: 8px;
  }
  
  .status-abschl-anderer-vp {
    background-color: #f0f9ff !important; 
    border-left: 4px solid #60a5fa !important; 
  }

  .contact-info.status-abschl-anderer-vp {
    background-color: #dbeafe !important; 
    border-left: 4px solid #2563eb !important; 
  }
  
  .we-correct-btn {
    font-size: 13px;
    padding: 8px 16px;
    margin: 5px;
  }

  .we-corrections-history {
    background-color: #f3f4f6;
    padding: 8px;
    margin-top: 8px;
    border-radius: 4px;
    font-size: 0.9em;
  }

  .we-correction-entry {
    background-color: white;
    padding: 8px;
    margin-bottom: 4px;
    border-radius: 4px;
    border-left: 3px solid #f59e0b;
    font-size: 0.85em;
    line-height: 1.3;
  }

  .we-correction-entry p {
    margin: 2px 0;
  }

  /* Add style for clickable correction entries */
  .we-correction-entry {
    cursor: pointer;
  }

  .we-correction-entry:hover {
    background-color: #f3f4f6;
  }

  /* Add new styles for kein-interesse status */
  .status-kein-interesse-red {
    background-color: #fee2e2 !important; 
    border-left: 4px solid #ef4444 !important; 
  
  }

  /* Add new style for status-beraten */
  .contact-info.status-beraten {
    background-color: #fef9c3 !important; 
    border-left: 4px solid #facc15 !important; 
  }

  /* Ensure this style has high specificity to override other status styles */
  .contact-card .contact-info.status-beraten {
    background-color: #fef9c3 !important;
    border-left: 4px solid #facc15 !important;
  }
</style>

<!-- HTML structure -->
<div class="page-layout">
  <nav class="sidebar">
    <ul class="sidebar-nav">
      <li><a href="#contacts" data-section="contacts" class="active" title="Kontaktliste" onclick="return navTo('contacts')">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="8" y1="6" x2="21" y2="6"/>
          <line x1="8" y1="12" x2="21" y2="12"/>
          <line x1="8" y1="18" x2="21" y2="18"/>
          <line x1="3" y1="6" x2="3.01" y2="6"/>
          <line x1="3" y1="12" x2="3.01" y2="12"/>
          <line x1="3" y1="18" x2="3.01" y2="18"/>
        </svg>
      </a></li>

      <li><a href="#import" data-section="import" title="Daten importieren" onclick="return navTo('import')">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
          <polyline points="7 10 12 15 17 10"></polyline>
          <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
      </a></li>
      <li><a href="#add" data-section="add" title="Neue Adresse hinzufügen" onclick="return navTo('add')">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="9"></circle>
          <line x1="12" y1="8" x2="12" y2="16"></line>
          <line x1="8" y1="12" x2="16" y2="12"></line>
        </svg>
      </a></li>
      <li><a href="#stats" data-section="stats" title="Statistik anzeigen" onclick="return navTo('stats')">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="11" width="4" height="10" rx="1"></rect>
          <rect x="10" y="7" width="4" height="14" rx="1"></rect>
          <rect x="17" y="3" width="4" height="18" rx="1"></rect>
        </svg>
      </a></li>
      <li><a href="#calendar" data-section="calendar" title="Aktivitätenkalender" onclick="return navTo('calendar')">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
          <rect x="7" y="14" width="3" height="3" rx="0.5"></rect>
          <rect x="12" y="14" width="3" height="3" rx="0.5"></rect>
        </svg>
      </a></li>
      <li><a href="#recommendations" data-section="recommendations" title="Besuchsempfehlungen" onclick="return navTo('recommendations')">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21 10c0 6-9 12-9 12S3 16 3 10a9 9 0 1 1 18 0z"></path>
          <circle cx="12" cy="10" r="3"></circle>
        </svg>
      </a></li>
      <li><a href="#pdf-corrections" data-section="pdf-corrections" title="WE-Korrekturen" onclick="return navTo('pdf-corrections')">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <polyline points="8 14 12 18 16 14"></polyline>
        </svg>
      </a></li>
    </ul>
  </nav>
  
  <div class="main-content">
    <div class="container">
      <div id="weCorrectionsSection" style="display:none"></div>

      <!-- 1. Import section -->
      <div class="import-section collapsed">
        <h3 onclick="toggleImportSection()">Adressen importieren</h3>
        <div class="import-content">
          <p>Unterstütztes Format: Excel (XLSX, XLS)</p>
          <p>Erforderliche Spalten: PLZ, Ort, Straße, Nr., Zusatz, WE</p>
          <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls">
          <span id="fileName"></span>
          <div class="import-export-buttons">
            <button onclick="document.getElementById('excelImport').click()" class="import-btn">Excel importieren</button>
            <button onclick="exportToExcel()" class="import-btn">Excel exportieren</button>
            <input type="file" id="excelImport" style="display: none" accept=".xlsx,.xls" onchange="importFromExcel(this.files[0])">
          </div>
        </div>
      </div>

      <!-- 2. Entry section -->
      <div class="entry-section collapsed">
        <h2 onclick="toggleEntrySection()">Adresse hinzufügen</h2>
        <div class="entry-content">
          <div class="tab-buttons">
            <button onclick="showForm('single')" id="singleBtn" class="active">Einzelne Adresse</button>
            <button onclick="showForm('street')" id="streetBtn">Komplette Straße</button>
          </div>

          <div id="singleEntry">
            <form id="contactForm" onsubmit="addContact(event)">
              <div class="form-group">
                <input type="text" id="plz" placeholder="PLZ" maxlength="5" pattern="\d{5}" required>
              </div>
              <div class="form-group">
                <input type="text" id="ort" placeholder="Ort" required>
              </div>
              <div class="form-group">
                <input type="text" id="strasse" placeholder="Straße" required>
              </div>
              <div class="form-group">
                <input type="text" id="nummer" placeholder="Nr." required>
              </div>
              <div class="form-group">
                <input type="text" id="zusatz" placeholder="Zusatz">
              </div>
              <div class="form-group">
                <input type="text" id="we" placeholder="WE">
              </div>
              <button type="submit">Kontakt hinzufügen</button>
            </form>
          </div>

          <div id="streetEntry" style="display: none;">
            <form id="streetForm" onsubmit="addStreet(event)">
              <div class="form-group">
                <input type="text" id="street_plz" placeholder="PLZ" maxlength="5" pattern="\d{5}" required>
              </div>
              <div class="form-group">
                <input type="text" id="street_ort" placeholder="Ort" required>
              </div>
              <div class="form-group">
                <input type="text" id="street_strasse" placeholder="Straße" required>
              </div>
              <div class="form-group">
                <input type="number" id="street_start" placeholder="Hausnr. von" required>
              </div>
              <div class="form-group">
                <input type="number" id="street_end" placeholder="Hausnr. bis" required>
              </div>
              <button type="submit">Straße hinzufügen</button>
            </form>
          </div>
        </div>
      </div>

      <!-- 3. Calendar section -->
      <div class="calendar-section">
        <h3 class="calendar-header" onclick="toggleCalendar()">Aktivitäten-Kalender</h3>
        <div id="calendar" style="display: none;">
          <div class="calendar-controls">
            <button onclick="previousMonth()">&lt;</button>
            <h4 id="currentMonth"></h4>
            <button onclick="nextMonth()">&gt;</button>
          </div>
          <div class="calendar-summary">
            <strong>Summary</strong>
            <p class="forecast">&nbsp;</p>
          </div>
          <div class="calendar-grid">
            <div class="calendar-weekdays">
              <div>Mo</div>
              <div>Di</div>
              <div>Mi</div>
              <div>Do</div>
              <div>Fr</div>
              <div>Sa</div>
              <div>So</div>
            </div>
            <div id="calendarDays"></div>
          </div>
        </div>
      </div>

      <!-- 4. Statistics section -->
      <div class="statistics-section">
        <h3 class="statistics-header" onclick="toggleStatistics()">Statusauswertung</h3>
        <div id="statusStats" style="display: none;">
          <div class="statistics-grid" id="statsGrid">
            <!-- Statistics will be inserted here dynamically -->
          </div>
        </div>
      </div>

      <!-- 5. Visit recommendation section -->
      <div class="visit-recommendation-box">
        <h3 onclick="toggleVisitRecommendation()">Besuchsempfehlung</h3>
        <div id="visitRecommendationContent" style="display: none; padding: 15px;">
          <div class="visit-recommendation-controls">
            <button onclick="this.classList.add('active'); this.nextElementSibling.classList.remove('active'); document.querySelector('.time-selection').style.display = 'flex'; showVisitRecommendations()" class="recommendation-type-btn active!">Nach Besuchszeit</button>
            <button onclick="this.classList.add('active'); this.previousElementSibling.classList.remove('active'); document.querySelector('.time-selection').style.display = 'none'; showInactiveRecommendations()" class="recommendation-type-btn">Inaktive Adressen (&gt; 3 Wochen)</button>
          </div>
          <div class="time-selection" style="display: flex; gap: 15px; align-items: center; justify-content: center; margin-bottom: 15px;">
            <div>
              <label for="startTime">Von:</label>
              <input type="time" id="startTime" min="06:00" max="23:00" value="06:00">
            </div>
            <div>
              <label for="endTime">Bis:</label>
              <input type="time" id="endTime" min="06:00" max="23:00" value="23:00">
            </div>
            <button onclick="showVisitRecommendations()">Empfehlungen anzeigen</button>
          </div>
          <div id="recommendationResults"></div>
        </div>
      </div>

      <div class="search-box">
        <input type="text" id="searchInput" placeholder="Kontakte durchsuchen..." onkeyup="applyFilters()">
        <button onclick="deleteAllContacts()" class="delete-all-btn">Alle Adressen löschen</button>
        <button onclick="showDeleteByPLZDialog()" class="delete-all-btn" style="background: #ef4444;">Nach PLZ löschen</button>
        <button onclick="showDeleteStreetDialog()" class="delete-all-btn" style="background: #ef4444;">Nach Straße löschen</button>
      </div>

      <!-- Status filters -->
      <div class="status-filters">
        <button onclick="filterByStatus('all')" class="filter-btn active">Alle</button>
        <button onclick="filterByStatus('nicht-angetroffen')" class="filter-btn">Nicht angetroffen</button>
        <button onclick="filterByStatus('kein-eintritt')" class="filter-btn">Kein Eintritt persönlich</button>
        <button onclick="filterByStatus('wiedervorlage')" class="filter-btn">Wiedervorlage</button>
        <button onclick="filterByStatus('termin')" class="filter-btn">Termin</button>
        <button onclick="filterByStatus('beraten')" class="filter-btn">Bereits beraten</button>
        <button onclick="filterByStatus('kein-interesse')" class="filter-btn">Kein Interesse</button>
        <button onclick="filterByStatus('abschluss')" class="filter-btn">Abschluss</button>
        <button onclick="filterByStatus('onlineabschluss')" class="filter-btn">Online/TS</button>
        <button onclick="filterByStatus('abschl-anderer-vp')" class="filter-btn">Abschl. anderer VP</button>
      </div>

      <!-- Street filter -->
      <div class="street-filter-container">
        <select id="streetFilter" class="street-filter" onchange="applyFilters()">
          <option value="all">Alle Straßen</option>
        </select>
      </div>

      <!-- Contact list -->
      <div class="contact-list" id="contactList">
        <!-- Kontakte werden hier dynamisch eingefügt -->
      </div>
    </div>
  </div>
</div>

<div id="deletePLZDialog" style="display:none" class="modal">
  <div class="modal-content">
    <h3>Adressen nach PLZ löschen</h3>
    <input type="text" id="plzToDelete" placeholder="PLZ eingeben" maxlength="5" pattern="\d{5}">
    <div class="button-group">
      <button onclick="deleteByPLZ()">Löschen</button>
      <button onclick="closeDeletePLZDialog()">Abbrechen</button>
    </div>
  </div>
</div>

<div id="deleteStreetDialog" style="display:none" class="modal">
  <div class="modal-content">
    <h3>Adressen nach Straße löschen</h3>
    <select id="streetToDelete" multiple style="width: 100%; margin-bottom: 15px; height: 200px;">
      <option value>Straßen auswählen</option>
    </select>
    <div class="button-group">
      <button onclick="deleteByStreet()">Löschen</button>
      <button onclick="closeDeleteStreetDialog()">Abbrechen</button>
    </div>
  </div>
</div>

<div id="weCorrectModal" class="modal">
  <div class="modal-content">
    <h3>Falsche WE melden</h3>
    <div class="checkbox-wrapper">
      <label>
        <input type="checkbox" id="manualCurrentWe">
        Manuelle Eingabe der aktuellen WE-Anzahl
      </label>
    </div>
    <div class="checkbox-wrapper">
      <label>
        <input type="checkbox" id="hasGEE">
        GEE/VGM vorhanden
      </label>
    </div>
    <div>
      <label for="currentWeCount">Aktuelle WE-Anzahl:</label>
      <input type="number" id="currentWeCount">
    </div>
    <div>
      <label for="correctedWeCount">Korrigierte WE-Anzahl:</label>
      <input type="number" id="correctedWeCount">
    </div>
    <div>
      <label for="weCorrectReason">Begründung:</label>
      <textarea id="weCorrectReason" rows="4" placeholder="Bitte geben Sie den Grund für die WE-Korrektur an..."></textarea>
    </div>
    <div class="button-group">
      <button onclick="closeWeCorrectModal()">Abbrechen</button>
      <button onclick="saveWeCorrection()">Speichern</button>
    </div>
  </div>
</div>

<script>
  // Load external libraries dynamically to avoid blocking/aborted requests in some environments
  (function(){
    var s1=document.createElement('script'); s1.src='https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2'; s1.async=true; document.head.appendChild(s1);
    var s2=document.createElement('script'); s2.src='https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js'; s2.async=true; document.head.appendChild(s2);
  })();
</script>
  // Simple script loader with Promise
  function loadScript(src){
    return new Promise((resolve, reject) => {
      try {
        const s = document.createElement('script');
        s.src = src;
        s.async = true;
        s.onload = () => resolve(true);
        s.onerror = (e) => reject(e);
        document.head.appendChild(s);
      } catch(e){ reject(e); }
    });
  }

<script src="./capacitor-bridge.js"></script>
<script>
  // Helper für sicheres DOM‑Handling
  function $el(sel){ return document.querySelector(sel); }
  function setDisp(sel, val){ const n=$el(sel); if(n) n.style.display = val; }

  function renderCalendar() {
    const monthNames = ['Januar', 'Februar', 'März', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
    document.getElementById('currentMonth').textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
  
    const currentCompletions = getMonthStats(currentDate.getFullYear(), currentDate.getMonth());
    const totalWorkdays = countWorkdaysInMonth(currentDate.getFullYear(), currentDate.getMonth());
    const forecast = calculateForecast(currentCompletions, new Date(), totalWorkdays);

    const calendarDiv = document.getElementById('calendar');
    let summaryDiv = calendarDiv.querySelector('.calendar-summary');
    if (!summaryDiv) {
      summaryDiv = document.createElement('div');
      summaryDiv.className = 'calendar-summary';
      calendarDiv.insertBefore(summaryDiv, calendarDiv.firstChild);
    }
  
    summaryDiv.innerHTML = `
      <div>Abschlüsse diesen Monat: <strong>${currentCompletions}</strong></div>
      <div class="forecast">Forecast: <strong>${forecast}</strong> Abschlüsse</div>
    `;
  
    const daysGrid = document.getElementById('calendarDays');
    daysGrid.innerHTML = '';
  
    const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    let firstDayIndex = firstDay.getDay();
    firstDayIndex = firstDayIndex === 0 ? 6 : firstDayIndex - 1;
  
    for (let i = 0; i < firstDayIndex; i++) {
      const emptyDay = document.createElement('div');
      emptyDay.className = 'calendar-day';
      daysGrid.appendChild(emptyDay);
    }
  
    const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
  
    for (let day = 1; day <= lastDay.getDate(); day++) {
      const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
      const dayOfWeek = date.getDay();
  
      const dayDiv = document.createElement('div');
      dayDiv.className = 'calendar-day';
  
      const stats = getDayStats(date);
  
      if (stats.total > 0 || stats.completions > 0) {
        dayDiv.classList.add('has-entries');
        if (stats.completions > 0) {
          dayDiv.classList.add('has-completions');
        }
        dayDiv.innerHTML = `
          <div class="day-number">${day}</div>
          <div class="day-stats">
            <div class="qualis">${stats.total} Qualis</div>
            <div class="completions">${stats.completions} Abschl.</div>
          </div>
        `;
      } else {
        dayDiv.innerHTML = `<div class="day-number">${day}</div>`;
      }
  
      daysGrid.appendChild(dayDiv);
    }
  }
  let contacts = JSON.parse(localStorage.getItem('contacts')) || [];
  let currentFilter = 'all';
  let currentDate = new Date();
  async function importExcelFile(file) {
    try {
      const workbook = await readExcelFile(file);
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(firstSheet, {
        header: 1
      });
      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        if (!row[0]) continue;
        contacts.push({
          id: Date.now() + i,
          plz: row[0]?.toString() || '',
          ort: row[1]?.toString() || '',
          strasse: row[2]?.toString() || '',
          nummer: row[3]?.toString() || '',
          zusatz: row[4]?.toString() || '',
          we: row[5]?.toString() || '',
          residents: []
        });
      }
      contacts = sortContacts(contacts);
      saveContacts();
      updateStreetFilter();
      renderContacts();
      alert(`Import erfolgreich: ${rows.length - 1} Adressen importiert`);
    } catch (err) {
      console.error('Import failed:', err);
      alert('Fehler beim Import: ' + err.message);
    }
  }
  function readExcelFile(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, {
            type: 'array'
          });
          resolve(workbook);
        } catch (err) {
          reject(err);
        }
      };
      reader.onerror = err => reject(err);
      reader.readAsArrayBuffer(file);
    });
  }
  function filterByStatus(status) {
    document.querySelector('.status-filters').innerHTML = `
      <button onclick="filterByStatus('all')" class="filter-btn ${status === 'all' ? 'active' : ''}">Alle</button>
      <button onclick="filterByStatus('nicht-angetroffen')" class="filter-btn ${status === 'nicht-angetroffen' ? 'active' : ''}">Nicht angetroffen</button>
      <button onclick="filterByStatus('kein-eintritt')" class="filter-btn ${status === 'kein-eintritt' ? 'active' : ''}">Kein Eintritt persönlich</button>
      <button onclick="filterByStatus('wiedervorlage')" class="filter-btn ${status === 'wiedervorlage' ? 'active' : ''}">Wiedervorlage</button>
      <button onclick="filterByStatus('termin')" class="filter-btn ${status === 'termin' ? 'active' : ''}">Termin</button>
      <button onclick="filterByStatus('beraten')" class="filter-btn ${status === 'beraten' ? 'active' : ''}">Bereits beraten</button>
      <button onclick="filterByStatus('kein-interesse')" class="filter-btn ${status === 'kein-interesse' ? 'active' : ''}">Kein Interesse</button>
      <button onclick="filterByStatus('abschluss')" class="filter-btn ${status === 'abschluss' ? 'active' : ''}">Abschluss</button>
      <button onclick="filterByStatus('onlineabschluss')" class="filter-btn ${status === 'onlineabschluss' ? 'active' : ''}">Online/TS</button>
      <button onclick="filterByStatus('abschl-anderer-vp')" class="filter-btn ${status === 'abschl-anderer-vp' ? 'active' : ''}">Abschl. anderer VP</button>
    `;
    currentFilter = status;
    applyFilters();
  }
  function sortContacts(contactsToSort) {
    return contactsToSort.sort((a, b) => {
      const streetCompare = (a.strasse || '').localeCompare(b.strasse || '');
      if (streetCompare !== 0) return streetCompare;
      const numA = parseInt(a.nummer) || 0;
      const numB = parseInt(b.nummer) || 0;
      return numA - numB;
    });
  }
  function toggleImportSection() {
    const section = document.querySelector('.import-section');
    section.classList.toggle('collapsed');
    section.classList.toggle('expanded');
  }
  function toggleEntrySection() {
    const section = document.querySelector('.entry-section');
    section.classList.toggle('collapsed');
    section.classList.toggle('expanded');
  }
  function showForm(type) {
    document.getElementById('singleEntry').style.display = type === 'single' ? 'block' : 'none';
    document.getElementById('streetEntry').style.display = type === 'street' ? 'block' : 'none';
    document.getElementById('singleBtn').classList.toggle('active', type === 'single');
    document.getElementById('streetBtn').classList.toggle('active', type === 'street');
  }
  function addStreet(event) {
    event.preventDefault();
    const plz = document.getElementById('street_plz').value;
    const ort = document.getElementById('street_ort').value;
    const strasse = document.getElementById('street_strasse').value;
    const start = parseInt(document.getElementById('street_start').value);
    const end = parseInt(document.getElementById('street_end').value);
    for (let nummer = start; nummer <= end; nummer++) {
      const contact = {
        id: Date.now() + nummer,
        plz: plz,
        ort: ort,
        strasse: strasse,
        nummer: nummer.toString(),
        zusatz: '',
        we: '',
        residents: []
      };
      contacts.push(contact);
    }
    contacts = sortContacts(contacts);
    saveContacts();
    updateStreetFilter();
    renderContacts();
    event.target.reset();
  }
  function addContact(event) {
    event.preventDefault();
    const contact = {
      id: Date.now(),
      plz: document.getElementById('plz').value,
      ort: document.getElementById('ort').value,
      strasse: document.getElementById('strasse').value,
      nummer: document.getElementById('nummer').value,
      zusatz: document.getElementById('zusatz').value,
      we: document.getElementById('we').value,
      residents: []
    };
    contacts.push(contact);
    contacts = sortContacts(contacts);
    saveContacts();
    updateStreetFilter();
    renderContacts();
    event.target.reset();
  }
  function toggleActive(id) {
    document.querySelectorAll('.contact-card').forEach(card => {
      card.classList.remove('active');
    });
    const card = document.querySelector(`[data-id="${id}"]`);
    if (card) {
      card.classList.add('active');
    }
  }
  function toggleResidents(id) {
    const card = document.querySelector(`[data-id="${id}"]`);
    const residentsSection = card.querySelector('.residents-section');
    const deleteBtn = card.querySelector('.delete-btn');
    if (residentsSection.style.display === 'block') {
      residentsSection.style.display = 'none';
      card.classList.remove('expanded');
      card.classList.remove('active');
      deleteBtn.style.display = 'none';
    } else {
      residentsSection.style.display = 'block';
      card.classList.add('expanded');
      deleteBtn.style.display = 'inline-block';
      toggleActive(id);
    }
  }
  function saveResident(contactId, unitNumber, field) {
    const currentStreet = document.getElementById('streetFilter').value;
    const contact = contacts.find(c => c.id === contactId);
    if (!contact || !contact.residents) return;
    let resident = contact.residents.find(r => r.unit === unitNumber);
    if (!resident) {
      resident = {
        unit: unitNumber,
        name: '',
        phone: '',
        status: '',
        notes: '',
        mieter: false,
        statusHistory: []
      };
      contact.residents.push(resident);
    }
  
    // Now you can modify resident properties safely
    if (field === 'name') {
      const input = document.querySelector(`input[data-unit="${unitNumber}"][data-contact="${contactId}"]`);
      resident.name = input.value;
    } else if (field === 'phone') {
      const input = document.querySelector(`input[type="tel"][data-unit="${unitNumber}"][data-contact="${contactId}"]`);
      resident.phone = input.value;
    } else if (field === 'status') {
      const select = document.querySelector(`select[data-unit="${unitNumber}"][data-contact="${contactId}"]`);
      const newStatus = select.value;
      if (!resident.statusHistory) {
        resident.statusHistory = [];
      }
      resident.statusHistory.push({
        status: newStatus,
        date: new Date().toISOString(),
        timestamp: Date.now()
      });
      resident.status = newStatus;
      select.selectedIndex = 0;
      select.className = "status-select";
    } else if (field === 'notes') {
      const textarea = document.querySelector(`textarea[data-unit="${unitNumber}"][data-contact="${contactId}"]`);
      resident.notes = textarea.value;
    } else if (field === 'mieter') {
      const checkbox = document.querySelector(`input[type="checkbox"][data-unit="${unitNumber}"][data-contact="${contactId}"]`);
      resident.mieter = checkbox.checked;
    }
    saveContacts();
    updateStatistics();
    applyFilters();
  }
  function deleteContact(id) {
    contacts = contacts.filter(contact => contact.id !== id);
    saveContacts();
    updateStreetFilter();
    renderContacts();
  }
  function deleteAllContacts() {
    if (confirm('Möchten Sie wirklich alle Adressen löschen?')) {
      contacts = [];
      saveContacts();
      renderContacts();
    }
  }
  function addUnit(contactId) {
    const contact = contacts.find(c => c.id === contactId);
    if (!contact.we) contact.we = "0";
    contact.we = (parseInt(contact.we) + 1).toString();
    saveContacts();
    renderContacts();
  }
  function deleteUnit(contactId) {
    const contact = contacts.find(c => c.id === contactId);
    if (contact.we && parseInt(contact.we) > 0) {
      const currentUnits = parseInt(contact.we);
      if (contact.residents) {
        contact.residents = contact.residents.filter(r => parseInt(r.unit) < currentUnits);
      }
      contact.we = (currentUnits - 1).toString();
      saveContacts();
      renderContacts();
    }
  }
  function saveContacts() {
    localStorage.setItem('contacts', JSON.stringify(contacts));
  }
  function updateStreetFilter() {
    const streetFilter = document.getElementById('streetFilter');
    const streets = new Set();
    contacts.forEach(contact => {
      if (contact.strasse) {
        streets.add(contact.strasse);
      }
    });
    while (streetFilter.options.length > 1) {
      streetFilter.remove(1);
    }
    Array.from(streets).sort().forEach(street => {
      const option = document.createElement('option');
      option.value = street;
      option.textContent = street;
      streetFilter.appendChild(option);
    });
  }
  function getStatusLabel(status) {
    if (!status) return 'Kein Status';
    const statusLabels = {
      'offen': 'Offen',
      'nicht-angetroffen': 'Nicht angetroffen',
      'kein-eintritt': 'Kein Eintritt persönlich',
      'wiedervorlage': 'Wiedervorlage',
      'termin': 'Termin',
      'beraten': 'Bereits beraten',
      'kein-interesse': 'Kein Interesse',
      'abschluss': 'Abschluss',
      'onlineabschluss': 'Online/TS',
      'nicht-vermarktbar': 'Nicht vermarktbar',
      'blacklist': 'Blacklist',
      'abschl-anderer-vp': 'Abschl. anderer VP'
    };
    return statusLabels[status] || status;
  }
  function renderContacts(contactsToRender = contacts) {
    contactsToRender = sortContacts([...contactsToRender]);
    const expandedCards = new Set(Array.from(document.querySelectorAll('.contact-card.expanded')).map(card => card.getAttribute('data-id')));
    const contactList = document.getElementById('contactList');
    contactList.innerHTML = '';
    contactsToRender.forEach(contact => {
      const contactCard = document.createElement('div');
      contactCard.className = 'contact-card';
      contactCard.setAttribute('data-id', contact.id);
      const weCount = contact.manualCurrentWe !== undefined ? contact.manualCurrentWe : parseInt(contact.we) || 0;

      let residentInputs = `
        <div class="unit-management">
          <button onclick="event.stopPropagation(); deleteContact(${contact.id})" class="delete-btn" title="Löschen">Adresse löschen</button>
          <button type="button" onclick="event.stopPropagation(); addUnit(${contact.id})" class="unit-btn">
            + WE
          </button>
          <button type="button" onclick="event.stopPropagation(); deleteUnit(${contact.id})" class="unit-btn delete-unit">
            - WE
          </button>
          <button type="button" onclick="event.stopPropagation(); openWeCorrectModal(${contact.id})" class="unit-btn we-correct-btn">
            falsche WE melden
          </button>
        </div>
      `;
      if (contact.weCorrections && contact.weCorrections.length > 0) {
        residentInputs += `
          <div class="we-corrections-history">
            <h4 style="margin: 0 0 5px 0; font-size: 0.95em;">WE-Korrekturen</h4>
            ${contact.weCorrections?.map((correction, index) => `
              <div class="we-correction-entry" onclick="editWeCorrection(${contact.id}, ${index})">
                <p>Von ${correction.originalWe} auf ${correction.correctedWe} WE | ${correction.hasGEE ? 'GEE: Ja' : 'GEE: Nein'}</p>
                <p style="color: #666;">Grund: ${correction.reason}</p>
                <p style="color: #888; font-size: 0.8em;">${new Date(correction.date).toLocaleDateString('de-DE')}</p>
              </div>
            `).join('') || ''}
          </div>
        `;
      }
      for (let i = 1; i <= weCount; i++) {
        const resident = contact.residents?.find(r => r.unit === i) || {
          name: '',
          phone: '',
          status: '',
          notes: '',
          mieter: false,
          statusHistory: []
        };
        const historyHtml = resident.statusHistory ? resident.statusHistory.sort((a, b) => b.timestamp - a.timestamp).map(entry => `
            <div class="history-entry status-${entry.status}">
              <span class="history-status">${getStatusLabel(entry.status)}</span>
              <span class="history-date">${new Date(entry.date).toLocaleDateString('de-DE')} ${new Date(entry.date).toLocaleTimeString('de-DE', {
        hour: '2-digit',
        minute: '2-digit'
      })}</span>
              <button 
                class="delete-history" 
                onclick="event.stopPropagation(); deleteHistoryEntry(${contact.id}, ${i}, ${entry.timestamp})" 
                title="Eintrag löschen"
              >×</button>
            </div>
          `).join('') : '';
        const selectHtml = `
          <select 
            class="status-select status-${resident.status}"
            data-unit="${i}"
            data-contact="${contact.id}"
            onchange="saveResident(${contact.id}, ${i}, 'status')"
          >
            <option value="">Status auswählen</option>
            <option value="offen">Offen</option>
            <option value="nicht-angetroffen">Nicht angetroffen</option>
            <option value="kein-eintritt">Kein Eintritt persönlich</option>
            <option value="wiedervorlage">Wiedervorlage</option>
            <option value="termin">Termin</option>
            <option value="beraten">Bereits beraten</option>
            <option value="kein-interesse">Kein Interesse</option>
            <option value="abschluss">Abschluss</option>
            <option value="abschl-anderer-vp">Abschl. anderer VP</option>
            <option value="nicht-vermarktbar">Nicht vermarktbar</option>
            <option value="blacklist">Blacklist</option>
            <option value="onlineabschluss">Online/TS</option>
          </select>`;
        residentInputs += `
          <div class="resident-entry">
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
              <input 
                type="text" 
                placeholder="Bewohner WE ${i}" 
                value="${resident.name}"
                data-unit="${i}"
                data-contact="${contact.id}"
                onchange="saveResident(${contact.id}, ${i}, 'name')"
                style="flex: 2;"
              >
              <input
                type="tel"
                placeholder="Telefon WE ${i}"
                value="${resident.phone || ''}"
                data-unit="${i}"
                data-contact="${contact.id}"
                onchange="saveResident(${contact.id}, ${i}, 'phone')"
                style="flex: 1;"
              >
              <label style="display: flex; align-items: center; gap: 5px; white-space: nowrap;">
                <input 
                  type="checkbox" 
                  ${resident.mieter ? 'checked' : ''}
                  data-unit="${i}"
                  data-contact="${contact.id}"
                  onchange="saveResident(${contact.id}, ${i}, 'mieter')"
                >
                Mieter
              </label>
            </div>
            ${selectHtml}
            <div class="status-history">
              ${historyHtml}
            </div>
            <div class="notes-section">
              <textarea 
                class="notes-textarea"
                placeholder="Notizen für WE ${i} eingeben..."
                data-unit="${i}"
                data-contact="${contact.id}"
                onchange="saveResident(${contact.id}, ${i}, 'notes')"
                onblur="saveResident(${contact.id}, ${i}, 'notes')"
              >${resident.notes || ''}</textarea>
            </div>
          </div>
        `;
      }
      contactCard.innerHTML = `
        <div class="contact-info ${!contact.residents?.[0]?.name && !contact.residents?.[0]?.status ? 'empty-status' : ''}
          ${contact.residents?.some(r => getHighestPriorityStatus(r) === 'abschluss') ? 'has-abschluss' : ''}
          ${contact.residents?.some(r => getHighestPriorityStatus(r) === 'onlineabschluss') ? 'status-onlineabschluss' : ''}
          ${contact.residents?.some(r => getHighestPriorityStatus(r) === 'abschl-anderer-vp') ? 'status-abschl-anderer-vp' : ''}
          ${contact.residents?.some(r => getHighestPriorityStatus(r) === 'beraten') ? 'status-beraten' : ''}
          ${contact.residents?.some(r => getHighestPriorityStatus(r) === 'kein-interesse') && 
            contact.residents.every(r => !['abschluss', 'onlineabschluss', 'beraten', 'abschl-anderer-vp'].includes(getHighestPriorityStatus(r))) ? 'status-kein-interesse-red' : ''}" 
          onclick="toggleResidents(${contact.id})">
          <p>${contact.plz}</p>
          <p>${contact.ort}</p>
          <p>${contact.strasse} ${contact.nummer}</p>
          <p>${contact.zusatz ? `${contact.zusatz}` : ''}</p>
          <p>${contact.we ? `${contact.we} WE` : ''}</p>
          <div class="unit-info">
            ${contact.residents?.map((resident, index) => {
      const isInactive = resident?.statusHistory?.length > 0 ? Date.now() - resident.statusHistory.sort((a, b) => b.timestamp - a.timestamp)[0].timestamp > 28 * 24 * 60 * 60 * 1000 : !resident?.status;
      const nameClass = isInactive && getHighestPriorityStatus(resident) !== 'abschluss' ? 'inactive-resident' : '';
      return `
              <p>WE${index + 1}: <strong class="${nameClass}">${resident?.name || '-'}${resident?.notes ? '<span style="color: red">*</span>' : ''}</strong>${resident?.mieter ? ' (M)' : ''}${resident?.phone ? ` <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 4h4l2 5l-2.5 1.5a11 11 0 0 0 5 5l1.5 -2.5l5 2v4a2 2 0 0 1-2 2a16 16 0 0 1-15 -15a2 2 0 0 1 2 -2"></path></svg>` : ''}</p>
            `;
    }).join('') || '<p>-</p>'}
          </div>
          <div class="unit-info">
            ${contact.residents?.map((resident, index) => `
              <p>${getStatusLabel(getHighestPriorityStatus(resident)) || 'Kein Status'}</p>
            `).join('') || '<p>Kein Status</p>'}
          </div>
        </div>
        <div class="residents-section" style="display: none;">
          ${residentInputs}
        </div>
      `;
      if (expandedCards.has(contact.id.toString())) {
        contactCard.classList.add('expanded');
        const residentsSection = contactCard.querySelector('.residents-section');
        residentsSection.style.display = 'block';
      }
      contactList.appendChild(contactCard);
    });
    updateStatistics();
  }

  function applyFilters() {
    const searchTerm = (document.getElementById('searchInput').value || '').toLowerCase();
    const selectedStreet = document.getElementById('streetFilter').value;
    const filteredContacts = contacts.filter(contact => {
      if (!contact) return false;
      const searchMatch = (contact.plz?.toString() || '').includes(searchTerm) || 
                         (contact.ort?.toLowerCase() || '').includes(searchTerm) || 
                         (contact.strasse?.toLowerCase() || '').includes(searchTerm) || 
                         (contact.nummer?.toString() || '').includes(searchTerm) || 
                         (contact.zusatz?.toLowerCase() || '').includes(searchTerm) || 
                         (contact.we?.toString()?.toLowerCase() || '').includes(searchTerm) || 
                         contact.residents?.some(resident => resident?.name?.toLowerCase()?.includes(searchTerm)) || 
                         false;
      const statusMatch = currentFilter === 'all' || 
                         currentFilter !== 'offen' && 
                         currentFilter !== 'blacklist' && 
                         currentFilter !== 'nicht-vermarktbar' && 
                         contact.residents?.some(resident => getHighestPriorityStatus(resident) === currentFilter) || 
                         false;
      const streetMatch = selectedStreet === 'all' || contact.strasse === selectedStreet;
      return searchMatch && statusMatch && streetMatch;
    });
    renderContacts(filteredContacts);
    document.getElementById('streetFilter').value = selectedStreet;
  }

  function getStatusPriority(status) {
    const priorities = {
      'abschluss': 12,
      'onlineabschluss': 11,
      'abschl-anderer-vp': 10,
      'beraten': 9,
      'termin': 8,
      'wiedervorlage': 7,
      'kein-eintritt': 6,
      'kein-interesse': 5,
      'nicht-vermarktbar': 4,
      'blacklist': 3,
      'nicht-angetroffen': 2,
      'offen': 1,
      '': 0
    };
    return priorities[status] || 0;
  }

  function getHighestPriorityStatus(resident) {
    if (!resident?.statusHistory?.length) {
      return resident?.status || '';
    }

    return resident.statusHistory.reduce((highestStatus, entry) => {
      const currentPriority = getStatusPriority(entry.status);
      const highestPriority = getStatusPriority(highestStatus);
      return currentPriority > highestPriority ? entry.status : highestStatus;
    }, '');
  }

  function toggleCalendar() {
    const calendarDiv = document.getElementById('calendar');
    calendarDiv.style.display = calendarDiv.style.display === 'none' ? 'block' : 'none';
    if (calendarDiv.style.display === 'block') {
      renderCalendar();
    }
  }

  function getDayStats(date) {
    let startOfDay = new Date(date);
    startOfDay.setHours(0, 0, 0, 0);
    let endOfDay = new Date(date);
    endOfDay.setHours(23, 59, 59, 999);
    let total = 0;
    let completions = 0;
    contacts.forEach(contact => {
      if (contact.residents) {
        contact.residents.forEach(resident => {
          if (resident.statusHistory) {
            resident.statusHistory.forEach(entry => {
              const entryDate = new Date(entry.date);
              if (entryDate >= startOfDay && entryDate <= endOfDay) {
                total++;
                // Only count 'abschluss' status
                if (entry.status === 'abschluss') {
                  completions++;
                }
              }
            });
          }
        });
      }
    });
    return { total, completions };
  }

  function getMonthStats(year, month) {
    let totalCompletions = 0;
    contacts.forEach(contact => {
      if (contact.residents) {
        contact.residents.forEach(resident => {
          if (resident.statusHistory) {
            resident.statusHistory.forEach(entry => {
              const entryDate = new Date(entry.date);
              if (entryDate.getFullYear() === year && entryDate.getMonth() === month) {
                // Only count 'abschluss' status
                if (entry.status === 'abschluss') {
                  totalCompletions++;
                }
              }
            });
          }
        });
      }
    });
    return totalCompletions;
  }

  function calculateForecast(currentCompletions, currentDay, totalWorkdaysInMonth) {
    const workdaysElapsed = countWorkdaysSoFar(currentDay);
    if (workdaysElapsed === 0) return 0;
    const completionsPerWorkday = currentCompletions / workdaysElapsed;
    return Math.round(completionsPerWorkday * totalWorkdaysInMonth);
  }

  function countWorkdaysSoFar(currentDate) {
    let workdays = 0;
    const startOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    while (startOfMonth <= currentDate) {
      if (startOfMonth.getDay() !== 0 && startOfMonth.getDay() !== 6) {
        workdays++;
      }
      startOfMonth.setDate(startOfMonth.getDate() + 1);
    }
    return workdays;
  }

  function countWorkdaysInMonth(year, month) {
    let workdays = 0;
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    for (let day = 1; day <= daysInMonth; day++) {
      const date = new Date(year, month, day);
      if (date.getDay() !== 0 && date.getDay() !== 6) {
        workdays++;
      }
    }
    return workdays;
  }

  function previousMonth() {
    currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1);
    renderCalendar();
  }

  function nextMonth() {
    currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
    renderCalendar();
  }

  function toggleVisitRecommendation() {
    const content = document.getElementById('visitRecommendationContent');
    content.style.display = content.style.display === 'none' ? 'block' : 'none';
    if (content.style.display === 'block') {
      document.querySelectorAll('.recommendation-type-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector('.recommendation-type-btn:first-child').classList.add('active');
    }
  }

  function showVisitRecommendations() {
    const startTime = document.getElementById('startTime').value;
    const endTime = document.getElementById('endTime').value;
    const startMinutes = timeToMinutes(startTime);
    const endMinutes = timeToMinutes(endTime);
    const recommendations = [];
    contacts.forEach(contact => {
      if (contact.residents) {
        contact.residents.forEach(resident => {
          if (resident.statusHistory) {
            const lastStatus = resident.status;
            if (lastStatus === 'nicht-angetroffen') {
              const lastEntry = resident.statusHistory.filter(entry => entry.status === 'nicht-angetroffen').sort((a, b) => b.timestamp - a.timestamp)[0];
              if (lastEntry) {
                const visitTime = new Date(lastEntry.date);
                const visitMinutes = visitTime.getHours() * 60 + visitTime.getMinutes();
                if (visitMinutes < startMinutes || visitMinutes > endMinutes) {
                  recommendations.push({
                    contact: contact,
                    resident: resident,
                    unit: resident.unit,
                    lastVisit: visitTime
                  });
                }
              }
            }
          }
        });
      }
    });
    displayRecommendations(recommendations);
  }

  function timeToMinutes(timeString) {
    const [hours, minutes] = timeString.split(':').map(Number);
    return hours * 60 + minutes;
  }

  function displayRecommendations(recommendations) {
    const resultsDiv = document.getElementById('recommendationResults');
    if (recommendations.length === 0) {
      resultsDiv.innerHTML = `
        <p style="text-align: center; padding: 15px;">Keine Empfehlungen für diesen Zeitraum gefunden.</p>
        <button onclick="clearRecommendations()" class="delete-btn" style="position: static; margin: 10px auto; display: block;">Liste leeren</button>
      `;
      return;
    }
    recommendations.sort((a, b) => {
      const streetCompare = (a.contact.strasse || '').localeCompare(b.contact.strasse || '');
      if (streetCompare !== 0) return streetCompare;
      const numA = parseInt(a.contact.nummer) || 0;
      const numB = parseInt(b.contact.nummer) || 0;
      return numA - numB;
    });
    resultsDiv.innerHTML = `
      <button onclick="clearRecommendations()" class="delete-btn" style="position: static; margin: 10px auto; display: block;">Liste leeren</button>
      ${recommendations.map(rec => `
        <div class="recommended-contact">
          <div><strong>${rec.contact.strasse} ${rec.contact.nummer}${rec.contact.zusatz ? ` ${rec.contact.zusatz}` : ''}</strong></div>
          <div>WE ${rec.unit}: ${rec.resident.name || 'Unbekannt'}</div>
          <div class="last-visit-time">
            Letzter Besuch: ${rec.lastVisit.toLocaleString('de-DE', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  })} Uhr
          </div>
        </div>
      `).join('')}
    `;
  }

  function clearRecommendations() {
    const resultsDiv = document.getElementById('recommendationResults');
    resultsDiv.innerHTML = '';
  }

  // Debug: unsichtbarer Click-Logger zur Diagnose von Tap-Problemen
  (function setupClickLogger(){
    try {
      const loggerId = 'qt-debug-click-logger';
      if (document.getElementById(loggerId)) return;
      const log = document.createElement('div');
      log.id = loggerId;
      log.style.position = 'fixed';
      log.style.bottom = '8px';
      log.style.left = '8px';
      log.style.padding = '4px 6px';
      log.style.fontSize = '10px';
      log.style.background = 'rgba(37,99,235,0.08)';
      log.style.color = '#111';
      log.style.border = '1px solid rgba(37,99,235,0.25)';
      log.style.borderRadius = '6px';
      log.style.pointerEvents = 'none';
      log.style.zIndex = '2147483647';
      log.style.opacity = '0'; // unsichtbar
      document.body.appendChild(log);

      function write(msg){
        try {
          const ts = new Date().toLocaleTimeString('de-DE');
          log.textContent = `[${ts}] ${msg}`;
          console.log('[QT-Click]', msg);
        } catch(_){}
      }

      document.addEventListener('click', (e) => {
        const t = e.target;
        const isSidebar = !!t.closest && !!t.closest('.sidebar-nav');
        const href = t.getAttribute && t.getAttribute('href');
        const sec = href && href.startsWith('#') ? href.slice(1) : null;
        write(`Click target=${t.tagName}${isSidebar? ' [sidebar]':''} href=${href||'-'} sec=${sec||'-'}`);
      }, { capture: true });

      // Pointer-Events Diagnose
      document.querySelectorAll('.sidebar, .sidebar *').forEach(el => {
        const pe = window.getComputedStyle(el).pointerEvents;
        if (pe === 'none') {
          console.warn('[QT] pointer-events:none auf', el);
        }
      });

      // Z-Index Diagnose: prüfe Overlay über Sidebar
      setTimeout(() => {
        const sidebar = document.querySelector('.sidebar');
        if (!sidebar) return;
        const rect = sidebar.getBoundingClientRect();
        const el = document.elementFromPoint(rect.left + 10, rect.top + 10);
        if (el && !sidebar.contains(el)) {
          console.warn('[QT] Element über der Sidebar erkannt:', el);
        }
      }, 1000);
    } catch(e){ console.warn('Click-Logger Setup fehlgeschlagen:', e); }
  })();

  // Global verfügbar: navTo Fallback
  window.navTo = function(sectionId){
    try { showSection(sectionId); } catch(e) { console.error('[navTo]', e); }
    return false;
  };

  function $el(sel){ return document.querySelector(sel); }
  function setDisp(sel, val){ const n=$el(sel); if(n) n.style.display=val; }
  function addCls(sel, cls){ const n=$el(sel); if(n) n.classList.add(cls); }
  function rmCls(sel, cls){ document.querySelectorAll(sel).forEach(n=>n.classList.remove(cls)); }

  function showSection(sectionId) {
    try {
      rmCls('.sidebar-nav a','active');
      const navLink = document.querySelector(`.sidebar-nav a[href="#${sectionId}"]`);
      if (navLink) navLink.classList.add('active');

      document.querySelectorAll('.expanded').forEach(section => section.classList.remove('expanded'));

      // Alles ausblenden (nur wenn vorhanden)
      setDisp('.import-section','none');
      setDisp('.entry-section','none');
      setDisp('.calendar-section','none');
      setDisp('.statistics-section','none');
      setDisp('.visit-recommendation-box','none');
      setDisp('.search-box','none');
      setDisp('.status-filters','none');
      setDisp('.contact-list','none');
      setDisp('.street-filter-container','none');
      // Defensive: Nur setzen, wenn Container existiert
      if (document.querySelector('.import-export-buttons')) {
        setDisp('.import-export-buttons','flex');
      }
      const weSecHide = document.getElementById('weCorrectionsSection');
      if (weSecHide) { weSecHide.style.display = 'none'; weSecHide.innerHTML = ''; }

      switch (sectionId) {
        case 'contacts': {
          const we2 = document.getElementById('weCorrectionsSection');
          if (we2) { we2.style.display='none'; we2.innerHTML=''; }
          setDisp('.search-box','flex');
          setDisp('.status-filters','flex');
          setDisp('.contact-list','block');
          setDisp('.street-filter-container','block');
          if (typeof filterByStatus==='function') filterByStatus('all');
          break;
        }
        case 'import': {
          setDisp('.import-section','block');
          addCls('.import-section','expanded');
          break;
        }
        case 'add': {
          setDisp('.entry-section','block');
          addCls('.entry-section','expanded');
          break;
        }
        case 'stats': {
          setDisp('.statistics-section','block');
          const ss = document.getElementById('statusStats'); if (ss) ss.style.display='block';
          if (typeof updateStatistics==='function') updateStatistics();
          break;
        }
        case 'calendar': {
          setDisp('.calendar-section','block');
          const cal = document.getElementById('calendar'); if (cal) cal.style.display='block';
          if (typeof renderCalendar==='function') renderCalendar();
          break;
        }
        case 'recommendations': {
          setDisp('.visit-recommendation-box','block');
          const cnt = document.getElementById('visitRecommendationContent'); if (cnt) cnt.style.display='block';
          break;
        }
        case 'pdf-corrections': {
          const mount = document.getElementById('weCorrectionsSection');
          if (mount) { if (typeof renderWeCorrectionsList==='function') renderWeCorrectionsList(mount); mount.style.display='block'; }
          break;
        }
        default: {
          setDisp('.search-box','flex');
          setDisp('.status-filters','flex');
          setDisp('.contact-list','block');
          setDisp('.street-filter-container','block');
          break;
        }
      }
    } catch(e) {
      console.error('showSection error:', e);
    }

  }

  // Hash-Fallback: Wenn der Hash sich ändert (Default-Anchor), Sektion anzeigen
  window.addEventListener('hashchange', () => {
    const sec = (location.hash||'').slice(1);
    if (sec) showSection(sec);
  });

  function renderWeCorrectionsList(mountEl) {
    const container = mountEl || document.querySelector('#weCorrectionsSection');
    if (!container) return;

    // Kopf
    container.innerHTML = '';
    const title = document.createElement('h2');
    title.textContent = 'WE-Korrekturen';
    title.style.marginTop = '10px';

    const listWrap = document.createElement('div');
    listWrap.style.marginTop = '10px';

    const rows = [];
    contacts.forEach(contact => {
      (contact.weCorrections || []).forEach((c) => {
        rows.push({
          adresse: `${contact.strasse || ''} ${contact.nummer || ''}${contact.zusatz ? ' ' + contact.zusatz : ''}`.trim(),
          ort: `${contact.plz || ''} ${contact.ort || ''}`.trim(),
          originalWe: c.originalWe,
          correctedWe: c.correctedWe,
          hasGEE: c.hasGEE ? 'Ja' : 'Nein',
          reason: c.reason || '',
          date: c.date ? new Date(c.date).toLocaleString('de-DE') : ''
        });
      });
    });

    if (rows.length === 0) {
      listWrap.innerHTML = '<p style="text-align:center; padding: 10px; color:#6b7280;">Keine WE-Korrekturen vorhanden.</p>';
    } else {
      const table = document.createElement('table');
      table.style.width = '100%';
      table.style.borderCollapse = 'collapse';
      table.style.fontSize = '14px';

      const thead = document.createElement('thead');
      const headRow = document.createElement('tr');
      const headers = ['Adresse', 'Ort', 'Ursprüngliche WE', 'Korrigierte WE', 'GEE/VGM', 'Begründung', 'Datum'];
      headers.forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        th.style.textAlign = 'left';
        th.style.padding = '8px 6px';
        th.style.borderBottom = '1px solid #e5e7eb';
        headRow.appendChild(th);
      });
      thead.appendChild(headRow);

      const tbody = document.createElement('tbody');
      rows.forEach(r => {
        const tr = document.createElement('tr');
        [r.adresse, r.ort, r.originalWe, r.correctedWe, r.hasGEE, r.reason, r.date].forEach(val => {
          const td = document.createElement('td');
          td.textContent = String(val ?? '');
          td.style.padding = '8px 6px';
          td.style.borderBottom = '1px solid #f3f4f6';
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      table.appendChild(thead);
      table.appendChild(tbody);
      listWrap.appendChild(table);

      // Export-Button (Excel) oben rechts
      const exportBar = document.createElement('div');
      exportBar.style.display = 'flex';
      exportBar.style.justifyContent = 'flex-end';
      exportBar.style.margin = '10px 0';
      const btn = document.createElement('button');
      btn.textContent = 'WE-Korrekturen exportieren';
      btn.className = 'import-btn';
      btn.onclick = () => exportWECorrectionsToExcel();
      exportBar.appendChild(btn);

      container.appendChild(title);
      container.appendChild(exportBar);
      container.appendChild(listWrap);
    }
  }


  function showDeleteByPLZDialog() {
    document.getElementById('deletePLZDialog').style.display = 'block';
  }

  function closeDeletePLZDialog() {
    document.getElementById('deletePLZDialog').style.display = 'none';
    document.getElementById('plzToDelete').value = '';
  }

  function deleteByPLZ() {
    const plzToDelete = document.getElementById('plzToDelete').value;
    if (!plzToDelete || plzToDelete.length !== 5) {
      alert('Bitte geben Sie eine gültige PLZ ein');
      return;
    }
    const countBefore = contacts.length;
    contacts = contacts.filter(contact => contact.plz !== plzToDelete);
    const deleted = countBefore - contacts.length;
    if (deleted > 0) {
      alert(`${deleted} Adressen wurden gelöscht`);
      saveContacts();
      renderContacts();
      updateStreetFilter();
    } else {
      alert('Keine Adressen mit dieser PLZ gefunden');
    }
    closeDeletePLZDialog();
  }

  function showDeleteStreetDialog() {
    const dialog = document.getElementById('deleteStreetDialog');
    const select = document.getElementById('streetToDelete');
    while (select.options.length > 1) {
      select.remove(1);
    }
    const streets = [...new Set(contacts.map(c => c.strasse))].sort();
    streets.forEach(street => {
      const option = document.createElement('option');
      option.value = street;
      option.textContent = street;
      select.appendChild(option);
    });
    select.multiple = true;
    dialog.style.display = 'block';
  }

  function closeDeleteStreetDialog() {
    document.getElementById('deleteStreetDialog').style.display = 'none';
    document.getElementById('streetToDelete').value = '';
  }

  function deleteByStreet() {
    const streetSelect = document.getElementById('streetToDelete');
    const selectedStreets = Array.from(streetSelect.selectedOptions).map(option => option.value).filter(street => street);
    if (selectedStreets.length === 0) {
      alert('Bitte wählen Sie mindestens eine Straße aus');
      return;
    }
    const countBefore = contacts.length;
    contacts = contacts.filter(contact => !selectedStreets.includes(contact.strasse));
    const deleted = countBefore - contacts.length;
    if (deleted > 0) {
      alert(`${deleted} Adressen wurden gelöscht`);
      saveContacts();
      renderContacts();
      updateStreetFilter();
    } else {
      alert('Keine Adressen in den ausgewählten Straßen gefunden');
    }
    closeDeleteStreetDialog();
  }

  // Helper: Plattform/Nativ erkennen
  function isNativeApp() {
    try { return !!window.Capacitor && typeof window.Capacitor.getPlatform === 'function' && window.Capacitor.getPlatform() !== 'web'; }
    catch(_) { return false; }
  }
  // Helper: Blob -> Base64 (ohne Prefix)
  function blobToBase64(blob) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onerror = reject;
      reader.onload = () => {
        const res = String(reader.result || '');
        const base64 = res.includes(',') ? res.split(',', 2)[1] : res;
        resolve(base64);
      };
      reader.readAsDataURL(blob);
    });
  }
  function getCapPlugin(name){
    try {
      if (window.Capacitor && window.Capacitor.Plugins && window.Capacitor.Plugins[name]) return window.Capacitor.Plugins[name];
      if (window.__CapHelper && window.__CapHelper.getPlugin) return window.__CapHelper.getPlugin(name);
    } catch(_){}
    return null;
  }

  function exportToCSV() {
    const headers = ['PLZ', 'Ort', 'Strasse', 'Nummer', 'Zusatz', 'WE', 'BewohnerName', 'BewohnerTelefon', 'Status', 'Notizen', 'IstMieter', 'StatusVerlauf'];
    let csvContent = headers.join(',') + '\n';
    contacts.forEach(contact => {
      if (!contact.residents || contact.residents.length === 0) {
        const row = [contact.plz || '', contact.ort || '', contact.strasse || '', contact.nummer || '', contact.zusatz || '', contact.we || '', '', '', '', '', '', ''].map(field => `"${(field + '').replace(/"/g, '""')}"`);
        csvContent += row.join(',') + '\n';
      } else {
        contact.residents.forEach(resident => {
          const row = [contact.plz || '', contact.ort || '', contact.strasse || '', contact.nummer || '', contact.zusatz || '', contact.we || '', resident.name || '', resident.phone || '', resident.status || '', resident.notes || '', resident.mieter ? 'true' : 'false', JSON.stringify(resident.statusHistory || [])].map(field => `"${(field + '').replace(/"/g, '""')}"`);
          csvContent += row.join(',') + '\n';
        });
      }
    });
    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const filename = `qualifizierungen_${new Date().toISOString().split('T')[0]}.csv`;

    // Native App (APK): über Filesystem speichern + Share-Dialog öffnen
    if (isNativeApp()) {
      (async () => {
        try {
          const base64 = await blobToBase64(blob);
          const Filesystem = getCapPlugin('Filesystem');
          const Share = getCapPlugin('Share');
          if (!Filesystem || !Share) throw new Error('Capacitor Plugins nicht verfügbar');

          await Filesystem.writeFile({ path: filename, data: base64, directory: 'CACHE', recursive: false });
          const uriRes = await Filesystem.getUri({ path: filename, directory: 'CACHE' });
          await Share.share({ title: 'Qualis exportieren (CSV)', url: uriRes.uri, dialogTitle: 'Datei teilen / speichern' });
        } catch (err) {
          console.warn('Native CSV-Export fehlgeschlagen, Fallback Browser:', err?.message||err);
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url; link.download = filename; link.click();
          URL.revokeObjectURL(url);
        }
      })();
      return;
    }

    // Browser: klassisch speichern
    if ('showSaveFilePicker' in window) {
      const opts = { suggestedName: filename, types: [{ description: 'CSV-Datei', accept: { 'text/csv': ['.csv'] } }] };
      window.showSaveFilePicker(opts)
        .then(handle => handle.createWritable())
        .then(writable => writable.write(blob).then(() => writable.close()))
        .catch(() => {
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a'); link.href = url; link.download = filename; link.click();
          URL.revokeObjectURL(url);
        });
    } else {
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a'); link.href = url; link.download = filename; link.click();
      URL.revokeObjectURL(url);
    }
  }

  function getMonthStats(year, month) {
    let totalCompletions = 0;
    contacts.forEach(contact => {
      if (contact.residents) {
        contact.residents.forEach(resident => {
          if (resident.statusHistory) {
            resident.statusHistory.forEach(entry => {
              const entryDate = new Date(entry.date);
              if (entryDate.getFullYear() === year && entryDate.getMonth() === month) {
                // Only count 'abschluss' status
                if (entry.status === 'abschluss') {
                  totalCompletions++;
                }
              }
            });
          }
        });
      }
    });
    return totalCompletions;
  }

  function calculateForecast(currentCompletions, currentDay, totalWorkdaysInMonth) {
    const workdaysElapsed = countWorkdaysSoFar(currentDay);
    if (workdaysElapsed === 0) return 0;
    const completionsPerWorkday = currentCompletions / workdaysElapsed;
    return Math.round(completionsPerWorkday * totalWorkdaysInMonth);
  }

  function countWorkdaysSoFar(currentDate) {
    let workdays = 0;
    const startOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    while (startOfMonth <= currentDate) {
      if (startOfMonth.getDay() !== 0 && startOfMonth.getDay() !== 6) {
        workdays++;
      }
      startOfMonth.setDate(startOfMonth.getDate() + 1);
    }
    return workdays;
  }

  function countWorkdaysInMonth(year, month) {
    let workdays = 0;
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    for (let day = 1; day <= daysInMonth; day++) {
      const date = new Date(year, month, day);
      if (date.getDay() !== 0 && date.getDay() !== 6) {
        workdays++;
      }
    }
    return workdays;
  }

  function deleteHistoryEntry(contactId, unitNumber, timestamp) {
    const contact = contacts.find(c => c.id === contactId);
    if (!contact || !contact.residents) return;
    const resident = contact.residents.find(r => r.unit === unitNumber);
    if (!resident || !resident.statusHistory) return;
    resident.statusHistory = resident.statusHistory.filter(entry => entry.timestamp !== timestamp);
    if (resident.statusHistory.length > 0) {
      const lastEntry = resident.statusHistory.sort((a, b) => b.timestamp - a.timestamp)[0];
      resident.status = lastEntry.status;
    } else {
      resident.status = '';
    }
    saveContacts();
    renderContacts();
  }

  function openWeCorrectModal(contactId) {
    const contact = contacts.find(c => String(c.id) === String(contactId));
    if (!contact) return;
    const modal = document.getElementById('weCorrectModal');
    const currentWeCountInput = document.getElementById('currentWeCount');
    const correctedWeCountInput = document.getElementById('correctedWeCount');
    const weCorrectReasonInput = document.getElementById('weCorrectReason');
    const manualCurrentWeInput = document.getElementById('manualCurrentWe');
    const hasGEEInput = document.getElementById('hasGEE');
    currentWeCountInput.value = (contact.manualCurrentWe !== undefined ? contact.manualCurrentWe : (contact.we || '0')) || '0';
    correctedWeCountInput.value = (contact.we || '0');
    weCorrectReasonInput.value = '';
    manualCurrentWeInput.checked = (contact.manualCurrentWe !== undefined);
    hasGEEInput.checked = false;
    modal.dataset.contactId = String(contactId);
    modal.style.display = 'block';
  }

  function saveWeCorrection() {
    const modal = document.getElementById('weCorrectModal');
    const contactIdStr = modal.dataset.contactId;
    const contact = contacts.find(c => String(c.id) === String(contactIdStr));
    if (!contact) return;
    const manualCurrentWeInput = document.getElementById('manualCurrentWe');
    const hasGEEInput = document.getElementById('hasGEE');
    const currentWeCountInput = document.getElementById('currentWeCount');
    const correctedWeCountInput = document.getElementById('correctedWeCount');
    const weCorrectReasonInput = document.getElementById('weCorrectReason');
    const currentWeCount = manualCurrentWeInput.checked ? parseInt(currentWeCountInput.value || '0') : parseInt(contact.we || '0') || 0;
    const correctedWeCount = parseInt(correctedWeCountInput.value || '0') || 0;
    const weCorrectReason = weCorrectReasonInput.value.trim();
    const hasGEE = hasGEEInput.checked;
    if (manualCurrentWeInput.checked) {
      contact.manualCurrentWe = currentWeCount;
    } else {
      delete contact.manualCurrentWe;
    }
    const correction = {
      originalWe: currentWeCount,
      correctedWe: correctedWeCount,
      reason: weCorrectReason,
      hasGEE: hasGEE,
      date: new Date().toISOString()
    };
    if (modal.dataset.isEdit === 'true') {
      const correctionIndex = parseInt(modal.dataset.correctionIndex || '0') || 0;
      contact.weCorrections[correctionIndex] = correction;
    } else {
      if (!contact.weCorrections) {
        contact.weCorrections = [];
      }
      contact.weCorrections.push(correction);
    }
    contact.we = String(correctedWeCount);
    if (correctedWeCount < (contact.residents?.length || 0)) {
      contact.residents = contact.residents.slice(0, correctedWeCount);
    } else if (correctedWeCount > (contact.residents?.length || 0)) {
      contact.residents = contact.residents || [];
      while (contact.residents.length < correctedWeCount) {
        contact.residents.push({
          unit: contact.residents.length + 1,
          name: '',
          phone: '',
          status: '',
          notes: '',
          mieter: false,
          statusHistory: []
        });
      }
    }
    saveContacts();
    renderContacts();
    closeWeCorrectModal();
  }

  function closeWeCorrectModal() {
    const modal = document.getElementById('weCorrectModal');
    modal.style.display = 'none';
    modal.dataset.isEdit = 'false';
    delete modal.dataset.correctionIndex;
  }

  function exportWECorrectionsToExcel() {
    const workbook = XLSX.utils.book_new();
    const tableData = contacts.flatMap(contact => {
      if (!contact.weCorrections || contact.weCorrections.length === 0) return [];
      return contact.weCorrections.map(correction => ({
        Adresse: `${contact.strasse} ${contact.nummer}${contact.zusatz ? ` ${contact.zusatz}` : ''}`,
        Ort: `${contact.plz} ${contact.ort}`,
        'Ursprüngliche WE': correction.originalWe,
        'Korrigierte WE': correction.correctedWe,
        'GEE/VGM vorhanden': correction.hasGEE ? 'Ja' : 'Nein',
        Begründung: correction.reason,
        Datum: new Date(correction.date).toLocaleString('de-DE')
      }));
    });
    const worksheet = XLSX.utils.json_to_sheet(tableData);
    XLSX.utils.book_append_sheet(workbook, worksheet, 'WE-Korrekturen');
    const filename = `WE-Korrekturen_${new Date().toISOString().split('T')[0]}.xlsx`;
    XLSX.writeFile(workbook, filename);
  }

  function editWeCorrection(contactId, correctionIndex) {
    const contact = contacts.find(c => c.id === contactId);
    if (!contact || !contact.weCorrections) return;
    const correction = contact.weCorrections[correctionIndex];
    const modal = document.getElementById('weCorrectModal');
    const currentWeCountInput = document.getElementById('currentWeCount');
    const correctedWeCountInput = document.getElementById('correctedWeCount');
    const weCorrectReasonInput = document.getElementById('weCorrectReason');
    const manualCurrentWeInput = document.getElementById('manualCurrentWe');
    const hasGEEInput = document.getElementById('hasGEE');
    currentWeCountInput.value = correction.originalWe;
    correctedWeCountInput.value = correction.correctedWe;
    weCorrectReasonInput.value = correction.reason;
    manualCurrentWeInput.checked = true;
    hasGEEInput.checked = correction.hasGEE;
    modal.dataset.contactId = contactId;
    modal.dataset.correctionIndex = correctionIndex;
    modal.dataset.isEdit = 'true';
    modal.style.display = 'block';
  }

  function importFromExcel(file) {
    const reader = new FileReader();

    // Helper: mehrere mögliche Header-Namen erlauben
    function getField(row, keys) {
      for (const k of keys) {
        if (Object.prototype.hasOwnProperty.call(row, k) && row[k] != null) return row[k];
      }
      return undefined;
    }

    function parseBoolean(val) {
      if (typeof val === 'boolean') return val;
      if (val == null) return false;
      const s = String(val).trim().toLowerCase();
      return ['true','1','ja','j','y','yes','wahr','x'].includes(s);
    }

    function safeParseJSON(val, fallback) {
      try {
        if (val == null || val === '') return fallback;
        if (typeof val !== 'string') return Array.isArray(val) ? val : fallback;
        return JSON.parse(val);
      } catch { return fallback; }
    }

    reader.onload = function(e) {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(firstSheet);

        // Nutzerentscheidung: Hinzufügen (OK) oder Überschreiben (Abbrechen)?
        const shouldAppend = confirm("Möchten Sie die Daten aus der Excel-Datei zu den bestehenden Einträgen hinzufügen?\n\n- OK: Hinzufügen\n- Abbrechen: Bestehende Liste ersetzen");

        // Temporäre Gruppierung nach Adresse
        const addressMap = new Map();

        rows.forEach(row => {
          const plz = getField(row, ['PLZ']);
          const ort = getField(row, ['Ort']);
          const strasse = getField(row, ['Straße','Strasse']);
          const nummer = getField(row, ['Nummer','Nr.']);
          const zusatz = getField(row, ['Zusatz']) || '';
          const we = getField(row, ['WE']);
          const addressKey = `${plz}_${strasse}_${nummer}_${zusatz || ''}`;

          if (!addressMap.has(addressKey)) {
            addressMap.set(addressKey, {
              id: Date.now() + Math.random(),
              plz, ort, strasse, nummer, zusatz,
              we,
              manualCurrentWe: getField(row, ['Aktuelle WE']) || undefined,
              weCorrections: safeParseJSON(getField(row, ['WE Korrekturen']), []),
              residents: []
            });
          }

          const hasBewohner = getField(row, ['Bewohner']);
          const statusVal = getField(row, ['Status']);
          if (hasBewohner || statusVal) {
            const contact = addressMap.get(addressKey);
            contact.residents.push({
              unit: contact.residents.length + 1,
              name: hasBewohner || '',
              phone: getField(row, ['Telefon']) || '',
              status: statusVal || '',
              notes: getField(row, ['Notizen']) || '',
              mieter: parseBoolean(getField(row, ['Mieter'])),
              statusHistory: safeParseJSON(getField(row, ['Statusverlauf','StatusVerlauf']), [])
            });
          }
        });

        const importedContacts = Array.from(addressMap.values());

        if (shouldAppend) {
          contacts = sortContacts([...(contacts || []), ...importedContacts]);
        } else {
          contacts = sortContacts(importedContacts);
        }

        saveContacts();
        updateStreetFilter();
        renderContacts();

        alert(`Import erfolgreich: ${importedContacts.length} Adressen ${shouldAppend ? 'hinzugefügt' : 'importiert'}`);

      } catch (err) {
        console.error('Import failed:', err);
        alert('Fehler beim Import: ' + err.message);
      }
    };

    reader.onerror = err => {
      console.error('FileReader error:', err);
      alert('Fehler beim Lesen der Datei');
    };

    reader.readAsArrayBuffer(file);
  }

  async function exportToExcel() {
    // Create array of objects in the format needed for XLSX
    const exportData = contacts.map(contact => {
      // For contacts without residents, create one row with basic info
      if (!contact.residents || contact.residents.length === 0) {
        return {
          'PLZ': contact.plz,
          'Ort': contact.ort,
          'Straße': contact.strasse,
          'Nummer': contact.nummer,
          'Zusatz': contact.zusatz,
          'WE': contact.we,
          'Bewohner': '',
          'Telefon': '',
          'Status': '',
          'Notizen': '',
          'Mieter': '',
          'Statusverlauf': '',
          'Aktuelle WE': contact.manualCurrentWe || '',
          'WE Korrekturen': JSON.stringify(contact.weCorrections || [])
        };
      }
    
      // For contacts with residents, create one row per resident
      return contact.residents.map(resident => ({
        'PLZ': contact.plz,
        'Ort': contact.ort,
        'Straße': contact.strasse,
        'Nummer': contact.nummer,
        'Zusatz': contact.zusatz,
        'WE': contact.we,
        'Bewohner': resident.name,
        'Telefon': resident.phone,
        'Status': resident.status,
        'Notizen': resident.notes,
        'Mieter': resident.mieter ? 'true' : 'false',
        'Statusverlauf': JSON.stringify(resident.statusHistory || []),
        'Aktuelle WE': contact.manualCurrentWe || '',
        'WE Korrekturen': JSON.stringify(contact.weCorrections || [])
      }));
    }).flat();

    // Create a new workbook and add the data
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(exportData);
    XLSX.utils.book_append_sheet(wb, ws, "Qualifizierungen");
  
    // Save/Share
    const filename = `qualifizierungen_${new Date().toISOString().split('T')[0]}.xlsx`;

    // Native App: über Filesystem + Share teilen
    if (isNativeApp()) {
      try {
        const wbArray = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
        const blob = new Blob([wbArray], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const base64 = await blobToBase64(blob);
        const Filesystem = getCapPlugin('Filesystem');
        const Share = getCapPlugin('Share');
        if (!Filesystem || !Share) throw new Error('Capacitor Plugins nicht verfügbar');
        await Filesystem.writeFile({ path: filename, data: base64, directory: 'CACHE', recursive: false });
        const uriRes = await Filesystem.getUri({ path: filename, directory: 'CACHE' });
        await Share.share({ title: 'Qualis exportieren (Excel)', url: uriRes.uri, dialogTitle: 'Datei teilen / speichern' });
      } catch (err) {
        console.warn('Native Excel-Export fehlgeschlagen, Fallback Browser:', err?.message||err);
        XLSX.writeFile(wb, filename);
      }
      return;
    }

    // Browser: klassisch herunterladen
    XLSX.writeFile(wb, filename);
  }

  document.addEventListener('DOMContentLoaded', () => {
    // Initial Hash berücksichtigen (z.B. Direktaufruf mit #import)
    const initial = (location.hash||'').slice(1);
    if (initial) {
      try { showSection(initial); } catch(e) { console.warn('init hash failed', e); }
    }
    // Defensive: Event-Delegation auf der Sidebar, falls einzelne Links nicht binden
    const sidebar = document.querySelector('.sidebar');
    if (sidebar) {
      sidebar.addEventListener('click', function(e){
        const a = e.target.closest && e.target.closest('a[href^="#"]');
        if (!a) return;
        e.preventDefault();
        const sectionId = (a.getAttribute('href')||'').slice(1);
        if (sectionId) showSection(sectionId);
      }, { passive: false });
    }

    document.querySelectorAll('.sidebar-nav a').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        const sectionId = (this.getAttribute('href')||'').replace('#', '');
        if (!sectionId) return;
        showSection(sectionId);
      }, { passive: true });
    });
  
    // Supabase Client Init (robust: funktioniert auch ohne Internet)
    let supa = null;
    try {
      const SUPABASE_URL = 'https://whigasnqcvjkilkmbfld.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndoaWdhc25xY3Zqa2lsa21iZmxkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQyNDE1OTIsImV4cCI6MjA2OTgxNzU5Mn0.tfUnIP_oWy3N9UM6Ws9mPiKqsGtj8_kIOMW42E298rc';
      if (window.supabase && typeof window.supabase.createClient === 'function') {
        supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: false } });
      }
    } catch (e) {
      console.warn('Supabase init skipped (offline):', e?.message || e);
      supa = null;
    }

    async function requireAuthOrRedirect(){
      try {
        // Offline-/No-CDN-Fallback ZUERST prüfen, wenn bereits einmal eingeloggt wurde
        const offlineAllowed = localStorage.getItem('offline_allowed') === 'true';
        const lastUser = localStorage.getItem('last_user_id');
        if (offlineAllowed && lastUser) {
          return { id: lastUser };
        }
        
        // Online-Fall: Supabase verfügbar -> Sitzung prüfen
        if (supa) {
          const { data: { session } } = await supa.auth.getSession();
          if (!session) { window.location.href = './login.html'; return null; }
          return session.user;
        }
        
        // Sonst zur Login-Seite leiten
        window.location.href = './login.html';
        return null;
      } catch (e) {
        console.warn('Auth check failed; redirecting to login unless offline allowed:', e?.message || e);
        const offlineAllowed = localStorage.getItem('offline_allowed') === 'true';
        const lastUser = localStorage.getItem('last_user_id');
        if (offlineAllowed && lastUser) { return { id: lastUser }; }
        window.location.href = './login.html';
        return null;
      }
    }

    class CloudSync {
      constructor(){ this.syncing = false; }
      async getCloudContacts(){
        const { data, error } = await supa.from('user_contacts').select('contacts').single();
        if (error && error.code !== 'PGRST116') throw error;
        return (data && data.contacts) ? data.contacts : [];
      }
      async upsertCloud(contacts){
        const { data: { user } } = await supa.auth.getUser();
        const { error } = await supa.from('user_contacts').upsert({ user_id: user.id, contacts }, { onConflict: 'user_id' });
        if (error) throw error;
      }
    }

    const cloudSync = new CloudSync();

    // Logout support (minimal, ohne UI-Layout zu verändern)
    async function signOut() {
      try {
        await supa.auth.signOut();
      } catch (e) {
        console.warn('Signout Warnung:', e?.message || e);
      } finally {
        try { localStorage.removeItem('contacts'); } catch {}
        window.location.href = './login.html';
      }
    }

    // Globale Navigation als Fallback (funktioniert auch ohne Listener)
    window.navTo = function(sectionId){
      try { showSection(sectionId); } catch(e) { console.error(e); }
      return false;
    };

    // Hook into existing lifecycle after DOMContentLoaded at the bottom, without UI changes

    document.querySelector('.import-export-buttons').innerHTML = `
      <button onclick="document.getElementById('excelImport').click()" class="import-btn">Qualis importieren</button>
      <button onclick="exportToExcel()" class="import-btn">Qualis exportieren</button>
      <input type="file" id="excelImport" style="display: none" accept=".xlsx,.xls" onchange="importFromExcel(this.files[0])">
    `;
  
    // Initialisieren sobald DOM geladen ist (direkt ausführen)
    (async () => {
      const user = await requireAuthOrRedirect();
      if (!user) return;

      // Vorhandene lokale Daten laden
      try {
        const localContacts = JSON.parse(localStorage.getItem('contacts')||'[]');
        if (!localContacts || !Array.isArray(localContacts)) {
          localStorage.setItem('contacts','[]');
        }
      } catch { localStorage.setItem('contacts','[]'); }

      // Originale Initialisierung: Immer zuerst zur Adressliste (Kontaktliste)
      showSection('contacts');
      filterByStatus('all');
      updateStreetFilter();

      // saveContacts erweitern, ohne UI zu ändern
      const _save = window.saveContacts;
      window.saveContacts = function(){
        try { _save && _save(); } catch(e) { console.error(e); }
        // Hintergrund-Sync (best effort)
        const data = JSON.parse(localStorage.getItem('contacts')||'[]');
        cloudSync.upsertCloud(data).catch(err => console.warn('Cloud Sync Fehler:', err.message || err));
      };

      // Erste Synchronisierung: Cloud -> Lokal (keine UI-Änderung)
      try {
        const cloud = await cloudSync.getCloudContacts();
        if (Array.isArray(cloud) && cloud.length > 0) {
          localStorage.setItem('contacts', JSON.stringify(cloud));
          renderContacts();
          updateStreetFilter();
        }
      } catch(e){ console.warn('Initiale Cloud-Sync Warnung:', e.message||e); }
    })();

    Promise.all([loadScript("https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js")]).then(() => {}).catch(error => {
      console.error('Failed to load libraries', error);
    });
  });


  function updateStatistics() {
    const statsGrid = document.getElementById('statsGrid');
    if (!statsGrid) return;

    // Reset statistics grid
    statsGrid.innerHTML = '';

    // Initialize counters for each status
    const statusCounts = {
      'offen': 0,
      'nicht-angetroffen': 0,
      'kein-eintritt': 0,
      'wiedervorlage': 0,
      'termin': 0,
      'beraten': 0,
      'kein-interesse': 0,
      'abschluss': 0,
      'onlineabschluss': 0,
      'nicht-vermarktbar': 0,
      'blacklist': 0,
      'abschl-anderer-vp': 0
    };

    let totalUnits = 0;
    let totalStatusChanges = 0;
    let totalCompletions = 0;

    // Count statuses and total status changes
    contacts.forEach(contact => {
      const weCount = parseInt(contact.we) || 0;
      totalUnits += weCount;
    
      if (contact.residents) {
        contact.residents.forEach(resident => {
          const highestStatus = getHighestPriorityStatus(resident);
          if (highestStatus && statusCounts.hasOwnProperty(highestStatus)) {
            statusCounts[highestStatus]++;
            if (highestStatus === 'abschluss' || highestStatus === 'onlineabschluss') {
              totalCompletions++;
            }
          }
          // Count total status changes from history
          if (resident.statusHistory) {
            totalStatusChanges += resident.statusHistory.length;
          }
        });
      }
    });

    // Calculate total processed units (units with any status)
    const processedUnits = Object.values(statusCounts).reduce((a, b) => a + b, 0);

    // Create and append stat cards
    Object.entries(statusCounts).forEach(([status, count]) => {
      const percentage = totalUnits > 0 ? (count / totalUnits * 100).toFixed(1) : '0.0';
      const card = document.createElement('div');
      card.className = `stat-card status-${status}`;
      card.innerHTML = `
        <div class="stat-number">${count}</div>
        <div class="stat-label">${getStatusLabel(status)}</div>
        <div class="stat-percentage">${percentage}%</div>
      `;
      statsGrid.appendChild(card);
    });

    // Add total stats for units
    const totalCard = document.createElement('div');
    totalCard.className = 'stat-card';
    const totalPercentage = totalUnits > 0 ? (processedUnits / totalUnits * 100).toFixed(1) : '0.0';
    totalCard.innerHTML = `
      <div>${processedUnits} / ${totalUnits}</div>
      <div class="stat-label">Bearbeitete Einheiten</div>
      <div class="stat-percentage">${totalPercentage}%</div>
    `;
    statsGrid.appendChild(totalCard);

    // Add total status changes card
    const statusChangesCard = document.createElement('div');
    statusChangesCard.className = 'stat-card';
    const changesPerCompletion = totalCompletions > 0 ? (totalStatusChanges / totalCompletions).toFixed(1) : '0.0';
    statusChangesCard.innerHTML = `
      <div>${totalStatusChanges}</div>
      <div class="stat-label">Statusänderungen gesamt</div>
      <div class="stat-percentage">${changesPerCompletion} pro Abschluss</div>
    `;
    statsGrid.appendChild(statusChangesCard);
  }

  function toggleStatistics() {
    const statsDiv = document.getElementById('statusStats');
    statsDiv.style.display = statsDiv.style.display === 'none' ? 'block' : 'none';
    if (statsDiv.style.display === 'block') {
      updateStatistics();
    }
  }
</script>
</body>
</html>