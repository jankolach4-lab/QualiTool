<analysis>Here is a detailed handover summary for the next agent.

**original_problem_statement**: The user wants to continue development on the QualiTool Android app and its accompanying Admin-Dashboard-Pro.

Initial work focused on fixing critical bugs and implementing a multi-project filtering feature in the QualiTool app. This included resolving a data-wiping Supabase sync issue, debugging in-app updates, and fixing UI timing problems with new filter dropdowns.

Subsequently, the user reported a series of issues in the Next.js Admin-Dashboard-Pro, including:
-   Incorrect statistics in the project status breakdown.
-   Onlineabschlüsse (online completions) not appearing on the map view.
-   Incorrect percentage calculations in project analytics due to using the wrong total WE (Wohn-Einheiten/residential units).
-   Issues with the in-app update mechanism in the QualiTool app itself.
-   Bugs in the polygon address import feature in QualiTool (WE defaulting to 0, addresses not being assigned a project).
-   A new request to integrate a standalone adress-unifier.html tool into the admin dashboard.
-   Requests for new analytics features, such as a project forecast chart and enhanced VP analytics.
-   Problems with chart color contrast.
-   An issue where Excel was auto-formatting text values as dates in the address unifier tool.
-   Incorrect WE counts on the main project overview page.
-   A logout error.
-   Ghost projects appearing in the dashboard due to localStorage caching.
-   The most recent request is to investigate and fix a suspected bug where deleting all contacts in the QualiTool app breaks the Supabase synchronization.

**User's preferred language**: Deutsch (German)

**what currently exists?**
The workspace contains a full-stack application with two main parts:
1.  **QualiTool (Mobile App)**: A legacy monolithic frontend application () built with vanilla JavaScript and wrapped in Capacitor for Android. It is used by field agents to manage contacts, track statuses, and sync data with a Supabase backend.
2.  **Admin-Dashboard-Pro**: A modern Next.js web application () that provides analytics, data visualization (tables, charts, maps), and administrative tools based on the data synced from the QualiTool app. It includes a project forecast chart, detailed VP analytics, and an integrated Address Unifier tool.

**Last working item**:
*   **Last item agent was working**: Implementing two preventative fixes in  to make the synchronization logic more robust, specifically addressing issues when a user deletes all contacts.
    1.  A  flag for the  function to allow a deliberate sync of an empty contact list, bypassing the normal critical guard.
    2.  A timeout mechanism for the  lock to prevent the app from getting stuck in a deadlock if a sync operation fails silently.
*   **Status**: 
*   **Agent Testing Done**: N
*   **Which testing method agent to use?**: manual testing by curl. The next agent needs to test the following flow in the QualiTool preview:
    1.  Open the app and ensure contacts are loaded.
    2.  Click the Alle Adressen löschen button.
    3.  Verify in the developer console logs that the sync is correctly blocked by the critical guard.
    4.  Click the button again (within the confirmation dialog) to trigger the  path.
    5.  Verify the logs show the sync is now proceeding with the flag.
*   **User Testing Done**: N

**All Pending/In progress Issue list**:
*   **Issue 1**: Sync-related issues in QualiTool persist under specific conditions (P0). The user suspects deleting all contacts is a trigger. The agent has started implementing fixes but was interrupted.

    **Issues Detail**:
    *   **Issue 1: Finalize Sync Robustness Fixes**
        *   **Attempted fixes**: The agent was in the process of editing  to add a  flag and a timeout to the  lock. The edits for the guards were made, but the  timeout logic was not fully completed before the user forked.
        *   **Next debug checklist**:
            1.  Review the  and  functions in  to ensure the  flag logic is correctly implemented and resets properly.
            2.  Review all calls to  and  to ensure the  lock is correctly set and, crucially, **unlocked** in all  blocks.
            3.  Implement the timeout for the  lock as planned, ensuring it resets the lock after a reasonable duration (e.g., 30 seconds) to prevent deadlocks.
        *   **Why fix this issue and what will be achieved with the fix?**: This will prevent the app from getting into an unrecoverable state where synchronization stops working, which currently forces users to reinstall the app. It will make the app more resilient to edge cases like intentionally clearing all data.
        *   **Status**: 
        *   **Is recurring issue?**: Y
        *   **Should Test frontend/backend/both after fix?**: Frontend
        *   **Blocked on other issue**: None

**In progress Task List**:
*   **Task 1**: Complete the implementation of sync robustness fixes. (P0)
    **Task Detail**:
    *   **Task 1: Finalize Sync Fixes Implementation**
        *   **Where to resume**: The agent had just applied several edits to . The last action was adding a  to  to act as a fail-safe for the  lock. The agent needs to verify all edits are correct, complete, and then test the functionality.
        *   **What will be achieved with this?**: A more stable and reliable data synchronization mechanism in the QualiTool app, preventing freezes and data loss scenarios.
        *   **Status**: 
        *   **Should Test frontend/backend/both after fix?**: Frontend
        *   **Blocked on something**: None

**Upcoming and Future Tasks**
*   There are no explicitly defined upcoming or future tasks. The primary focus is on stabilizing the current feature set.

**Completed work in this session**
*   List of all completed tasks with file and method name:
    *   **Admin Dashboard: WE Calculation Fix (DONE)**
        *   Corrected the logic in  to properly parse the  field as a number from , ensuring the total WE sum is accurate, not just a count of addresses.
    *   **Admin Dashboard: Ghost Project Cache Fix (DONE)**
        *   Removed logic in  that was incorrectly recreating projects from stale  entries (e.g., Wiesbaden).
        *   Added a one-time  call to clean up old keys.
    *   **Admin Dashboard: Logout Functionality (DONE)**
        *   Made the logout function in  more robust by adding a  block to ensure redirection to the login page occurs even if  fails.
    *   **Address Unifier: Excel Data Type Fix (DONE)**
        *   Modified the file processing in  to explicitly set the cell type to text () during Excel export, preventing auto-formatting issues (e.g., /1 becoming a date).
    *   **Admin Dashboard: Chart Color Palette (DONE)**
        *   Iteratively updated and finally fixed the color mapping in  and  to use a user-provided, high-contrast color palette consistently across all charts.
    *   **Admin Dashboard: VP Analytics Enhancements (DONE)**
        *   Added new metrics to the Zusammenfassung card in : Anteil Abschlüsse im eigenen Gebiet and Statusänderungen pro Abschluss.
        *   Added percentage values to the Status-Breakdown chart for VPs.
    *   **Admin Dashboard: Project Forecast Chart (DONE)**
        *   Added a new Project Projection chart component ( integrated into ) with a dynamic Y-axis and a historical forecast line.
    *   **Admin Dashboard: Address Unifier Integration (DONE)**
        *   Integrated the user-provided  tool into a new Next.js page at  and added a link to it in the .
    *   **QualiTool: In-App Update Bug (DONE)**
        *   Fixed a critical bug where the  was hardcoded in , causing updates to fail. The version is now dynamically set from  during the build process. Version was bumped to .
    *   **QualiTool: Polygon Import Bugs (DONE)**
        *   Fixed logic in  to default  to , implement reverse geocoding for city detection, and improve address parsing, reducing Unbekannt projects. Version was bumped to .
    *   **QualiTool: Critical Sync Deadlock (DONE)**
        *   Fixed a race condition and improved error handling in the sync logic in . Version was bumped to .
    *   **QualiTool & Admin Dashboard: Multi-Project Filter & Analytics Bugs (DONE)**
        *   Fixed numerous bugs related to the initial multi-project feature implementation across both applications. Version was bumped to .

**Earlier issues found/mentioned but not fixed**
*   None. The agent has been diligent in addressing all user-reported issues.

**Known issue recurrence from previous fork**
*   **Issue recurrence in previous fork**: The core issue of Supabase sync failures and data loss has been a recurring theme throughout the project. It has manifested as data being wiped, syncs failing silently, and the app entering a deadlock state.
*   **Recurrence count**: At least 3 major instances (initial data wipe, post-update sync failure, deadlock requiring reinstall).
*   **Status**:  (The current work is the latest attempt to make the sync logic fully robust).

**Code Architecture**


**Key Technical Concepts**
*   **Frontend (Mobile)**: Legacy monolithic HTML/CSS/JavaScript, Capacitor, vanilla JS DOM manipulation.
*   **Frontend (Web)**: Next.js, React, TypeScript, Chart.js.
*   **Backend-as-a-Service (BaaS)**: Supabase (PostgreSQL database, Auth, RPC functions).
*   **CI/CD**: GitHub Actions for building the Android APK.
*   **Geocoding**: Nominatim & Overpass API for the polygon feature.
*   **Libraries**:  for Excel/CSV processing.

**key DB schema**
*   : Stores the main contact data synced from the QualiTool app. Key columns: ,  (JSONB containing an array of contact objects with fields like , , , , etc.).
*   : Stores manually set target values for projects. Key columns:  (project name), .

**changes in tech stack**
*   No fundamental changes, but the project now heavily relies on  for analytics and the  library for the unifier tool.

**All files of reference**
*   : The monolithic core of the mobile app. All bug fixes and feature logic for the QualiTool are here.
*   : The core of the admin dashboard, containing the primary data fetching and processing logic.
*   : Component displaying project-specific statistics. Heavily modified to add the forecast chart.
*   : Component for individual employee statistics. Modified to add new metrics.
*   : Central file for chart color definitions. Updated multiple times to meet user's contrast requirements.
*   : A new page created to host the address unifier tool.
*   : The source of truth for the QualiTool app's version number. Updated multiple times.

**Areas that need refactoring**
*   : This file is over 7,000 lines long and contains all HTML, CSS, and JS for the entire mobile app. It's extremely difficult to maintain. Any future work should prioritize breaking this file down into smaller, manageable modules. The reliance on  to manage scope is a clear sign of technical debt.
*   : This file has become a monolith for data processing on the admin dashboard. The  function is very large and complex. This logic should be extracted into custom hooks or utility functions to improve readability and testability.

**key api endpoints**
*   All backend interactions are with Supabase via its client library, not custom API endpoints. Key interactions include:
    *    / 
    *    / 
    *   
    *   

**Critical Info for New Agent**
*   The project consists of two very different codebases. Be mindful of which part you are working on.
*   The QualiTool () is extremely fragile due to its monolithic nature. Changes can have unintended side effects. Scope and timing issues are common.
*   The synchronization logic in QualiTool is the most critical and bug-prone part of the entire system. It has been patched multiple times. The current work is another patch. Be extremely careful when modifying , , or .
*   The Admin Dashboard's state is a mix of data fetched from Supabase and data derived on the client. Caching issues (especially with ) have occurred and should be considered when debugging data discrepancies.

**documents created in this job**
*   None.

**Last 10 User Messages and any pending user messages**
1.  **User**: Reports that the dashboard now works, but the sync in QualiTool seems to break after manually deleting all addresses. Asks the agent to investigate but not change anything yet. (PENDING)
2.  **Agent**: Analyzes the  function and the critical guard. Proposes adding a  flag to allow intentional deletion and a timeout for the sync lock.
3.  **User**: Agrees to the implementation but requests a full code review for other potential sync issues first. Asks not to create a new release yet. (PENDING)
4.  **Agent**: Performs a full analysis and identifies one other minor risk area (an unprotected  assignment during CSV import).
5.  **User**: Agrees to fix both issues, but reiterates not to create a release. (PENDING)
6.  **Agent**: Starts implementing the  flag.
7.  **Agent**: Continues implementation, modifying the critical guards.
8.  **Agent**: Continues, applying the change to the second guard function.
9.  **Agent**: Starts implementing the  timeout fix.
10. **User**: mach erstmal fertig, dann fork session (Finish up first, then fork the session). (IN PROGRESS)

**Project Health Check:**
*   **Broken**: The QualiTool sync logic is fragile and currently  of being fixed to handle the delete all contacts edge case without deadlocking.
*   **Mocked**: No mocked components.

**3rd Party Integrations**
*   **Supabase**: Primary BaaS for database (PostgreSQL), authentication, and RPC functions.
*   **Nominatim & Overpass API**: Used for geocoding within the polygon drawing feature in QualiTool.
*   **Chart.js**: Used for all charts and graphs in the Admin-Dashboard-Pro.
*   **SheetJS (xlsx)**: Used for parsing and creating Excel/CSV files in the Address Unifier tool.

**Testing status**
*   **Testing agent used after significant changes**: NO
*   **Troubleshoot agent used after agent stuck in loop**: YES, the troubleshoot agent was used to diagnose the sync deadlock issue in QualiTool.
*   **Test files created**: None.
*   **Known regressions**: The sync logic has repeatedly shown regressions or new failure modes after previous fixes.

**Credentials to test flow:**
*   Credentials are not explicitly mentioned, but the user is expected to have login access to the Admin Dashboard and be able to use the QualiTool app.

**What agent forgot to execute**
*   The agent was in the middle of implementing the  timeout fix when the user forked. The user's last instruction was to finish up, so the agent needs to complete and verify this last set of changes to the sync logic in .</analysis>
