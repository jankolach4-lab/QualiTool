name: Android APK (Capacitor)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'frontend/**'
      - '.github/workflows/build-android-apk.yml'

jobs:
  build-apk:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          yarn install --frozen-lockfile || yarn install
          yarn add --dev typescript@^5.6 || true
          # Ensure Capacitor core is available for CLI operations
          yarn add @capacitor/core@^6 -W || yarn add @capacitor/core@^6

      - name: Clear build cache (ensure fresh build)
        run: |
          rm -rf build node_modules/.cache
          echo "âœ“ Build cache cleared"

      - name: Build web assets
        run: |
          yarn build

      - name: Show Capacitor version
        run: npx cap --version || true

      - name: Add Android platform (idempotent)
        run: |
          npx cap add android || echo 'Android platform already present'

      - name: Generate Android icons
        run: npx @capacitor/assets generate --android || true

      - name: Verify built web assets
        run: |
          test -f build/qualitool/index.html
          test -f build/qualitool/login.html
          grep -qi "<!DOCTYPE html" build/qualitool/index.html || (echo "index.html marker not found" && exit 1)
          grep -q "Login zum Qualifizierungs" build/qualitool/login.html || (echo "login.html marker not found" && exit 1)
          
          # CRITICAL: Verify correct version is built
          EXPECTED_VERSION=$(node -p "require('./package.json').version")
          BUILT_VERSION=$(grep -oP "CURRENT_VERSION = '\K[^']+" build/qualitool/index.html || echo "NOT_FOUND")
          
          echo "ðŸ“¦ Expected version: $EXPECTED_VERSION"
          echo "ðŸ“¦ Built version: $BUILT_VERSION"
          
          if [ "$BUILT_VERSION" != "$EXPECTED_VERSION" ]; then
            echo "âŒ ERROR: Built version mismatch!"
            echo "   Expected: $EXPECTED_VERSION"
            echo "   Got: $BUILT_VERSION"
            exit 1
          fi
          
          echo "âœ… Version verification passed: $BUILT_VERSION"
          head -n 5 build/index.html || true

      - name: Copy/sync web assets to Android
        run: |
          npx cap sync android
          test -f android/app/src/main/assets/public/qualitool/login.html
          grep -q "Login zum Qualifizierungs" android/app/src/main/assets/public/qualitool/login.html || (echo "android assets missing login" && exit 1)
          grep -q "qualitool/index.html" android/app/src/main/assets/public/index.html || (echo "redirect to qualitool not present" && exit 1)
          
          # CRITICAL: Verify Android assets have correct version
          EXPECTED_VERSION=$(node -p "require('./package.json').version")
          ANDROID_VERSION=$(grep -oP "CURRENT_VERSION = '\K[^']+" android/app/src/main/assets/public/qualitool/index.html || echo "NOT_FOUND")
          
          echo "ðŸ“¦ Expected version: $EXPECTED_VERSION"
          echo "ðŸ“¦ Android assets version: $ANDROID_VERSION"
          
          if [ "$ANDROID_VERSION" != "$EXPECTED_VERSION" ]; then
            echo "âŒ ERROR: Android assets have wrong version!"
            echo "   Expected: $EXPECTED_VERSION"
            echo "   Got: $ANDROID_VERSION"
            echo "   This means cap sync failed to copy the correct files!"
            exit 1
          fi
          
          echo "âœ… Android assets verification passed: $ANDROID_VERSION"
          head -n 5 android/app/src/main/assets/public/index.html || true

      # Remove previous SaveAs injection step (we avoid native plugin for now)
      - name: Patch AndroidManifest for permissions (Storage + Location)
        run: |
          MANIFEST="android/app/src/main/AndroidManifest.xml"
          if [ -f "$MANIFEST" ]; then
            # Add legacy external storage for Android 10
            if ! grep -q "requestLegacyExternalStorage" "$MANIFEST"; then
              sed -i 's/<application /<application android:requestLegacyExternalStorage="true" /' "$MANIFEST"
            fi
            # Ensure legacy write permission for API 29
            if ! grep -q "WRITE_EXTERNAL_STORAGE" "$MANIFEST"; then
              sed -i '/<uses-permission android:name="android.permission.INTERNET" \/>/a \\n    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" android:maxSdkVersion="29" \/>' "$MANIFEST"
            fi
            # Add location permissions for map feature
            if ! grep -q "ACCESS_FINE_LOCATION" "$MANIFEST"; then
              sed -i '/<uses-permission android:name="android.permission.INTERNET" \/>/a \\n    <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" \/>\n    <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" \/>' "$MANIFEST"
            fi
            echo "AndroidManifest.xml patched successfully"
            echo "Permissions added: WRITE_EXTERNAL_STORAGE, ACCESS_FINE_LOCATION, ACCESS_COARSE_LOCATION"
          fi

      - name: Remove SaveAs injection step
        run: |
          echo 'Skipping SaveAs native plugin injection to stabilise build.'


      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Decode Release Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > android/app/release.keystore
          echo "âœ“ Keystore decoded and saved to android/app/release.keystore"
          ls -la android/app/release.keystore

      - name: Create keystore.properties
        run: |
          cd android
          cat > keystore.properties << EOF
          storeFile=release.keystore
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          EOF
          echo "âœ“ keystore.properties created"
          cat keystore.properties
          
          # Copy keystore to android/ root as well (some configs read from there)
          cp app/release.keystore release.keystore
          echo "âœ“ Keystore also copied to android/release.keystore"

      - name: Configure build.gradle for Release Signing AND Version
        run: |
          cd android/app
          
          # Get version info
          VERSION_NAME=$(node -p "require('../../package.json').version")
          VERSION_CODE=$(date +%Y%m%d%H%M)
          
          echo "ðŸ“¦ Configuring build.gradle with:"
          echo "   versionName: $VERSION_NAME"
          echo "   versionCode: $VERSION_CODE"
          
          # First, set the version (replace existing values)
          sed -i "s/versionCode [0-9]*/versionCode $VERSION_CODE/" build.gradle
          sed -i "s/versionName \"[^\"]*\"/versionName \"$VERSION_NAME\"/" build.gradle
          
          # Now add signing configuration using a temp file
          # Check if signingConfigs already exists
          if ! grep -q "signingConfigs {" build.gradle; then
            # Create the signing config block
            cat > signing_config.txt << 'SIGNINGEOF'
    signingConfigs {
        release {
            def keystorePropertiesFile = rootProject.file("keystore.properties")
            if (keystorePropertiesFile.exists()) {
                def keystoreProperties = new Properties()
                keystoreProperties.load(new FileInputStream(keystorePropertiesFile))
                storeFile file(keystoreProperties["storeFile"])
                storePassword keystoreProperties["storePassword"]
                keyAlias keystoreProperties["keyAlias"]
                keyPassword keystoreProperties["keyPassword"]
            }
        }
    }
SIGNINGEOF
            
            # Insert after 'android {' line
            sed -i '/android {/r signing_config.txt' build.gradle
            rm signing_config.txt
          fi
          
          # Add signingConfig to release buildType if not present
          if ! grep -q "signingConfig signingConfigs.release" build.gradle; then
            sed -i '/release {/a\            signingConfig signingConfigs.release' build.gradle
          fi
          
          echo "âœ“ build.gradle configured successfully"
          
          # Verify version was set
          echo "ðŸ“‹ Verification:"
          grep -E "versionCode|versionName" build.gradle || echo "âš  WARNING: Version not found!"
          grep -A2 "signingConfigs" build.gradle | head -5 || echo "âš  WARNING: Signing config not found!"

      - name: Grant execute permission for Gradle
        run: |
          cd android
          chmod +x ./gradlew

      - name: Clear Gradle build cache (ensure fresh APK)
        run: |
          cd android
          ./gradlew clean
          rm -rf app/build
          echo "âœ“ Gradle build cache cleared"

      - name: Build Release APK (Signed)
        run: |
          cd android
          ./gradlew assembleRelease
          echo "âœ“ Signed Release APK built successfully"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: qualitool-release-apk
          path: frontend/android/app/build/outputs/apk/release/app-release.apk
          if-no-files-found: error
          retention-days: 30

      - name: Get version from package.json
        id: get_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: $VERSION"

      - name: Check if release exists
        id: check_release
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          RELEASE_EXISTS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/v${VERSION}")
          
          if [ "$RELEASE_EXISTS" = "200" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Release v${VERSION} already exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âœ“ Release v${VERSION} does not exist yet"
          fi

      - name: Generate Changelog
        id: changelog
        if: steps.check_release.outputs.exists == 'false'
        run: |
          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LAST_TAG" ]; then
            # First release - use all commits
            COMMITS=$(git log --pretty=format:"- %s (%an)" --no-merges | head -20)
          else
            # Get commits since last tag
            COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%an)" --no-merges)
          fi
          
          # Create changelog
          cat > changelog.txt << 'EOF'
          ## ðŸŽ‰ Was ist neu?
          
          $COMMITS
          
          ## ðŸ“¥ Installation
          
          1. Laden Sie die APK-Datei herunter
          2. Ã–ffnen Sie die Datei auf Ihrem Android-GerÃ¤t
          3. BestÃ¤tigen Sie die Installation
          4. Alle Daten bleiben erhalten (bei Update)
          
          ## âš ï¸ Wichtig
          
          - Erste Installation: Erlauben Sie alle Berechtigungen (Standort, Speicher)
          - Update: Vorherige Version muss gleichen Signing-Key haben
          - Bei Problemen: Kontaktieren Sie den Support
          
          ---
          Â© 2024-2025 Janko Lach
          EOF
          
          # Replace $COMMITS placeholder
          sed -i "s|\$COMMITS|${COMMITS}|g" changelog.txt
          
          echo "âœ“ Changelog generated"
          cat changelog.txt

      - name: Create GitHub Release
        if: steps.check_release.outputs.exists == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          name: QualiTool v${{ steps.get_version.outputs.version }}
          body_path: frontend/changelog.txt
          files: frontend/android/app/build/outputs/apk/release/app-release.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        if: steps.check_release.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          echo "ðŸŽ‰ Release v${VERSION} created successfully!"
          echo "ðŸ“¦ APK uploaded to: https://github.com/${{ github.repository }}/releases/tag/v${VERSION}"
          echo "ðŸ”„ Users can now update via the app's Settings page"